<!DOCTYPE html>
<html>
<head>
    

    

    



    <meta charset="utf-8">
    
    
    
    
    <title>find2 | Cups</title>
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    
    <meta name="theme-color" content="#3F51B5">
    
    
    <meta name="keywords" content="Fabric,fabric-samples">
    <meta name="description" content="目录结构123456789101112.├── chaincode├── channel├── clilogging├── common├── gossip├── main.go├── main_test.go├── mocks├── node├── testdata└── version  main.go函数包12345678910111213141516package mainimport (">
<meta name="keywords" content="Fabric,fabric-samples">
<meta property="og:type" content="article">
<meta property="og:title" content="find2">
<meta property="og:url" content="http:&#x2F;&#x2F;cupswen.github.io&#x2F;2019&#x2F;11&#x2F;03&#x2F;2019&#x2F;find-2&#x2F;index.html">
<meta property="og:site_name" content="Cups">
<meta property="og:description" content="目录结构123456789101112.├── chaincode├── channel├── clilogging├── common├── gossip├── main.go├── main_test.go├── mocks├── node├── testdata└── version  main.go函数包12345678910111213141516package mainimport (">
<meta property="og:locale" content="en">
<meta property="og:updated_time" content="2019-11-03T08:40:26.000Z">
<meta name="twitter:card" content="summary">
    
    <link rel="shortcut icon" href="/img/brand.jpg">
    <link rel="stylesheet" href="//unpkg.com/hexo-theme-material-indigo@latest/css/style.css">
    <script>window.lazyScripts=[]</script>

    <!-- custom head -->
    

</head>

<body>
    <div id="loading" class="active"></div>

    <aside id="menu" class="hide" >
  <div class="inner flex-row-vertical">
    <a href="javascript:;" class="header-icon waves-effect waves-circle waves-light" id="menu-off">
        <i class="icon icon-lg icon-close"></i>
    </a>
    <div class="brand-wrap" style="background-image:url(/img/brand.jpg)">
      <div class="brand">
        <a href="/" class="avatar waves-effect waves-circle waves-light">
          <img src="/img/the_Huanghe_River.png">
        </a>
        <hgroup class="introduce">
          <h5 class="nickname">CupsWen</h5>
          <a href="mailto:1191567189@qq.com" target="_blank" rel="noopener" title="1191567189@qq.com" class="mail">1191567189@qq.com</a>
        </hgroup>
      </div>
    </div>
    <div class="scroll-wrap flex-col">
      <ul class="nav">
        
            <li class="waves-block waves-effect">
              <a href="/index.html"  >
                <i class="icon icon-lg icon-home"></i>
                主页
              </a>
            </li>
        
            <li class="waves-block waves-effect">
              <a href="/archives"  >
                <i class="icon icon-lg icon-archives"></i>
                Archives
              </a>
            </li>
        
            <li class="waves-block waves-effect">
              <a href="/tags"  >
                <i class="icon icon-lg icon-tags"></i>
                Tags
              </a>
            </li>
        
            <li class="waves-block waves-effect">
              <a href="/categories"  >
                <i class="icon icon-lg icon-th-list"></i>
                Categories
              </a>
            </li>
        
            <li class="waves-block waves-effect">
              <a href="https://github.com/CupsWen" target="_blank" >
                <i class="icon icon-lg icon-github"></i>
                Github
              </a>
            </li>
        
            <li class="waves-block waves-effect">
              <a href="https://cupswen.github.io/hyperlink"  >
                <i class="icon icon-lg icon-link"></i>
                Link
              </a>
            </li>
        
      </ul>
    </div>
  </div>
</aside>

    <main id="main">
        <header class="top-header" id="header">
    <div class="flex-row">
        <a href="javascript:;" class="header-icon waves-effect waves-circle waves-light on" id="menu-toggle">
          <i class="icon icon-lg icon-navicon"></i>
        </a>
        <div class="flex-col header-title ellipsis">find2</div>
        
        <div class="search-wrap" id="search-wrap">
            <a href="javascript:;" class="header-icon waves-effect waves-circle waves-light" id="back">
                <i class="icon icon-lg icon-chevron-left"></i>
            </a>
            <input type="text" id="key" class="search-input" autocomplete="off" placeholder="Search">
            <a href="javascript:;" class="header-icon waves-effect waves-circle waves-light" id="search">
                <i class="icon icon-lg icon-search"></i>
            </a>
        </div>
        
        
        <a href="javascript:;" class="header-icon waves-effect waves-circle waves-light" id="menuShare">
            <i class="icon icon-lg icon-share-alt"></i>
        </a>
        
    </div>
</header>
<header class="content-header post-header">

    <div class="container fade-scale">
        <h1 class="title">find2</h1>
        <h5 class="subtitle">
            
                <time datetime="2019-11-03T08:40:00.000Z" itemprop="datePublished" class="page-time">
  2019-11-03
</time>


	<ul class="article-category-list"><li class="article-category-list-item"><a class="article-category-list-link" href="/categories/Fabric/">Fabric</a></li></ul>

            
        </h5>
    </div>

    


</header>


<div class="container body-wrap">
    
    <aside class="post-widget">
        <nav class="post-toc-wrap post-toc-shrink" id="post-toc">
            <h4>TOC</h4>
            <ol class="post-toc"><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#目录结构"><span class="post-toc-text">目录结构</span></a></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#main-go"><span class="post-toc-text">main.go</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#函数包"><span class="post-toc-text">函数包</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#全局变量"><span class="post-toc-text">全局变量</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#主函数"><span class="post-toc-text">主函数</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#Execute"><span class="post-toc-text">Execute()</span></a></li><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#ExecuteC"><span class="post-toc-text">ExecuteC()</span></a></li></ol></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#version-Cmd"><span class="post-toc-text">version.Cmd()</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#效果"><span class="post-toc-text">效果</span></a></li><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#代码"><span class="post-toc-text">代码</span></a></li></ol></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#node-Cmd"><span class="post-toc-text">node.Cmd()</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#效果-1"><span class="post-toc-text">效果</span></a></li><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#代码-1"><span class="post-toc-text">代码</span></a></li><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#startCmd"><span class="post-toc-text">startCmd()</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-5"><a class="post-toc-link" href="#效果-2"><span class="post-toc-text">效果</span></a></li><li class="post-toc-item post-toc-level-5"><a class="post-toc-link" href="#代码-2"><span class="post-toc-text">代码</span></a></li></ol></li><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#statusCmd"><span class="post-toc-text">statusCmd()</span></a></li><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#resetCmd"><span class="post-toc-text">resetCmd()</span></a></li><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#rollbackCmd"><span class="post-toc-text">rollbackCmd()</span></a></li></ol></li></ol></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#chaincode-Cmd-nil"><span class="post-toc-text">chaincode.Cmd(nil)</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#效果-3"><span class="post-toc-text">效果</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#代码-3"><span class="post-toc-text">代码</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#installCmd"><span class="post-toc-text">installCmd()</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#chaincodeInstall"><span class="post-toc-text">chaincodeInstall()</span></a></li><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#InitCmdFactory"><span class="post-toc-text">InitCmdFactory()</span></a></li><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#install"><span class="post-toc-text">install()</span></a></li><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#EndorserClient"><span class="post-toc-text">EndorserClient</span></a></li></ol></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#invokeCmd"><span class="post-toc-text">invokeCmd()</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#效果-4"><span class="post-toc-text">效果</span></a></li><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#代码-4"><span class="post-toc-text">代码</span></a></li><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#chaincodeInvokeOrQuery"><span class="post-toc-text">chaincodeInvokeOrQuery()</span></a></li><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#ChaincodeInvokeOrQuery"><span class="post-toc-text">ChaincodeInvokeOrQuery()</span></a></li></ol></li></ol></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#common函数库"><span class="post-toc-text">common函数库</span></a></li></ol>
        </nav>
    </aside>


<article id="post-2019/find-2"
  class="post-article article-type-post fade" itemprop="blogPost">

    <div class="post-card">
        <h1 class="post-card-title">find2</h1>
        <div class="post-meta">
            <time class="post-time" title="2019-11-03 16:40:00" datetime="2019-11-03T08:40:00.000Z"  itemprop="datePublished">2019-11-03</time>

            
	<ul class="article-category-list"><li class="article-category-list-item"><a class="article-category-list-link" href="/categories/Fabric/">Fabric</a></li></ul>



            
<span id="busuanzi_container_page_pv" title="文章总阅读量" style='display:none'>
    <i class="icon icon-eye icon-pr"></i><span id="busuanzi_value_page_pv"></span>
</span>


        </div>
        <div class="post-content" id="post-content" itemprop="postContent">
            <h2 id="目录结构"><a href="#目录结构" class="headerlink" title="目录结构"></a>目录结构</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">.</span><br><span class="line">├── chaincode</span><br><span class="line">├── channel</span><br><span class="line">├── clilogging</span><br><span class="line">├── common</span><br><span class="line">├── gossip</span><br><span class="line">├── main.go</span><br><span class="line">├── main_test.go</span><br><span class="line">├── mocks</span><br><span class="line">├── node</span><br><span class="line">├── testdata</span><br><span class="line">└── version</span><br></pre></td></tr></table></figure>

<h2 id="main-go"><a href="#main-go" class="headerlink" title="main.go"></a>main.go</h2><h3 id="函数包"><a href="#函数包" class="headerlink" title="函数包"></a>函数包</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">	_ <span class="string">"net/http/pprof"</span></span><br><span class="line">	<span class="string">"os"</span></span><br><span class="line">	<span class="string">"strings"</span></span><br><span class="line"></span><br><span class="line">	<span class="string">"github.com/hyperledger/fabric/peer/chaincode"</span></span><br><span class="line">	<span class="string">"github.com/hyperledger/fabric/peer/channel"</span></span><br><span class="line">	<span class="string">"github.com/hyperledger/fabric/peer/clilogging"</span></span><br><span class="line">	<span class="string">"github.com/hyperledger/fabric/peer/common"</span></span><br><span class="line">	<span class="string">"github.com/hyperledger/fabric/peer/node"</span></span><br><span class="line">	<span class="string">"github.com/hyperledger/fabric/peer/version"</span></span><br><span class="line">	<span class="string">"github.com/spf13/cobra"</span>					<span class="comment">// golang命令行库Cobra</span></span><br><span class="line">	<span class="string">"github.com/spf13/viper"</span>					<span class="comment">// Go应用程序的完整配置解决方案</span></span><br><span class="line">)</span><br></pre></td></tr></table></figure>

<blockquote>
<p>详细内容请参考：</p>
<p><a href="https://www.jianshu.com/p/7abe7cff5384" target="_blank" rel="noopener">https://www.jianshu.com/p/7abe7cff5384</a></p>
<p><a href="https://blog.csdn.net/studyhard232/article/details/86499317" target="_blank" rel="noopener">https://blog.csdn.net/studyhard232/article/details/86499317</a></p>
</blockquote>
<h3 id="全局变量"><a href="#全局变量" class="headerlink" title="全局变量"></a>全局变量</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// The main command describes the service and</span></span><br><span class="line"><span class="comment">// defaults to printing the help message.</span></span><br><span class="line"><span class="keyword">var</span> mainCmd = &amp;cobra.Command&#123;Use: <span class="string">"peer"</span>&#125;</span><br></pre></td></tr></table></figure>

<h3 id="主函数"><a href="#主函数" class="headerlink" title="主函数"></a>主函数</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">    <span class="comment">// For environment variables.</span></span><br><span class="line">    <span class="comment">// 配置环境变量</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">// common.CmdRoot</span></span><br><span class="line">    <span class="comment">// const CmdRoot = "core"</span></span><br><span class="line">    <span class="comment">// Viper提供了一种机制来尝试确保ENV变量是唯一的。</span></span><br><span class="line">    <span class="comment">// 通过使用SetEnvPrefix，您可以告诉Viper在读取环境变量时使用前缀。</span></span><br><span class="line">    <span class="comment">// 使用BindEnv并AutomaticEnv会使用这个前缀。</span></span><br><span class="line">	viper.SetEnvPrefix(common.CmdRoot)</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// AutomaticEnv是强大的帮助程序，尤其是与SetEnvPrefix结合使用时。 </span></span><br><span class="line">    <span class="comment">// 调用时，Viper会在发出viper.Get请求时随时检查环境变量。 </span></span><br><span class="line">    <span class="comment">// 它将应用以下规则。 </span></span><br><span class="line">    <span class="comment">// 它将检查环境变量，该环境变量的名称与键的大小写匹配，且键设置为大写并带有EnvPrefix（如果已设置）。</span></span><br><span class="line">	viper.AutomaticEnv()</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 替换规则</span></span><br><span class="line">	replacer := strings.NewReplacer(<span class="string">"."</span>, <span class="string">"_"</span>)</span><br><span class="line">	</span><br><span class="line">    <span class="comment">// 替换</span></span><br><span class="line">    viper.SetEnvKeyReplacer(replacer)</span><br><span class="line"></span><br><span class="line">	<span class="comment">// Define command-line flags that are valid for all peer commands and subcommands.</span></span><br><span class="line">    <span class="comment">// 定义对所有peer和子命令均有效的命令行标志。</span></span><br><span class="line">	mainFlags := mainCmd.PersistentFlags()</span><br><span class="line">	</span><br><span class="line">    <span class="comment">// String:定义具有指定名称，默认值和用法字符串的字符串标志。</span></span><br><span class="line">    <span class="comment">// 返回值是存储标志值的字符串变量的地址。</span></span><br><span class="line">	mainFlags.String(<span class="string">"logging-level"</span>, <span class="string">""</span>, <span class="string">"Legacy logging level flag"</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// Lookup:查找返回命名标志的Flag结构，如果不存在则返回nil。</span></span><br><span class="line">    <span class="comment">// BindPFlag:将特定键绑定到标志（viper使用）</span></span><br><span class="line">    viper.BindPFlag(<span class="string">"logging_level"</span>, mainFlags.Lookup(<span class="string">"logging-level"</span>))</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// MarkHidden在程序中将标志设置为“隐藏”。 它会继续运行，但不会显示在帮助或使用情况消息中。</span></span><br><span class="line">	mainFlags.MarkHidden(<span class="string">"logging-level"</span>)</span><br><span class="line">	</span><br><span class="line">    <span class="comment">// AddCommand:将一个或多个命令添加到此父命令。</span></span><br><span class="line">	mainCmd.AddCommand(version.Cmd())</span><br><span class="line">	mainCmd.AddCommand(node.Cmd())</span><br><span class="line">	mainCmd.AddCommand(chaincode.Cmd(<span class="literal">nil</span>))</span><br><span class="line">	mainCmd.AddCommand(clilogging.Cmd(<span class="literal">nil</span>))</span><br><span class="line">	mainCmd.AddCommand(channel.Cmd(<span class="literal">nil</span>))</span><br><span class="line"></span><br><span class="line">	<span class="comment">// On failure Cobra prints the usage message and error string, </span></span><br><span class="line">    <span class="comment">// so we only need to exit with a non-0 status</span></span><br><span class="line">    <span class="comment">//发生故障时，Cobra会打印使用情况消息和错误字符串，因此我们仅需要以非0状态退出</span></span><br><span class="line">	<span class="keyword">if</span> mainCmd.Execute() != <span class="literal">nil</span> &#123;</span><br><span class="line">		os.Exit(<span class="number">1</span>)</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="Execute"><a href="#Execute" class="headerlink" title="Execute()"></a>Execute()</h4><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Execute uses the args (os.Args[1:] by default)</span></span><br><span class="line"><span class="comment">// and run through the command tree finding appropriate matches</span></span><br><span class="line"><span class="comment">// for commands and then corresponding flags.</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(c *Command)</span> <span class="title">Execute</span><span class="params">()</span> <span class="title">error</span></span> &#123;</span><br><span class="line">	_, err := c.ExecuteC()</span><br><span class="line">	<span class="keyword">return</span> err</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="ExecuteC"><a href="#ExecuteC" class="headerlink" title="ExecuteC()"></a>ExecuteC()</h4><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ExecuteC executes the command.</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(c *Command)</span> <span class="title">ExecuteC</span><span class="params">()</span> <span class="params">(cmd *Command, err error)</span></span> &#123;</span><br><span class="line">	<span class="comment">// Regardless of what command execute is called on, run on Root only</span></span><br><span class="line">	<span class="keyword">if</span> c.HasParent() &#123;</span><br><span class="line">		<span class="keyword">return</span> c.Root().ExecuteC()</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// windows hook</span></span><br><span class="line">	<span class="keyword">if</span> preExecHookFn != <span class="literal">nil</span> &#123;</span><br><span class="line">		preExecHookFn(c)</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// initialize help as the last point possible to allow for user</span></span><br><span class="line">	<span class="comment">// overriding</span></span><br><span class="line">	c.InitDefaultHelpCmd()</span><br><span class="line"></span><br><span class="line">	<span class="keyword">var</span> args []<span class="keyword">string</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">// Workaround FAIL with "go test -v" or "cobra.test -test.v", see #155</span></span><br><span class="line">	<span class="keyword">if</span> c.args == <span class="literal">nil</span> &amp;&amp; filepath.Base(os.Args[<span class="number">0</span>]) != <span class="string">"cobra.test"</span> &#123;</span><br><span class="line">		args = os.Args[<span class="number">1</span>:]</span><br><span class="line">	&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">		args = c.args</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">var</span> flags []<span class="keyword">string</span></span><br><span class="line">	<span class="keyword">if</span> c.TraverseChildren &#123;</span><br><span class="line">		cmd, flags, err = c.Traverse(args)</span><br><span class="line">	&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">		cmd, flags, err = c.Find(args)</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="comment">// If found parse to a subcommand and then failed, talk about the subcommand</span></span><br><span class="line">		<span class="keyword">if</span> cmd != <span class="literal">nil</span> &#123;</span><br><span class="line">			c = cmd</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">if</span> !c.SilenceErrors &#123;</span><br><span class="line">			c.Println(<span class="string">"Error:"</span>, err.Error())</span><br><span class="line">			c.Printf(<span class="string">"Run '%v --help' for usage.\n"</span>, c.CommandPath())</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">return</span> c, err</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	cmd.commandCalledAs.called = <span class="literal">true</span></span><br><span class="line">	<span class="keyword">if</span> cmd.commandCalledAs.name == <span class="string">""</span> &#123;</span><br><span class="line">		cmd.commandCalledAs.name = cmd.Name()</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	err = cmd.execute(flags)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="comment">// Always show help if requested, even if SilenceErrors is in</span></span><br><span class="line">		<span class="comment">// effect</span></span><br><span class="line">		<span class="keyword">if</span> err == flag.ErrHelp &#123;</span><br><span class="line">			cmd.HelpFunc()(cmd, args)</span><br><span class="line">			<span class="keyword">return</span> cmd, <span class="literal">nil</span></span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="comment">// If root command has SilentErrors flagged,</span></span><br><span class="line">		<span class="comment">// all subcommands should respect it</span></span><br><span class="line">		<span class="keyword">if</span> !cmd.SilenceErrors &amp;&amp; !c.SilenceErrors &#123;</span><br><span class="line">			c.Println(<span class="string">"Error:"</span>, err.Error())</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="comment">// If root command has SilentUsage flagged,</span></span><br><span class="line">		<span class="comment">// all subcommands should respect it</span></span><br><span class="line">		<span class="keyword">if</span> !cmd.SilenceUsage &amp;&amp; !c.SilenceUsage &#123;</span><br><span class="line">			c.Println(cmd.UsageString())</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> cmd, err</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="version-Cmd"><a href="#version-Cmd" class="headerlink" title="version.Cmd()"></a>version.Cmd()</h3><h4 id="效果"><a href="#效果" class="headerlink" title="效果"></a>效果</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">cups@ubuntu:~/go/src/github.com/hyperledger/fabric/peer$ peer version</span><br><span class="line">peer:</span><br><span class="line"> Version: 1.4.0</span><br><span class="line"> Commit SHA: d700b43</span><br><span class="line"> Go version: go1.11.1</span><br><span class="line"> OS/Arch: linux/amd64</span><br><span class="line"> Chaincode:</span><br><span class="line">  Base Image Version: 0.4.14</span><br><span class="line">  Base Docker Namespace: hyperledger</span><br><span class="line">  Base Docker Label: org.hyperledger.fabric</span><br><span class="line">  Docker Namespace: hyperledger</span><br><span class="line"></span><br><span class="line">cups@ubuntu:~/go/src/github.com/hyperledger/fabric/peer$</span><br></pre></td></tr></table></figure>

<h4 id="代码"><a href="#代码" class="headerlink" title="代码"></a>代码</h4><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Cmd returns the Cobra Command for Version</span></span><br><span class="line"><span class="comment">// Cmd返回cobra命令的版本</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">Cmd</span><span class="params">()</span> *<span class="title">cobra</span>.<span class="title">Command</span></span> &#123;</span><br><span class="line">	<span class="keyword">return</span> cobraCommand</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> cobraCommand = &amp;cobra.Command&#123;</span><br><span class="line">	Use:   <span class="string">"version"</span>,</span><br><span class="line">	Short: <span class="string">"Print fabric peer version."</span>,</span><br><span class="line">	Long:  <span class="string">`Print current version of the fabric peer server.`</span>,</span><br><span class="line">	RunE: <span class="function"><span class="keyword">func</span><span class="params">(cmd *cobra.Command, args []<span class="keyword">string</span>)</span> <span class="title">error</span></span> &#123;</span><br><span class="line">		<span class="keyword">if</span> <span class="built_in">len</span>(args) != <span class="number">0</span> &#123;</span><br><span class="line">			<span class="keyword">return</span> fmt.Errorf(<span class="string">"trailing args detected"</span>)</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="comment">// Parsing of the command line is done so silence cmd usage</span></span><br><span class="line">		cmd.SilenceUsage = <span class="literal">true</span></span><br><span class="line">		fmt.Print(GetInfo())</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">	&#125;,</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="node-Cmd"><a href="#node-Cmd" class="headerlink" title="node.Cmd()"></a>node.Cmd()</h3><h4 id="效果-1"><a href="#效果-1" class="headerlink" title="效果"></a>效果</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">cups@ubuntu:~/go/src/github.com/hyperledger/fabric/peer$ peer node</span><br><span class="line">Operate a peer node: start|status.</span><br><span class="line"></span><br><span class="line">Usage:</span><br><span class="line">  peer node [command]</span><br><span class="line"></span><br><span class="line">Available Commands:</span><br><span class="line">  start       Starts the node.</span><br><span class="line">  status      Returns status of the node.</span><br><span class="line"></span><br><span class="line">Flags:</span><br><span class="line">  -h, --help   help for node</span><br><span class="line"></span><br><span class="line">Use "peer node [command] --help" for more information about a command.</span><br><span class="line">cups@ubuntu:~/go/src/github.com/hyperledger/fabric/peer$</span><br></pre></td></tr></table></figure>

<h4 id="代码-1"><a href="#代码-1" class="headerlink" title="代码"></a>代码</h4><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> (</span><br><span class="line">	nodeFuncName = <span class="string">"node"</span></span><br><span class="line">	nodeCmdDes   = <span class="string">"Operate a peer node: start|status|reset|rollback."</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> logger = flogging.MustGetLogger(<span class="string">"nodeCmd"</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">// Cmd returns the cobra command for Node</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">Cmd</span><span class="params">()</span> *<span class="title">cobra</span>.<span class="title">Command</span></span> &#123;</span><br><span class="line">	nodeCmd.AddCommand(startCmd())</span><br><span class="line">	nodeCmd.AddCommand(statusCmd())</span><br><span class="line">	nodeCmd.AddCommand(resetCmd())</span><br><span class="line">	nodeCmd.AddCommand(rollbackCmd())</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> nodeCmd</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> nodeCmd = &amp;cobra.Command&#123;</span><br><span class="line">	Use:              nodeFuncName,</span><br><span class="line">	Short:            fmt.Sprint(nodeCmdDes),</span><br><span class="line">	Long:             fmt.Sprint(nodeCmdDes),</span><br><span class="line">	PersistentPreRun: common.InitCmd,</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="startCmd"><a href="#startCmd" class="headerlink" title="startCmd()"></a>startCmd()</h4><h5 id="效果-2"><a href="#效果-2" class="headerlink" title="效果"></a>效果</h5><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">cups@ubuntu:~/go/src/github.com/hyperledger/fabric/peer$ peer node start</span><br><span class="line">2019-11-02 22:58:56.241 PDT [main] InitCmd -&gt; ERRO 001 Fatal error when initializing core config : Could not find config file. Please make sure that FABRIC_CFG_PATH is set to a path which contains core.yaml</span><br><span class="line">cups@ubuntu:~/go/src/github.com/hyperledger/fabric/peer$</span><br></pre></td></tr></table></figure>

<h5 id="代码-2"><a href="#代码-2" class="headerlink" title="代码"></a>代码</h5><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">startCmd</span><span class="params">()</span> *<span class="title">cobra</span>.<span class="title">Command</span></span> &#123;</span><br><span class="line">	<span class="comment">// Set the flags on the node start command.</span></span><br><span class="line">	flags := nodeStartCmd.Flags()</span><br><span class="line">	flags.BoolVarP(&amp;chaincodeDevMode, <span class="string">"peer-chaincodedev"</span>, <span class="string">""</span>, <span class="literal">false</span>,</span><br><span class="line">		<span class="string">"Whether peer in chaincode development mode"</span>)</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> nodeStartCmd</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> nodeStartCmd = &amp;cobra.Command&#123;</span><br><span class="line">	Use:   <span class="string">"start"</span>,</span><br><span class="line">	Short: <span class="string">"Starts the node."</span>,</span><br><span class="line">	Long:  <span class="string">`Starts a node that interacts with the network.`</span>,</span><br><span class="line">	RunE: <span class="function"><span class="keyword">func</span><span class="params">(cmd *cobra.Command, args []<span class="keyword">string</span>)</span> <span class="title">error</span></span> &#123;</span><br><span class="line">		<span class="keyword">if</span> <span class="built_in">len</span>(args) != <span class="number">0</span> &#123;</span><br><span class="line">			<span class="keyword">return</span> fmt.Errorf(<span class="string">"trailing args detected"</span>)</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="comment">// Parsing of the command line is done so silence cmd usage</span></span><br><span class="line">		cmd.SilenceUsage = <span class="literal">true</span></span><br><span class="line">        <span class="comment">// 暂且认为,读配置文件启动node(太多了)</span></span><br><span class="line">		<span class="keyword">return</span> serve(args)</span><br><span class="line">	&#125;,</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="statusCmd"><a href="#statusCmd" class="headerlink" title="statusCmd()"></a>statusCmd()</h4><h4 id="resetCmd"><a href="#resetCmd" class="headerlink" title="resetCmd()"></a>resetCmd()</h4><h4 id="rollbackCmd"><a href="#rollbackCmd" class="headerlink" title="rollbackCmd()"></a>rollbackCmd()</h4><h2 id="chaincode-Cmd-nil"><a href="#chaincode-Cmd-nil" class="headerlink" title="chaincode.Cmd(nil)"></a>chaincode.Cmd(nil)</h2><h3 id="效果-3"><a href="#效果-3" class="headerlink" title="效果"></a>效果</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">cups@ubuntu:~/go/src/github.com/hyperledger/fabric/peer$ peer chaincode</span><br><span class="line">Operate a chaincode: install|instantiate|invoke|package|query|signpackage|upgrade|list.</span><br><span class="line"></span><br><span class="line">Usage:</span><br><span class="line">  peer chaincode [command]</span><br><span class="line"></span><br><span class="line">Available Commands:</span><br><span class="line">  install     Package the specified chaincode into a deployment spec and save it on the peer's path.</span><br><span class="line">  instantiate Deploy the specified chaincode to the network.</span><br><span class="line">  invoke      Invoke the specified chaincode.</span><br><span class="line">  list        Get the instantiated chaincodes on a channel or installed chaincodes on a peer.</span><br><span class="line">  package     Package the specified chaincode into a deployment spec.</span><br><span class="line">  query       Query using the specified chaincode.</span><br><span class="line">  signpackage Sign the specified chaincode package</span><br><span class="line">  upgrade     Upgrade chaincode.</span><br><span class="line"></span><br><span class="line">Flags:</span><br><span class="line">      --cafile string                       Path to file containing PEM-encoded trusted certificate(s) for the ordering endpoint</span><br><span class="line">      --certfile string                     Path to file containing PEM-encoded X509 public key to use for mutual TLS communication with the orderer endpoint</span><br><span class="line">      --clientauth                          Use mutual TLS when communicating with the orderer endpoint</span><br><span class="line">      --connTimeout duration                Timeout for client to connect (default 3s)</span><br><span class="line">  -h, --help                                help for chaincode</span><br><span class="line">      --keyfile string                      Path to file containing PEM-encoded private key to use for mutual TLS communication with the orderer endpoint</span><br><span class="line">  -o, --orderer string                      Ordering service endpoint</span><br><span class="line">      --ordererTLSHostnameOverride string   The hostname override to use when validating the TLS connection to the orderer.</span><br><span class="line">      --tls                                 Use TLS when communicating with the orderer endpoint</span><br><span class="line">      --transient string                    Transient map of arguments in JSON encoding</span><br><span class="line"></span><br><span class="line">Use "peer chaincode [command] --help" for more information about a command.</span><br><span class="line">cups@ubuntu:~/go/src/github.com/hyperledger/fabric/peer$</span><br></pre></td></tr></table></figure>

<h3 id="代码-3"><a href="#代码-3" class="headerlink" title="代码"></a>代码</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> (</span><br><span class="line">	chainFuncName = <span class="string">"chaincode"</span></span><br><span class="line">	chainCmdDes   = <span class="string">"Operate a chaincode: install|instantiate|invoke|package|query|signpackage|upgrade|list."</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">Cmd</span><span class="params">(cf *ChaincodeCmdFactory)</span> *<span class="title">cobra</span>.<span class="title">Command</span></span> &#123;</span><br><span class="line">	addFlags(chaincodeCmd)</span><br><span class="line"></span><br><span class="line">	chaincodeCmd.AddCommand(installCmd(cf))</span><br><span class="line">	chaincodeCmd.AddCommand(instantiateCmd(cf))</span><br><span class="line">	chaincodeCmd.AddCommand(invokeCmd(cf))</span><br><span class="line">	chaincodeCmd.AddCommand(packageCmd(cf, <span class="literal">nil</span>))</span><br><span class="line">	chaincodeCmd.AddCommand(queryCmd(cf))</span><br><span class="line">	chaincodeCmd.AddCommand(signpackageCmd(cf))</span><br><span class="line">	chaincodeCmd.AddCommand(upgradeCmd(cf))</span><br><span class="line">	chaincodeCmd.AddCommand(listCmd(cf))</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> chaincodeCmd</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> chaincodeCmd = &amp;cobra.Command&#123;</span><br><span class="line">	Use:   chainFuncName,</span><br><span class="line">	Short: fmt.Sprint(chainCmdDes),</span><br><span class="line">	Long:  fmt.Sprint(chainCmdDes),</span><br><span class="line">    <span class="comment">// PersistentPreRun</span></span><br><span class="line">	<span class="comment">// PreRun</span></span><br><span class="line">	<span class="comment">// Run</span></span><br><span class="line">	<span class="comment">// PostRun</span></span><br><span class="line">	<span class="comment">// PersistentPostRun</span></span><br><span class="line">    <span class="comment">// Persistent*Run方法会被子命令继承，如果它们自己没有定义的话。</span></span><br><span class="line">	PersistentPreRun: <span class="function"><span class="keyword">func</span><span class="params">(cmd *cobra.Command, args []<span class="keyword">string</span>)</span></span> &#123;</span><br><span class="line">		common.InitCmd(cmd, args)</span><br><span class="line">		common.SetOrdererEnv(cmd, args)</span><br><span class="line">	&#125;,</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="installCmd"><a href="#installCmd" class="headerlink" title="installCmd()"></a>installCmd()</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> chaincodeInstallCmd *cobra.Command</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> installCmdName = <span class="string">"install"</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> installDesc = <span class="string">"Package the specified chaincode into a deployment spec and save it on the peer's path."</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// installCmd returns the cobra command for Chaincode Deploy</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">installCmd</span><span class="params">(cf *ChaincodeCmdFactory)</span> *<span class="title">cobra</span>.<span class="title">Command</span></span> &#123;</span><br><span class="line">	chaincodeInstallCmd = &amp;cobra.Command&#123;</span><br><span class="line">		Use:       <span class="string">"install"</span>,</span><br><span class="line">		Short:     fmt.Sprint(installDesc),</span><br><span class="line">		Long:      fmt.Sprint(installDesc),</span><br><span class="line">		ValidArgs: []<span class="keyword">string</span>&#123;<span class="string">"1"</span>&#125;,</span><br><span class="line">		RunE: <span class="function"><span class="keyword">func</span><span class="params">(cmd *cobra.Command, args []<span class="keyword">string</span>)</span> <span class="title">error</span></span> &#123;</span><br><span class="line">			<span class="keyword">var</span> ccpackfile <span class="keyword">string</span></span><br><span class="line">			<span class="keyword">if</span> <span class="built_in">len</span>(args) &gt; <span class="number">0</span> &#123;</span><br><span class="line">				ccpackfile = args[<span class="number">0</span>]</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">return</span> chaincodeInstall(cmd, ccpackfile, cf)</span><br><span class="line">		&#125;,</span><br><span class="line">	&#125;</span><br><span class="line">	flagList := []<span class="keyword">string</span>&#123;</span><br><span class="line">		<span class="string">"lang"</span>,</span><br><span class="line">		<span class="string">"ctor"</span>,</span><br><span class="line">		<span class="string">"path"</span>,</span><br><span class="line">		<span class="string">"name"</span>,</span><br><span class="line">		<span class="string">"version"</span>,</span><br><span class="line">		<span class="string">"peerAddresses"</span>,</span><br><span class="line">		<span class="string">"tlsRootCertFiles"</span>,</span><br><span class="line">		<span class="string">"connectionProfile"</span>,</span><br><span class="line">	&#125;</span><br><span class="line">	attachFlags(chaincodeInstallCmd, flagList)</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> chaincodeInstallCmd</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="chaincodeInstall"><a href="#chaincodeInstall" class="headerlink" title="chaincodeInstall()"></a>chaincodeInstall()</h4><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// peer chaincode install -p chaincodedev/chaincode/chaincode_example02/go -n mycc -v 0</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// chaincodeInstall installs the chaincode. If remoteinstall, does it via a lscc call</span></span><br><span class="line"><span class="comment">// chaincodeInstall安装链码。 如果是remoteinstall，则通过lscc调用进行</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">chaincodeInstall</span><span class="params">(cmd *cobra.Command, ccpackfile <span class="keyword">string</span>, cf *ChaincodeCmdFactory)</span> <span class="title">error</span></span> &#123;</span><br><span class="line">	<span class="comment">// Parsing of the command line is done so silence cmd usage</span></span><br><span class="line">    <span class="comment">// 命令行解析完成后，使cmd使用静音</span></span><br><span class="line">	cmd.SilenceUsage = <span class="literal">true</span></span><br><span class="line"></span><br><span class="line">	<span class="keyword">var</span> err error</span><br><span class="line">	<span class="keyword">if</span> cf == <span class="literal">nil</span> &#123;</span><br><span class="line">		cf, err = InitCmdFactory(cmd.Name(), <span class="literal">true</span>, <span class="literal">false</span>)</span><br><span class="line">		<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">			<span class="keyword">return</span> err</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">var</span> ccpackmsg proto.Message</span><br><span class="line">	<span class="keyword">if</span> ccpackfile == <span class="string">""</span> &#123;</span><br><span class="line">		<span class="keyword">if</span> chaincodePath == common.UndefinedParamValue || chaincodeVersion == common.UndefinedParamValue || chaincodeName == common.UndefinedParamValue &#123;</span><br><span class="line">			<span class="keyword">return</span> fmt.Errorf(<span class="string">"Must supply value for %s name, path and version parameters."</span>, chainFuncName)</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="comment">//generate a raw ChaincodeDeploymentSpec</span></span><br><span class="line">        <span class="comment">// 生成原始的ChaincodeDeploymentSpec</span></span><br><span class="line">		ccpackmsg, err = genChaincodeDeploymentSpec(cmd, chaincodeName, chaincodeVersion)</span><br><span class="line">		<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">			<span class="keyword">return</span> err</span><br><span class="line">		&#125;</span><br><span class="line">	&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">		<span class="comment">//read in a package generated by the "package" sub-command (and perhaps signed</span></span><br><span class="line">		<span class="comment">//by multiple owners with the "signpackage" sub-command)</span></span><br><span class="line">        <span class="comment">// 读入由“ package”子命令生成的软件包（并可能由多个所有者使用"signpackage"子命令签名）</span></span><br><span class="line">		<span class="keyword">var</span> cds *pb.ChaincodeDeploymentSpec</span><br><span class="line">		ccpackmsg, cds, err = getPackageFromFile(ccpackfile)</span><br><span class="line"></span><br><span class="line">		<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">			<span class="keyword">return</span> err</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="comment">//get the chaincode details from cds</span></span><br><span class="line">        <span class="comment">// 从cds获取链码详细信息</span></span><br><span class="line">		cName := cds.ChaincodeSpec.ChaincodeId.Name</span><br><span class="line">		cVersion := cds.ChaincodeSpec.ChaincodeId.Version</span><br><span class="line"></span><br><span class="line">		<span class="comment">//if user provided chaincodeName, use it for validation</span></span><br><span class="line">        <span class="comment">// 如果用户提供了chaincodeName，则将其用于验证</span></span><br><span class="line">		<span class="keyword">if</span> chaincodeName != <span class="string">""</span> &amp;&amp; chaincodeName != cName &#123;</span><br><span class="line">			<span class="keyword">return</span> fmt.Errorf(<span class="string">"chaincode name %s does not match name %s in package"</span>, chaincodeName, cName)</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="comment">//if user provided chaincodeVersion, use it for validation</span></span><br><span class="line">        <span class="comment">// 如果用户提供了chaincodeVersion，则将其用于验证</span></span><br><span class="line">		<span class="keyword">if</span> chaincodeVersion != <span class="string">""</span> &amp;&amp; chaincodeVersion != cVersion &#123;</span><br><span class="line">			<span class="keyword">return</span> fmt.Errorf(<span class="string">"chaincode version %s does not match version %s in packages"</span>, chaincodeVersion, cVersion)</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	err = install(ccpackmsg, cf)</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> err</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="InitCmdFactory"><a href="#InitCmdFactory" class="headerlink" title="InitCmdFactory()"></a>InitCmdFactory()</h4><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// InitCmdFactory init the ChaincodeCmdFactory with default clients</span></span><br><span class="line"><span class="comment">// InitCmdFactory使用默认客户端初始化ChaincodeCmdFactory</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">InitCmdFactory</span><span class="params">(cmdName <span class="keyword">string</span>, isEndorserRequired, isOrdererRequired <span class="keyword">bool</span>)</span> <span class="params">(*ChaincodeCmdFactory, error)</span></span> &#123;</span><br><span class="line">	<span class="keyword">var</span> err error</span><br><span class="line">	<span class="keyword">var</span> endorserClients []pb.EndorserClient</span><br><span class="line">	<span class="keyword">var</span> deliverClients []api.PeerDeliverClient</span><br><span class="line">	<span class="keyword">if</span> isEndorserRequired &#123;</span><br><span class="line">		<span class="keyword">if</span> err = validatePeerConnectionParameters(cmdName); err != <span class="literal">nil</span> &#123;</span><br><span class="line">			<span class="keyword">return</span> <span class="literal">nil</span>, errors.WithMessage(err, <span class="string">"error validating peer connection parameters"</span>)</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">for</span> i, address := <span class="keyword">range</span> peerAddresses &#123;</span><br><span class="line">			<span class="keyword">var</span> tlsRootCertFile <span class="keyword">string</span></span><br><span class="line">			<span class="keyword">if</span> tlsRootCertFiles != <span class="literal">nil</span> &#123;</span><br><span class="line">				tlsRootCertFile = tlsRootCertFiles[i]</span><br><span class="line">			&#125;</span><br><span class="line">			endorserClient, err := common.GetEndorserClientFnc(address, tlsRootCertFile)</span><br><span class="line">			<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">				<span class="keyword">return</span> <span class="literal">nil</span>, errors.WithMessage(err, fmt.Sprintf(<span class="string">"error getting endorser client for %s"</span>, cmdName))</span><br><span class="line">			&#125;</span><br><span class="line">			endorserClients = <span class="built_in">append</span>(endorserClients, endorserClient)</span><br><span class="line">			deliverClient, err := common.GetPeerDeliverClientFnc(address, tlsRootCertFile)</span><br><span class="line">			<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">				<span class="keyword">return</span> <span class="literal">nil</span>, errors.WithMessage(err, fmt.Sprintf(<span class="string">"error getting deliver client for %s"</span>, cmdName))</span><br><span class="line">			&#125;</span><br><span class="line">			deliverClients = <span class="built_in">append</span>(deliverClients, deliverClient)</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">if</span> <span class="built_in">len</span>(endorserClients) == <span class="number">0</span> &#123;</span><br><span class="line">			<span class="keyword">return</span> <span class="literal">nil</span>, errors.New(<span class="string">"no endorser clients retrieved - this might indicate a bug"</span>)</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	certificate, err := common.GetCertificateFnc()</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">nil</span>, errors.WithMessage(err, <span class="string">"error getting client cerificate"</span>)</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	signer, err := common.GetDefaultSignerFnc()</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">nil</span>, errors.WithMessage(err, <span class="string">"error getting default signer"</span>)</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">var</span> broadcastClient common.BroadcastClient</span><br><span class="line">	<span class="keyword">if</span> isOrdererRequired &#123;</span><br><span class="line">		<span class="keyword">if</span> <span class="built_in">len</span>(common.OrderingEndpoint) == <span class="number">0</span> &#123;</span><br><span class="line">			<span class="keyword">if</span> <span class="built_in">len</span>(endorserClients) == <span class="number">0</span> &#123;</span><br><span class="line">				<span class="keyword">return</span> <span class="literal">nil</span>, errors.New(<span class="string">"orderer is required, but no ordering endpoint or endorser client supplied"</span>)</span><br><span class="line">			&#125;</span><br><span class="line">			endorserClient := endorserClients[<span class="number">0</span>]</span><br><span class="line"></span><br><span class="line">			orderingEndpoints, err := common.GetOrdererEndpointOfChainFnc(channelID, signer, endorserClient)</span><br><span class="line">			<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">				<span class="keyword">return</span> <span class="literal">nil</span>, errors.WithMessage(err, fmt.Sprintf(<span class="string">"error getting channel (%s) orderer endpoint"</span>, channelID))</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">if</span> <span class="built_in">len</span>(orderingEndpoints) == <span class="number">0</span> &#123;</span><br><span class="line">				<span class="keyword">return</span> <span class="literal">nil</span>, errors.Errorf(<span class="string">"no orderer endpoints retrieved for channel %s"</span>, channelID)</span><br><span class="line">			&#125;</span><br><span class="line">			logger.Infof(<span class="string">"Retrieved channel (%s) orderer endpoint: %s"</span>, channelID, orderingEndpoints[<span class="number">0</span>])</span><br><span class="line">			<span class="comment">// override viper env</span></span><br><span class="line">			viper.Set(<span class="string">"orderer.address"</span>, orderingEndpoints[<span class="number">0</span>])</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		broadcastClient, err = common.GetBroadcastClientFnc()</span><br><span class="line"></span><br><span class="line">		<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">			<span class="keyword">return</span> <span class="literal">nil</span>, errors.WithMessage(err, <span class="string">"error getting broadcast client"</span>)</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> &amp;ChaincodeCmdFactory&#123;</span><br><span class="line">		EndorserClients: endorserClients,</span><br><span class="line">		DeliverClients:  deliverClients,</span><br><span class="line">		Signer:          signer,</span><br><span class="line">		BroadcastClient: broadcastClient,</span><br><span class="line">		Certificate:     certificate,</span><br><span class="line">	&#125;, <span class="literal">nil</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="install"><a href="#install" class="headerlink" title="install()"></a>install()</h4><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//install the depspec to "peer.address"</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">install</span><span class="params">(msg proto.Message, cf *ChaincodeCmdFactory)</span> <span class="title">error</span></span> &#123;</span><br><span class="line">	creator, err := cf.Signer.Serialize()</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> fmt.Errorf(<span class="string">"Error serializing identity for %s: %s"</span>, cf.Signer.GetIdentifier(), err)</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	prop, _, err := utils.CreateInstallProposalFromCDS(msg, creator)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> fmt.Errorf(<span class="string">"Error creating proposal  %s: %s"</span>, chainFuncName, err)</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">var</span> signedProp *pb.SignedProposal</span><br><span class="line">	signedProp, err = utils.GetSignedProposal(prop, cf.Signer)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> fmt.Errorf(<span class="string">"Error creating signed proposal  %s: %s"</span>, chainFuncName, err)</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// install is currently only supported for one peer</span></span><br><span class="line">    <span class="comment">// 当前仅支持一个peer</span></span><br><span class="line">    <span class="comment">// For semantics around ctx use and closing/ending streaming RPCs, please refer to https://godoc.org/google.golang.org/grpc#ClientConn.NewStream.</span></span><br><span class="line">	proposalResponse, err := cf.EndorserClients[<span class="number">0</span>].ProcessProposal(context.Background(), signedProp)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> fmt.Errorf(<span class="string">"Error endorsing %s: %s"</span>, chainFuncName, err)</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> proposalResponse != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">if</span> proposalResponse.Response.Status != <span class="keyword">int32</span>(pcommon.Status_SUCCESS) &#123;</span><br><span class="line">			<span class="keyword">return</span> errors.Errorf(<span class="string">"Bad response: %d - %s"</span>, proposalResponse.Response.Status, proposalResponse.Response.Message)</span><br><span class="line">		&#125;</span><br><span class="line">		logger.Infof(<span class="string">"Installed remotely %v"</span>, proposalResponse)</span><br><span class="line">	&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> errors.New(<span class="string">"Error during install: received nil proposal response"</span>)</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="EndorserClient"><a href="#EndorserClient" class="headerlink" title="EndorserClient"></a>EndorserClient</h4><p>C:\Users\Administrator\go\src\github.com\hyperledger\fabric\vendor\google.golang.org\grpc</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// EndorserClient是Endorser服务的客户端API。</span></span><br><span class="line"><span class="comment">// EndorserClient is the client API for Endorser service.</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// For semantics around ctx use and closing/ending streaming RPCs, please refer to https://godoc.org/google.golang.org/grpc#ClientConn.NewStream.</span></span><br><span class="line"><span class="keyword">type</span> EndorserClient <span class="keyword">interface</span> &#123;</span><br><span class="line">	ProcessProposal(ctx context.Context, in *SignedProposal, opts ...grpc.CallOption) (*ProposalResponse, error)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="invokeCmd"><a href="#invokeCmd" class="headerlink" title="invokeCmd()"></a>invokeCmd()</h3><h4 id="效果-4"><a href="#效果-4" class="headerlink" title="效果"></a>效果</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">Error: The required parameter 'channelID' is empty. Rerun the command with -C flag</span><br><span class="line">Usage:</span><br><span class="line">  peer chaincode invoke [flags]</span><br><span class="line"></span><br><span class="line">Flags:</span><br><span class="line">  -C, --channelID string               The channel on which this command should be executed</span><br><span class="line">      --connectionProfile string       Connection profile that provides the necessary connection information for the network. Note: currently only supported for providing peer connection information</span><br><span class="line">  -c, --ctor string                    Constructor message for the chaincode in JSON format (default "&#123;&#125;")</span><br><span class="line">  -h, --help                           help for invoke</span><br><span class="line">  -n, --name string                    Name of the chaincode</span><br><span class="line">      --peerAddresses stringArray      The addresses of the peers to connect to</span><br><span class="line">      --tlsRootCertFiles stringArray   If TLS is enabled, the paths to the TLS root cert files of the peers to connect to. The order and number of certs specified should match the --peerAddresses flag</span><br><span class="line">      --waitForEvent                   Whether to wait for the event from each peer's deliver filtered service signifying that the 'invoke' transaction has been committed successfully</span><br><span class="line">      --waitForEventTimeout duration   Time to wait for the event from each peer's deliver filtered service signifying that the 'invoke' transaction has been committed successfully (default 30s)</span><br><span class="line"></span><br><span class="line">Global Flags:</span><br><span class="line">      --cafile string                       Path to file containing PEM-encoded trusted certificate(s) for the ordering endpoint</span><br><span class="line">      --certfile string                     Path to file containing PEM-encoded X509 public key to use for mutual TLS communication with the orderer endpoint</span><br><span class="line">      --clientauth                          Use mutual TLS when communicating with the orderer endpoint</span><br><span class="line">      --connTimeout duration                Timeout for client to connect (default 3s)</span><br><span class="line">      --keyfile string                      Path to file containing PEM-encoded private key to use for mutual TLS communication with the orderer endpoint</span><br><span class="line">  -o, --orderer string                      Ordering service endpoint</span><br><span class="line">      --ordererTLSHostnameOverride string   The hostname override to use when validating the TLS connection to the orderer.</span><br><span class="line">      --tls                                 Use TLS when communicating with the orderer endpoint</span><br><span class="line">      --transient string                    Transient map of arguments in JSON encoding</span><br><span class="line"></span><br><span class="line">root@9786bdba6064:/opt/gopath/src/chaincodedev#</span><br></pre></td></tr></table></figure>

<h4 id="代码-4"><a href="#代码-4" class="headerlink" title="代码"></a>代码</h4><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> chaincodeInvokeCmd *cobra.Command</span><br><span class="line"></span><br><span class="line"><span class="comment">// invokeCmd returns the cobra command for Chaincode Invoke</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">invokeCmd</span><span class="params">(cf *ChaincodeCmdFactory)</span> *<span class="title">cobra</span>.<span class="title">Command</span></span> &#123;</span><br><span class="line">	chaincodeInvokeCmd = &amp;cobra.Command&#123;</span><br><span class="line">		Use:       <span class="string">"invoke"</span>,</span><br><span class="line">		Short:     fmt.Sprintf(<span class="string">"Invoke the specified %s."</span>, chainFuncName),</span><br><span class="line">		Long:      fmt.Sprintf(<span class="string">"Invoke the specified %s. It will try to commit the endorsed transaction to the network."</span>, chainFuncName),</span><br><span class="line">		ValidArgs: []<span class="keyword">string</span>&#123;<span class="string">"1"</span>&#125;,</span><br><span class="line">		RunE: <span class="function"><span class="keyword">func</span><span class="params">(cmd *cobra.Command, args []<span class="keyword">string</span>)</span> <span class="title">error</span></span> &#123;</span><br><span class="line">			<span class="keyword">return</span> chaincodeInvoke(cmd, cf)</span><br><span class="line">		&#125;,</span><br><span class="line">	&#125;</span><br><span class="line">	flagList := []<span class="keyword">string</span>&#123;</span><br><span class="line">		<span class="string">"name"</span>,</span><br><span class="line">		<span class="string">"ctor"</span>,</span><br><span class="line">		<span class="string">"channelID"</span>,</span><br><span class="line">		<span class="string">"peerAddresses"</span>,</span><br><span class="line">		<span class="string">"tlsRootCertFiles"</span>,</span><br><span class="line">		<span class="string">"connectionProfile"</span>,</span><br><span class="line">		<span class="string">"waitForEvent"</span>,</span><br><span class="line">		<span class="string">"waitForEventTimeout"</span>,</span><br><span class="line">	&#125;</span><br><span class="line">	attachFlags(chaincodeInvokeCmd, flagList)</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> chaincodeInvokeCmd</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">chaincodeInvoke</span><span class="params">(cmd *cobra.Command, cf *ChaincodeCmdFactory)</span> <span class="title">error</span></span> &#123;</span><br><span class="line">	<span class="keyword">if</span> channelID == <span class="string">""</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> errors.New(<span class="string">"The required parameter 'channelID' is empty. Rerun the command with -C flag"</span>)</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">// Parsing of the command line is done so silence cmd usage</span></span><br><span class="line">	cmd.SilenceUsage = <span class="literal">true</span></span><br><span class="line"></span><br><span class="line">	<span class="keyword">var</span> err error</span><br><span class="line">	<span class="keyword">if</span> cf == <span class="literal">nil</span> &#123;</span><br><span class="line">		cf, err = InitCmdFactory(cmd.Name(), <span class="literal">true</span>, <span class="literal">true</span>)</span><br><span class="line">		<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">			<span class="keyword">return</span> err</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">defer</span> cf.BroadcastClient.Close()</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> chaincodeInvokeOrQuery(cmd, <span class="literal">true</span>, cf)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="chaincodeInvokeOrQuery"><a href="#chaincodeInvokeOrQuery" class="headerlink" title="chaincodeInvokeOrQuery()"></a>chaincodeInvokeOrQuery()</h4><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">chaincodeInvokeOrQuery</span><span class="params">(cmd *cobra.Command, invoke <span class="keyword">bool</span>, cf *ChaincodeCmdFactory)</span> <span class="params">(err error)</span></span> &#123;</span><br><span class="line">	spec, err := getChaincodeSpec(cmd)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> err</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// call with empty txid to ensure production code generates a txid.</span></span><br><span class="line">	<span class="comment">// otherwise, tests can explicitly set their own txid</span></span><br><span class="line">    <span class="comment">// 使用空txid进行调用以确保生产代码生成txid。否则，测试可以显式设置自己的txid</span></span><br><span class="line">	txID := <span class="string">""</span></span><br><span class="line"></span><br><span class="line">	proposalResp, err := ChaincodeInvokeOrQuery(</span><br><span class="line">		spec,</span><br><span class="line">		channelID,</span><br><span class="line">		txID,</span><br><span class="line">		invoke,</span><br><span class="line">		cf.Signer,</span><br><span class="line">		cf.Certificate,</span><br><span class="line">		cf.EndorserClients,</span><br><span class="line">		cf.DeliverClients,</span><br><span class="line">		cf.BroadcastClient)</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> errors.Errorf(<span class="string">"%s - proposal response: %v"</span>, err, proposalResp)</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> invoke &#123;</span><br><span class="line">        <span class="comment">// ESCC：背书系统智能合约通过签署事务提案响应来处理支持</span></span><br><span class="line">		logger.Debugf(<span class="string">"ESCC invoke result: %v"</span>, proposalResp)</span><br><span class="line">        <span class="comment">// 获得提议响应中的有效载荷 </span></span><br><span class="line">		pRespPayload, err := putils.GetProposalResponsePayload(proposalResp.Payload)</span><br><span class="line">		<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">			<span class="keyword">return</span> errors.WithMessage(err, <span class="string">"error while unmarshaling proposal response payload"</span>)</span><br><span class="line">		&#125;</span><br><span class="line">        <span class="comment">// GetChainCodeAction获取指定的chicode动作字节的链代码动作 </span></span><br><span class="line">		ca, err := putils.GetChaincodeAction(pRespPayload.Extension)</span><br><span class="line">		<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">			<span class="keyword">return</span> errors.WithMessage(err, <span class="string">"error while unmarshaling chaincode action"</span>)</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">if</span> proposalResp.Endorsement == <span class="literal">nil</span> &#123;</span><br><span class="line">			<span class="keyword">return</span> errors.Errorf(<span class="string">"endorsement failure during invoke. response: %v"</span>, proposalResp.Response)</span><br><span class="line">		&#125;</span><br><span class="line">		logger.Infof(<span class="string">"Chaincode invoke successful. result: %v"</span>, ca.Response)</span><br><span class="line">	&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">		<span class="keyword">if</span> proposalResp == <span class="literal">nil</span> &#123;</span><br><span class="line">			<span class="keyword">return</span> errors.New(<span class="string">"error during query: received nil proposal response"</span>)</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">if</span> proposalResp.Endorsement == <span class="literal">nil</span> &#123;</span><br><span class="line">			<span class="keyword">return</span> errors.Errorf(<span class="string">"endorsement failure during query. response: %v"</span>, proposalResp.Response)</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">if</span> chaincodeQueryRaw &amp;&amp; chaincodeQueryHex &#123;</span><br><span class="line">			<span class="keyword">return</span> fmt.Errorf(<span class="string">"options --raw (-r) and --hex (-x) are not compatible"</span>)</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">if</span> chaincodeQueryRaw &#123;</span><br><span class="line">			fmt.Println(proposalResp.Response.Payload)</span><br><span class="line">			<span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">if</span> chaincodeQueryHex &#123;</span><br><span class="line">			fmt.Printf(<span class="string">"%x\n"</span>, proposalResp.Response.Payload)</span><br><span class="line">			<span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">		&#125;</span><br><span class="line">		fmt.Println(<span class="keyword">string</span>(proposalResp.Response.Payload))</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="ChaincodeInvokeOrQuery"><a href="#ChaincodeInvokeOrQuery" class="headerlink" title="ChaincodeInvokeOrQuery()"></a>ChaincodeInvokeOrQuery()</h4><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ChaincodeInvokeOrQuery invokes or queries the chaincode. If successful, the</span></span><br><span class="line"><span class="comment">// INVOKE form prints the ProposalResponse to STDOUT, and the QUERY form prints</span></span><br><span class="line"><span class="comment">// the query result on STDOUT. A command-line flag (-r, --raw) determines</span></span><br><span class="line"><span class="comment">// whether the query result is output as raw bytes, or as a printable string.</span></span><br><span class="line"><span class="comment">// The printable form is optionally (-x, --hex) a hexadecimal representation</span></span><br><span class="line"><span class="comment">// of the query response. If the query response is NIL, nothing is output.</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// NOTE - Query will likely go away as all interactions with the endorser are</span></span><br><span class="line"><span class="comment">// Proposal and ProposalResponses</span></span><br><span class="line"><span class="comment">// ChaincodeInvokeOrQuery调用或查询链码。 </span></span><br><span class="line"><span class="comment">// 如果成功，则INVOKE窗体将ProposalResponse打印到STDOUT，而QUERY窗体将查询结果打印到STDOUT。 </span></span><br><span class="line"><span class="comment">// 命令行标志（-r，--raw）确定查询结果是作为原始字节输出还是作为可打印的字符串输出。</span></span><br><span class="line"><span class="comment">// 可打印形式是查询响应的十六进制表示形式，可选（-x，--hex）。 如果查询响应为NIL，则不输出任何内容。</span></span><br><span class="line"><span class="comment">// 注意:由于与背书人的所有互动都是Proposal和ProposalResponses，因此查询可能会消失。</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">ChaincodeInvokeOrQuery</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">	spec *pb.ChaincodeSpec,</span></span></span><br><span class="line"><span class="function"><span class="params">	cID <span class="keyword">string</span>,</span></span></span><br><span class="line"><span class="function"><span class="params">	txID <span class="keyword">string</span>,</span></span></span><br><span class="line"><span class="function"><span class="params">	invoke <span class="keyword">bool</span>,</span></span></span><br><span class="line"><span class="function"><span class="params">	signer msp.SigningIdentity,</span></span></span><br><span class="line"><span class="function"><span class="params">	certificate tls.Certificate,</span></span></span><br><span class="line"><span class="function"><span class="params">	endorserClients []pb.EndorserClient,</span></span></span><br><span class="line"><span class="function"><span class="params">	deliverClients []api.PeerDeliverClient,</span></span></span><br><span class="line"><span class="function"><span class="params">	bc common.BroadcastClient,</span></span></span><br><span class="line"><span class="function"><span class="params">)</span> <span class="params">(*pb.ProposalResponse, error)</span></span> &#123;</span><br><span class="line">	<span class="comment">// Build the ChaincodeInvocationSpec message</span></span><br><span class="line">	invocation := &amp;pb.ChaincodeInvocationSpec&#123;ChaincodeSpec: spec&#125;</span><br><span class="line"></span><br><span class="line">	creator, err := signer.Serialize()</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">nil</span>, errors.WithMessage(err, fmt.Sprintf(<span class="string">"error serializing identity for %s"</span>, signer.GetIdentifier()))</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	funcName := <span class="string">"invoke"</span></span><br><span class="line">	<span class="keyword">if</span> !invoke &#123;</span><br><span class="line">		funcName = <span class="string">"query"</span></span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// extract the transient field if it exists</span></span><br><span class="line">	<span class="keyword">var</span> tMap <span class="keyword">map</span>[<span class="keyword">string</span>][]<span class="keyword">byte</span></span><br><span class="line">	<span class="keyword">if</span> transient != <span class="string">""</span> &#123;</span><br><span class="line">		<span class="keyword">if</span> err := json.Unmarshal([]<span class="keyword">byte</span>(transient), &amp;tMap); err != <span class="literal">nil</span> &#123;</span><br><span class="line">			<span class="keyword">return</span> <span class="literal">nil</span>, errors.Wrap(err, <span class="string">"error parsing transient string"</span>)</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	prop, txid, err := putils.CreateChaincodeProposalWithTxIDAndTransient(pcommon.HeaderType_ENDORSER_TRANSACTION, cID, invocation, creator, txID, tMap)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">nil</span>, errors.WithMessage(err, fmt.Sprintf(<span class="string">"error creating proposal for %s"</span>, funcName))</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	signedProp, err := putils.GetSignedProposal(prop, signer)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">nil</span>, errors.WithMessage(err, fmt.Sprintf(<span class="string">"error creating signed proposal for %s"</span>, funcName))</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">var</span> responses []*pb.ProposalResponse</span><br><span class="line">	<span class="keyword">for</span> _, endorser := <span class="keyword">range</span> endorserClients &#123;</span><br><span class="line">		proposalResp, err := endorser.ProcessProposal(context.Background(), signedProp)</span><br><span class="line">		<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">			<span class="keyword">return</span> <span class="literal">nil</span>, errors.WithMessage(err, fmt.Sprintf(<span class="string">"error endorsing %s"</span>, funcName))</span><br><span class="line">		&#125;</span><br><span class="line">		responses = <span class="built_in">append</span>(responses, proposalResp)</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> <span class="built_in">len</span>(responses) == <span class="number">0</span> &#123;</span><br><span class="line">		<span class="comment">// this should only happen if some new code has introduced a bug</span></span><br><span class="line">		<span class="keyword">return</span> <span class="literal">nil</span>, errors.New(<span class="string">"no proposal responses received - this might indicate a bug"</span>)</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">// all responses will be checked when the signed transaction is created.</span></span><br><span class="line">	<span class="comment">// for now, just set this so we check the first response's status</span></span><br><span class="line">	proposalResp := responses[<span class="number">0</span>]</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> invoke &#123;</span><br><span class="line">		<span class="keyword">if</span> proposalResp != <span class="literal">nil</span> &#123;</span><br><span class="line">			<span class="keyword">if</span> proposalResp.Response.Status &gt;= shim.ERRORTHRESHOLD &#123;</span><br><span class="line">				<span class="keyword">return</span> proposalResp, <span class="literal">nil</span></span><br><span class="line">			&#125;</span><br><span class="line">			<span class="comment">// assemble a signed transaction (it's an Envelope message)</span></span><br><span class="line">            <span class="comment">// </span></span><br><span class="line">			env, err := putils.CreateSignedTx(prop, signer, responses...)</span><br><span class="line">			<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">				<span class="keyword">return</span> proposalResp, errors.WithMessage(err, <span class="string">"could not assemble transaction"</span>)</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">var</span> dg *deliverGroup</span><br><span class="line">			<span class="keyword">var</span> ctx context.Context</span><br><span class="line">			<span class="keyword">if</span> waitForEvent &#123;</span><br><span class="line">				<span class="keyword">var</span> cancelFunc context.CancelFunc</span><br><span class="line">				ctx, cancelFunc = context.WithTimeout(context.Background(), waitForEventTimeout)</span><br><span class="line">				<span class="keyword">defer</span> cancelFunc()</span><br><span class="line"></span><br><span class="line">				dg = newDeliverGroup(deliverClients, peerAddresses, certificate, channelID, txid)</span><br><span class="line">				<span class="comment">// connect to deliver service on all peers</span></span><br><span class="line">                <span class="comment">// 连接到所有peer提供服务</span></span><br><span class="line">				err := dg.Connect(ctx)</span><br><span class="line">				<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">					<span class="keyword">return</span> <span class="literal">nil</span>, err</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;</span><br><span class="line"></span><br><span class="line">			<span class="comment">// send the envelope for ordering</span></span><br><span class="line">            <span class="comment">// 把信封寄给订阅者</span></span><br><span class="line">			<span class="keyword">if</span> err = bc.Send(env); err != <span class="literal">nil</span> &#123;</span><br><span class="line">				<span class="keyword">return</span> proposalResp, errors.WithMessage(err, fmt.Sprintf(<span class="string">"error sending transaction for %s"</span>, funcName))</span><br><span class="line">			&#125;</span><br><span class="line"></span><br><span class="line">			<span class="keyword">if</span> dg != <span class="literal">nil</span> &amp;&amp; ctx != <span class="literal">nil</span> &#123;</span><br><span class="line">				<span class="comment">// wait for event that contains the txid from all peers</span></span><br><span class="line">                <span class="comment">// 等待包含来自所有peer的txid的事件。</span></span><br><span class="line">				err = dg.Wait(ctx)</span><br><span class="line">				<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">					<span class="keyword">return</span> <span class="literal">nil</span>, err</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> proposalResp, <span class="literal">nil</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="common函数库"><a href="#common函数库" class="headerlink" title="common函数库"></a>common函数库</h2>
        </div>

        <blockquote class="post-copyright">
    
    <div class="content">
        
<span class="post-time">
    Last updated: <time datetime="2019-11-03T08:40:26.000Z" itemprop="dateUpdated">2019-11-03 16:40:26</time>
</span><br>


        
    </div>
    
    <footer>
        <a href="http://cupswen.github.io">
            <img src="/img/the_Huanghe_River.png" alt="CupsWen">
            CupsWen
        </a>
    </footer>
</blockquote>

        


        <div class="post-footer">
            
	<ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Fabric/" rel="tag">Fabric</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/fabric-samples/" rel="tag">fabric-samples</a></li></ul>


            
<div class="page-share-wrap">
    

<div class="page-share" id="pageShare">
    <ul class="reset share-icons">
      <li>
        <a class="weibo share-sns" target="_blank" href="http://service.weibo.com/share/share.php?url=http://cupswen.github.io/2019/11/03/2019/find-2/&title=《find2》 — Cups&pic=http://cupswen.github.io/img/the_Huanghe_River.png" data-title="微博">
          <i class="icon icon-weibo"></i>
        </a>
      </li>
      <li>
        <a class="weixin share-sns wxFab" href="javascript:;" data-title="微信">
          <i class="icon icon-weixin"></i>
        </a>
      </li>
      <li>
        <a class="qq share-sns" target="_blank" href="http://connect.qq.com/widget/shareqq/index.html?url=http://cupswen.github.io/2019/11/03/2019/find-2/&title=《find2》 — Cups&source=" data-title=" QQ">
          <i class="icon icon-qq"></i>
        </a>
      </li>
      <li>
        <a class="facebook share-sns" target="_blank" href="https://www.facebook.com/sharer/sharer.php?u=http://cupswen.github.io/2019/11/03/2019/find-2/" data-title=" Facebook">
          <i class="icon icon-facebook"></i>
        </a>
      </li>
      <li>
        <a class="twitter share-sns" target="_blank" href="https://twitter.com/intent/tweet?text=《find2》 — Cups&url=http://cupswen.github.io/2019/11/03/2019/find-2/&via=http://cupswen.github.io" data-title=" Twitter">
          <i class="icon icon-twitter"></i>
        </a>
      </li>
      <li>
        <a class="google share-sns" target="_blank" href="https://plus.google.com/share?url=http://cupswen.github.io/2019/11/03/2019/find-2/" data-title=" Google+">
          <i class="icon icon-google-plus"></i>
        </a>
      </li>
    </ul>
 </div>



    <a href="javascript:;" id="shareFab" class="page-share-fab waves-effect waves-circle">
        <i class="icon icon-share-alt icon-lg"></i>
    </a>
</div>



        </div>
    </div>

    
<nav class="post-nav flex-row flex-justify-between">
  
    <div class="waves-block waves-effect prev">
      <a href="/2019/11/05/2019/leetcode-multithreading/" id="post-prev" class="post-nav-link">
        <div class="tips"><i class="icon icon-angle-left icon-lg icon-pr"></i> Prev</div>
        <h4 class="title">LeetCode之多线程</h4>
      </a>
    </div>
  

  
    <div class="waves-block waves-effect next">
      <a href="/2019/11/03/2019/find-1/" id="post-next" class="post-nav-link">
        <div class="tips">Next <i class="icon icon-angle-right icon-lg icon-pl"></i></div>
        <h4 class="title">find1</h4>
      </a>
    </div>
  
</nav>



    

</article>



</div>

        <footer class="footer">
    <div class="top">
        
<p>
    <span id="busuanzi_container_site_uv" style='display:none'>
        站点总访客数：<span id="busuanzi_value_site_uv"></span>
    </span>
    <span id="busuanzi_container_site_pv" style='display:none'>
        站点总访问量：<span id="busuanzi_value_site_pv"></span>
    </span>
</p>


        <p>
            
            <span>This blog is licensed under a <a rel="license noopener" href="https://creativecommons.org/licenses/by/4.0/" target="_blank">Creative Commons Attribution 4.0 International License</a>.</span>
        </p>
    </div>
    <div class="bottom">
        <p><span>CupsWen &copy; 2019 - 2020</span>
            <span>
                
                Power by <a href="http://hexo.io/" target="_blank">Hexo</a> Theme indigo.</a>
            </span>
        </p>
    </div>
</footer>

    </main>
    <div class="mask" id="mask"></div>
<a href="javascript:;" id="gotop" class="waves-effect waves-circle waves-light"><span class="icon icon-lg icon-chevron-up"></span></a>



<div class="global-share" id="globalShare">
    <ul class="reset share-icons">
      <li>
        <a class="weibo share-sns" target="_blank" href="http://service.weibo.com/share/share.php?url=http://cupswen.github.io/2019/11/03/2019/find-2/&title=《find2》 — Cups&pic=http://cupswen.github.io/img/the_Huanghe_River.png" data-title="微博">
          <i class="icon icon-weibo"></i>
        </a>
      </li>
      <li>
        <a class="weixin share-sns wxFab" href="javascript:;" data-title="微信">
          <i class="icon icon-weixin"></i>
        </a>
      </li>
      <li>
        <a class="qq share-sns" target="_blank" href="http://connect.qq.com/widget/shareqq/index.html?url=http://cupswen.github.io/2019/11/03/2019/find-2/&title=《find2》 — Cups&source=" data-title=" QQ">
          <i class="icon icon-qq"></i>
        </a>
      </li>
      <li>
        <a class="facebook share-sns" target="_blank" href="https://www.facebook.com/sharer/sharer.php?u=http://cupswen.github.io/2019/11/03/2019/find-2/" data-title=" Facebook">
          <i class="icon icon-facebook"></i>
        </a>
      </li>
      <li>
        <a class="twitter share-sns" target="_blank" href="https://twitter.com/intent/tweet?text=《find2》 — Cups&url=http://cupswen.github.io/2019/11/03/2019/find-2/&via=http://cupswen.github.io" data-title=" Twitter">
          <i class="icon icon-twitter"></i>
        </a>
      </li>
      <li>
        <a class="google share-sns" target="_blank" href="https://plus.google.com/share?url=http://cupswen.github.io/2019/11/03/2019/find-2/" data-title=" Google+">
          <i class="icon icon-google-plus"></i>
        </a>
      </li>
    </ul>
 </div>


<div class="page-modal wx-share" id="wxShare">
    <a class="close" href="javascript:;"><i class="icon icon-close"></i></a>
    <p>扫一扫，分享到微信</p>
    <img src="//api.qrserver.com/v1/create-qr-code/?data=http://cupswen.github.io/2019/11/03/2019/find-2/" alt="微信分享二维码">
</div>




    <script src="//cdn.bootcss.com/node-waves/0.7.4/waves.min.js"></script>
<script>
var BLOG = { ROOT: '/', SHARE: true, REWARD: false };


</script>

<script src="//unpkg.com/hexo-theme-material-indigo@latest/js/main.min.js"></script>


<div class="search-panel" id="search-panel">
    <ul class="search-result" id="search-result"></ul>
</div>
<template id="search-tpl">
<li class="item">
    <a href="{path}" class="waves-block waves-effect">
        <div class="title ellipsis" title="{title}">{title}</div>
        <div class="flex-row flex-middle">
            <div class="tags ellipsis">
                {tags}
            </div>
            <time class="flex-col time">{date}</time>
        </div>
    </a>
</li>
</template>

<script src="//unpkg.com/hexo-theme-material-indigo@latest/js/search.min.js" async></script>






<script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>



<script>
(function() {
    var OriginTitile = document.title, titleTime;
    document.addEventListener('visibilitychange', function() {
        if (document.hidden) {
            document.title = 'Cups';
            clearTimeout(titleTime);
        } else {
            document.title = 'Cups';
            titleTime = setTimeout(function() {
                document.title = OriginTitile;
            },2000);
        }
    });
})();
</script>



</body>
</html>
