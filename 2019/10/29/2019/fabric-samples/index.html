<!DOCTYPE html>
<html>
<head>
    

    

    



    <meta charset="utf-8">
    
    
    
    
    <title>窥探fabric-samples详细内容 | Cups</title>
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    
    <meta name="theme-color" content="#3F51B5">
    
    
    <meta name="keywords" content="Fabric,fabric-samples">
    <meta name="description" content="目录 .├── balance-transfer                            # 余额代偿(演示Node.js API操作)├── basic-network                                # 一系列shell脚本，去生成初始化并启动一个最基本的网络  （OK）├── chaincode">
<meta name="keywords" content="Fabric,fabric-samples">
<meta property="og:type" content="article">
<meta property="og:title" content="窥探fabric-samples详细内容">
<meta property="og:url" content="http:&#x2F;&#x2F;cupswen.github.io&#x2F;2019&#x2F;10&#x2F;29&#x2F;2019&#x2F;fabric-samples&#x2F;index.html">
<meta property="og:site_name" content="Cups">
<meta property="og:description" content="目录 .├── balance-transfer                            # 余额代偿(演示Node.js API操作)├── basic-network                                # 一系列shell脚本，去生成初始化并启动一个最基本的网络  （OK）├── chaincode">
<meta property="og:locale" content="en">
<meta property="og:updated_time" content="2019-11-07T10:59:02.000Z">
<meta name="twitter:card" content="summary">
    
    <link rel="shortcut icon" href="/img/brand.jpg">
    <link rel="stylesheet" href="//unpkg.com/hexo-theme-material-indigo@latest/css/style.css">
    <script>window.lazyScripts=[]</script>

    <!-- custom head -->
    

</head>

<body>
    <div id="loading" class="active"></div>

    <aside id="menu" class="hide" >
  <div class="inner flex-row-vertical">
    <a href="javascript:;" class="header-icon waves-effect waves-circle waves-light" id="menu-off">
        <i class="icon icon-lg icon-close"></i>
    </a>
    <div class="brand-wrap" style="background-image:url(/img/brand.jpg)">
      <div class="brand">
        <a href="/" class="avatar waves-effect waves-circle waves-light">
          <img src="/img/the_Huanghe_River.png">
        </a>
        <hgroup class="introduce">
          <h5 class="nickname">CupsWen</h5>
          <a href="mailto:1191567189@qq.com" target="_blank" rel="noopener" title="1191567189@qq.com" class="mail">1191567189@qq.com</a>
        </hgroup>
      </div>
    </div>
    <div class="scroll-wrap flex-col">
      <ul class="nav">
        
            <li class="waves-block waves-effect">
              <a href="/index.html"  >
                <i class="icon icon-lg icon-home"></i>
                主页
              </a>
            </li>
        
            <li class="waves-block waves-effect">
              <a href="/archives"  >
                <i class="icon icon-lg icon-archives"></i>
                Archives
              </a>
            </li>
        
            <li class="waves-block waves-effect">
              <a href="/tags"  >
                <i class="icon icon-lg icon-tags"></i>
                Tags
              </a>
            </li>
        
            <li class="waves-block waves-effect">
              <a href="/categories"  >
                <i class="icon icon-lg icon-th-list"></i>
                Categories
              </a>
            </li>
        
            <li class="waves-block waves-effect">
              <a href="https://github.com/CupsWen" target="_blank" >
                <i class="icon icon-lg icon-github"></i>
                Github
              </a>
            </li>
        
            <li class="waves-block waves-effect">
              <a href="https://cupswen.github.io/hyperlink"  >
                <i class="icon icon-lg icon-link"></i>
                Link
              </a>
            </li>
        
      </ul>
    </div>
  </div>
</aside>

    <main id="main">
        <header class="top-header" id="header">
    <div class="flex-row">
        <a href="javascript:;" class="header-icon waves-effect waves-circle waves-light on" id="menu-toggle">
          <i class="icon icon-lg icon-navicon"></i>
        </a>
        <div class="flex-col header-title ellipsis">窥探fabric-samples详细内容</div>
        
        <div class="search-wrap" id="search-wrap">
            <a href="javascript:;" class="header-icon waves-effect waves-circle waves-light" id="back">
                <i class="icon icon-lg icon-chevron-left"></i>
            </a>
            <input type="text" id="key" class="search-input" autocomplete="off" placeholder="Search">
            <a href="javascript:;" class="header-icon waves-effect waves-circle waves-light" id="search">
                <i class="icon icon-lg icon-search"></i>
            </a>
        </div>
        
        
        <a href="javascript:;" class="header-icon waves-effect waves-circle waves-light" id="menuShare">
            <i class="icon icon-lg icon-share-alt"></i>
        </a>
        
    </div>
</header>
<header class="content-header post-header">

    <div class="container fade-scale">
        <h1 class="title">窥探fabric-samples详细内容</h1>
        <h5 class="subtitle">
            
                <time datetime="2019-10-29T04:18:10.000Z" itemprop="datePublished" class="page-time">
  2019-10-29
</time>


	<ul class="article-category-list"><li class="article-category-list-item"><a class="article-category-list-link" href="/categories/Fabric/">Fabric</a></li></ul>

            
        </h5>
    </div>

    


</header>


<div class="container body-wrap">
    
    <aside class="post-widget">
        <nav class="post-toc-wrap post-toc-shrink" id="post-toc">
            <h4>TOC</h4>
            <ol class="post-toc"><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#目录"><span class="post-toc-text">目录</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#balance-transfer-余额代偿"><span class="post-toc-text">balance-transfer(余额代偿)</span></a></li><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#basic-network-基础网络搭建"><span class="post-toc-text">basic-network(基础网络搭建)</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-5"><a class="post-toc-link" href="#generate-sh-生成证书、创世区块、通道、leader节点"><span class="post-toc-text">generate.sh(生成证书、创世区块、通道、leader节点)</span></a></li><li class="post-toc-item post-toc-level-5"><a class="post-toc-link" href="#start-sh-启动docker"><span class="post-toc-text">start.sh(启动docker)</span></a></li><li class="post-toc-item post-toc-level-5"><a class="post-toc-link" href="#stop-sh-关闭docker"><span class="post-toc-text">stop.sh(关闭docker)</span></a></li><li class="post-toc-item post-toc-level-5"><a class="post-toc-link" href="#teardown-sh-删除docker、私钥"><span class="post-toc-text">teardown.sh(删除docker、私钥)</span></a></li></ol></li><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#chaincode-智能合约示例"><span class="post-toc-text">chaincode(智能合约示例)</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-5"><a class="post-toc-link" href="#bac-基于身份属性的访问控制"><span class="post-toc-text">bac(基于身份属性的访问控制)</span></a></li><li class="post-toc-item post-toc-level-5"><a class="post-toc-link" href="#chaincode-example02-一个简单的账户间转账和查询的示例"><span class="post-toc-text">chaincode_example02(一个简单的账户间转账和查询的示例)</span></a></li><li class="post-toc-item post-toc-level-5"><a class="post-toc-link" href="#fabcar-一个关于汽车的综合示例"><span class="post-toc-text">fabcar(一个关于汽车的综合示例)</span></a></li><li class="post-toc-item post-toc-level-5"><a class="post-toc-link" href="#marbles02-弹珠资产管理链码"><span class="post-toc-text">marbles02(弹珠资产管理链码)</span></a></li><li class="post-toc-item post-toc-level-5"><a class="post-toc-link" href="#marbles02-private-弹珠资产管理链码"><span class="post-toc-text">marbles02_private(弹珠资产管理链码)</span></a></li><li class="post-toc-item post-toc-level-5"><a class="post-toc-link" href="#sacc-简单资产管理链码示例"><span class="post-toc-text">sacc(简单资产管理链码示例)</span></a></li></ol></li><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#chaincode-docker-devmode-开发者模式调试chaincode"><span class="post-toc-text">chaincode-docker-devmode(开发者模式调试chaincode)</span></a></li><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#fabcar-车示例"><span class="post-toc-text">fabcar(车示例)</span></a></li><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#first-network-复杂网络搭建"><span class="post-toc-text">first-network(复杂网络搭建)</span></a></li><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#high-throughput-高通量网络下的chaincode设计"><span class="post-toc-text">high-throughput(高通量网络下的chaincode设计)</span></a></li><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#interest-rate-swaps-利率互换示例"><span class="post-toc-text">interest_rate_swaps(利率互换示例)</span></a></li><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#off-chain-data-离线数据处理"><span class="post-toc-text">off_chain_data(离线数据处理)</span></a></li><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#scripts-批处理脚本"><span class="post-toc-text">scripts(批处理脚本)</span></a></li></ol></li></ol></li></ol>
        </nav>
    </aside>


<article id="post-2019/fabric-samples"
  class="post-article article-type-post fade" itemprop="blogPost">

    <div class="post-card">
        <h1 class="post-card-title">窥探fabric-samples详细内容</h1>
        <div class="post-meta">
            <time class="post-time" title="2019-10-29 12:18:10" datetime="2019-10-29T04:18:10.000Z"  itemprop="datePublished">2019-10-29</time>

            
	<ul class="article-category-list"><li class="article-category-list-item"><a class="article-category-list-link" href="/categories/Fabric/">Fabric</a></li></ul>



            
<span id="busuanzi_container_page_pv" title="文章总阅读量" style='display:none'>
    <i class="icon icon-eye icon-pr"></i><span id="busuanzi_value_page_pv"></span>
</span>


        </div>
        <div class="post-content" id="post-content" itemprop="postContent">
            <h2 id="目录"><a href="#目录" class="headerlink" title="目录"></a>目录</h2><blockquote>
<p>.<br>├── balance-transfer                            # 余额代偿(演示Node.js API操作)<br>├── basic-network                                # 一系列shell脚本，去生成初始化并启动一个最基本的网络  （OK）<br>├── chaincode                                       # 链码的示例                                                                                （OK）<br>├── chaincode-docker-devmode       # 开发模式下调试链码                                                                 （OK）<br>├── fabcar                                              # 一个汽车的例子<br>├── first-network                                  # 搭建hyperledger fabric环境                                                   （OK）<br>├── high-throughput                            # 正确设计链码数据模型，以处理在每秒数千个并发事务       （OK）<br>├── interest_rate_swaps                      # 利率互换<br>├── off_chain_data                               # 离线数据<br>├── scripts                                             # 脚本示例</p>
</blockquote>
<h4 id="balance-transfer-余额代偿"><a href="#balance-transfer-余额代偿" class="headerlink" title="balance-transfer(余额代偿)"></a>balance-transfer(余额代偿)</h4><blockquote>
<p>请参考</p>
<p><a href="https://cupswen.github.io/2019/11/01/balance-transfer/">https://cupswen.github.io/2019/11/01/balance-transfer/</a></p>
</blockquote>
<h4 id="basic-network-基础网络搭建"><a href="#basic-network-基础网络搭建" class="headerlink" title="basic-network(基础网络搭建)"></a>basic-network(基础网络搭建)</h4><blockquote>
<p>请注意，此基本配置使用预先生成的证书和<br>密钥材料，并且还具有预定义的事务来初始化<br>名为<code>mychannel</code>的频道。<br>要重新生成此材料，只需运行<code>generate.sh</code>。<br>要启动网络，请运行<code>start.sh</code>。<br>要停止它，运行<code>stop.sh</code><br>完全删除网络的所有可证明证据<br>在您的系统上，运行<code>teardown.sh</code>。</p>
</blockquote>
<h5 id="generate-sh-生成证书、创世区块、通道、leader节点"><a href="#generate-sh-生成证书、创世区块、通道、leader节点" class="headerlink" title="generate.sh(生成证书、创世区块、通道、leader节点)"></a>generate.sh(生成证书、创世区块、通道、leader节点)</h5><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash">!/bin/sh</span></span><br><span class="line"><span class="meta">#</span><span class="bash"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> Copyright IBM Corp All Rights Reserved</span></span><br><span class="line"><span class="meta">#</span><span class="bash"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> SPDX-License-Identifier: Apache-2.0</span></span><br><span class="line"><span class="meta">#</span><span class="bash"></span></span><br><span class="line">export PATH=$GOPATH/src/github.com/hyperledger/fabric/build/bin:$&#123;PWD&#125;/../bin:$&#123;PWD&#125;:$PATH</span><br><span class="line">export FABRIC_CFG_PATH=$&#123;PWD&#125;</span><br><span class="line">CHANNEL_NAME=mychannel</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> remove previous crypto material and config transactions</span></span><br><span class="line">rm -fr config/*</span><br><span class="line">rm -fr crypto-config/*</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> generate crypto material</span></span><br><span class="line">cryptogen generate --config=./crypto-config.yaml</span><br><span class="line">if [ "$?" -ne 0 ]; then</span><br><span class="line">  echo "Failed to generate crypto material..."</span><br><span class="line">  exit 1</span><br><span class="line">fi</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> generate genesis block <span class="keyword">for</span> orderer</span></span><br><span class="line">configtxgen -profile OneOrgOrdererGenesis -outputBlock ./config/genesis.block</span><br><span class="line">if [ "$?" -ne 0 ]; then</span><br><span class="line">  echo "Failed to generate orderer genesis block..."</span><br><span class="line">  exit 1</span><br><span class="line">fi</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> generate channel configuration transaction</span></span><br><span class="line">configtxgen -profile OneOrgChannel -outputCreateChannelTx ./config/channel.tx -channelID $CHANNEL_NAME</span><br><span class="line">if [ "$?" -ne 0 ]; then</span><br><span class="line">  echo "Failed to generate channel configuration transaction..."</span><br><span class="line">  exit 1</span><br><span class="line">fi</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> generate anchor peer transaction</span></span><br><span class="line">configtxgen -profile OneOrgChannel -outputAnchorPeersUpdate ./config/Org1MSPanchors.tx -channelID $CHANNEL_NAME -asOrg Org1MSP</span><br><span class="line">if [ "$?" -ne 0 ]; then</span><br><span class="line">  echo "Failed to generate anchor peer update for Org1MSP..."</span><br><span class="line">  exit 1</span><br><span class="line">fi</span><br></pre></td></tr></table></figure>

<h5 id="start-sh-启动docker"><a href="#start-sh-启动docker" class="headerlink" title="start.sh(启动docker)"></a>start.sh(启动docker)</h5><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash">!/bin/bash</span></span><br><span class="line"><span class="meta">#</span><span class="bash"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> Copyright IBM Corp All Rights Reserved</span></span><br><span class="line"><span class="meta">#</span><span class="bash"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> SPDX-License-Identifier: Apache-2.0</span></span><br><span class="line"><span class="meta">#</span><span class="bash"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> Exit on first error, <span class="built_in">print</span> all commands.</span></span><br><span class="line">set -ev</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> don<span class="string">'t rewrite paths for Windows Git Bash users</span></span></span><br><span class="line">export MSYS_NO_PATHCONV=1</span><br><span class="line"></span><br><span class="line">docker-compose -f docker-compose.yml down</span><br><span class="line"></span><br><span class="line">docker-compose -f docker-compose.yml up -d ca.example.com orderer.example.com peer0.org1.example.com couchdb</span><br><span class="line">docker ps -a</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> <span class="built_in">wait</span> <span class="keyword">for</span> Hyperledger Fabric to start</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> incase of errors when running later commands, issue <span class="built_in">export</span> FABRIC_START_TIMEOUT=&lt;larger number&gt;</span></span><br><span class="line">export FABRIC_START_TIMEOUT=10</span><br><span class="line"><span class="meta">#</span><span class="bash"><span class="built_in">echo</span> <span class="variable">$&#123;FABRIC_START_TIMEOUT&#125;</span></span></span><br><span class="line">sleep $&#123;FABRIC_START_TIMEOUT&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> Create the channel</span></span><br><span class="line">docker exec -e "CORE_PEER_LOCALMSPID=Org1MSP" -e "CORE_PEER_MSPCONFIGPATH=/etc/hyperledger/msp/users/Admin@org1.example.com/msp" peer0.org1.example.com peer channel create -o orderer.example.com:7050 -c mychannel -f /etc/hyperledger/configtx/channel.tx</span><br><span class="line"><span class="meta">#</span><span class="bash"> Join peer0.org1.example.com to the channel.</span></span><br><span class="line">docker exec -e "CORE_PEER_LOCALMSPID=Org1MSP" -e "CORE_PEER_MSPCONFIGPATH=/etc/hyperledger/msp/users/Admin@org1.example.com/msp" peer0.org1.example.com peer channel join -b mychannel.block</span><br></pre></td></tr></table></figure>

<h5 id="stop-sh-关闭docker"><a href="#stop-sh-关闭docker" class="headerlink" title="stop.sh(关闭docker)"></a>stop.sh(关闭docker)</h5><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash">!/bin/bash</span></span><br><span class="line"><span class="meta">#</span><span class="bash"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> Copyright IBM Corp All Rights Reserved</span></span><br><span class="line"><span class="meta">#</span><span class="bash"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> SPDX-License-Identifier: Apache-2.0</span></span><br><span class="line"><span class="meta">#</span><span class="bash"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> Exit on first error, <span class="built_in">print</span> all commands.</span></span><br><span class="line">set -ev</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> Shut down the Docker containers that might be currently running.</span></span><br><span class="line">docker-compose -f docker-compose.yml stop</span><br></pre></td></tr></table></figure>

<h5 id="teardown-sh-删除docker、私钥"><a href="#teardown-sh-删除docker、私钥" class="headerlink" title="teardown.sh(删除docker、私钥)"></a>teardown.sh(删除docker、私钥)</h5><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash">!/bin/bash</span></span><br><span class="line"><span class="meta">#</span><span class="bash"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> Copyright IBM Corp All Rights Reserved</span></span><br><span class="line"><span class="meta">#</span><span class="bash"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> SPDX-License-Identifier: Apache-2.0</span></span><br><span class="line"><span class="meta">#</span><span class="bash"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> Exit on first error, <span class="built_in">print</span> all commands.</span></span><br><span class="line">set -e</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> Shut down the Docker containers <span class="keyword">for</span> the system tests.</span></span><br><span class="line">docker-compose -f docker-compose.yml kill &amp;&amp; docker-compose -f docker-compose.yml down</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> remove the <span class="built_in">local</span> state</span></span><br><span class="line">rm -f ~/.hfc-key-store/*</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> remove chaincode docker images</span></span><br><span class="line">docker rm $(docker ps -aq)</span><br><span class="line">docker rmi $(docker images dev-* -q)</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> Your system is now clean</span></span><br></pre></td></tr></table></figure>

<h4 id="chaincode-智能合约示例"><a href="#chaincode-智能合约示例" class="headerlink" title="chaincode(智能合约示例)"></a>chaincode(智能合约示例)</h4><blockquote>
<p>.<br>├── abac                                           # Attribute-Based Access Control 基于身份属性的访问控制<br>├── chaincode_example02           # 一个简单的账户间转账和查询的示例<br>├── fabcar                                       # 一个关于汽车的综合示例，提供了Fabric功能的广泛演示。<br>├── marbles02                               # 弹珠资产管理链码，演示couchDB的富查询（基于json）<br>├── marbles02_private                # 弹珠资产管理链码，演示couchDB的富查询（基于json）(私有数据)<br>└── sacc                                          # SimpleAssetChainCode 简单资产管理链码示例</p>
</blockquote>
<h5 id="bac-基于身份属性的访问控制"><a href="#bac-基于身份属性的访问控制" class="headerlink" title="bac(基于身份属性的访问控制)"></a>bac(基于身份属性的访问控制)</h5><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br></pre></td><td class="code"><pre><span class="line"> # Attribute-Based Access Control 基于身份属性的访问控制</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">Copyright IBM Corp. 2016 All Rights Reserved.</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">Licensed under the Apache License, Version 2.0 (the "License");</span></span><br><span class="line"><span class="comment">you may not use this file except in compliance with the License.</span></span><br><span class="line"><span class="comment">You may obtain a copy of the License at</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">		 http://www.apache.org/licenses/LICENSE-2.0</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">Unless required by applicable law or agreed to in writing, software</span></span><br><span class="line"><span class="comment">distributed under the License is distributed on an "AS IS" BASIS,</span></span><br><span class="line"><span class="comment">WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.</span></span><br><span class="line"><span class="comment">See the License for the specific language governing permissions and</span></span><br><span class="line"><span class="comment">limitations under the License.</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">	<span class="string">"fmt"</span></span><br><span class="line">	<span class="string">"strconv"</span></span><br><span class="line"></span><br><span class="line">	<span class="string">"github.com/hyperledger/fabric/core/chaincode/shim/ext/cid"</span></span><br><span class="line">	<span class="string">"github.com/hyperledger/fabric/core/chaincode/shim"</span></span><br><span class="line">	pb <span class="string">"github.com/hyperledger/fabric/protos/peer"</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="comment">// SimpleChaincode example simple Chaincode implementation</span></span><br><span class="line"><span class="keyword">type</span> SimpleChaincode <span class="keyword">struct</span> &#123;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Init initializes the chaincode</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(t *SimpleChaincode)</span> <span class="title">Init</span><span class="params">(stub shim.ChaincodeStubInterface)</span> <span class="title">pb</span>.<span class="title">Response</span></span> &#123;</span><br><span class="line"></span><br><span class="line">	fmt.Println(<span class="string">"abac Init"</span>)</span><br><span class="line"></span><br><span class="line">	<span class="comment">//</span></span><br><span class="line">	<span class="comment">// Demonstrate the use of Attribute-Based Access Control (ABAC) by checking</span></span><br><span class="line">	<span class="comment">// to see if the caller has the "abac.init" attribute with a value of true;</span></span><br><span class="line">	<span class="comment">// if not, return an error.</span></span><br><span class="line">	<span class="comment">//</span></span><br><span class="line">	<span class="comment">// 通过检查调用方是否具有值为true的“ abac.init”属性来演示基于属性的访问控制（ABAC）的使用。 如果不是，则返回错误。</span></span><br><span class="line">	err := cid.AssertAttributeValue(stub, <span class="string">"abac.init"</span>, <span class="string">"true"</span>)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> shim.Error(err.Error())</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	_, args := stub.GetFunctionAndParameters()</span><br><span class="line">	<span class="keyword">var</span> A, B <span class="keyword">string</span>    <span class="comment">// Entities</span></span><br><span class="line">	<span class="keyword">var</span> Aval, Bval <span class="keyword">int</span> <span class="comment">// Asset holdings</span></span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> <span class="built_in">len</span>(args) != <span class="number">4</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> shim.Error(<span class="string">"Incorrect number of arguments. Expecting 4"</span>)</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// Initialize the chaincode</span></span><br><span class="line">	A = args[<span class="number">0</span>]</span><br><span class="line">	Aval, err = strconv.Atoi(args[<span class="number">1</span>])</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> shim.Error(<span class="string">"Expecting integer value for asset holding"</span>)</span><br><span class="line">	&#125;</span><br><span class="line">	B = args[<span class="number">2</span>]</span><br><span class="line">	Bval, err = strconv.Atoi(args[<span class="number">3</span>])</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> shim.Error(<span class="string">"Expecting integer value for asset holding"</span>)</span><br><span class="line">	&#125;</span><br><span class="line">	fmt.Printf(<span class="string">"Aval = %d, Bval = %d\n"</span>, Aval, Bval)</span><br><span class="line"></span><br><span class="line">	<span class="comment">// Write the state to the ledger</span></span><br><span class="line">	err = stub.PutState(A, []<span class="keyword">byte</span>(strconv.Itoa(Aval)))</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> shim.Error(err.Error())</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	err = stub.PutState(B, []<span class="keyword">byte</span>(strconv.Itoa(Bval)))</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> shim.Error(err.Error())</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> shim.Success(<span class="literal">nil</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(t *SimpleChaincode)</span> <span class="title">Invoke</span><span class="params">(stub shim.ChaincodeStubInterface)</span> <span class="title">pb</span>.<span class="title">Response</span></span> &#123;</span><br><span class="line">	fmt.Println(<span class="string">"abac Invoke"</span>)</span><br><span class="line">	function, args := stub.GetFunctionAndParameters()</span><br><span class="line">	<span class="keyword">if</span> function == <span class="string">"invoke"</span> &#123;</span><br><span class="line">		<span class="comment">// Make payment of X units from A to B</span></span><br><span class="line">		<span class="keyword">return</span> t.invoke(stub, args)</span><br><span class="line">	&#125; <span class="keyword">else</span> <span class="keyword">if</span> function == <span class="string">"delete"</span> &#123;</span><br><span class="line">		<span class="comment">// Deletes an entity from its state</span></span><br><span class="line">		<span class="keyword">return</span> t.<span class="built_in">delete</span>(stub, args)</span><br><span class="line">	&#125; <span class="keyword">else</span> <span class="keyword">if</span> function == <span class="string">"query"</span> &#123;</span><br><span class="line">		<span class="comment">// the old "Query" is now implemtned in invoke</span></span><br><span class="line">		<span class="keyword">return</span> t.query(stub, args)</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> shim.Error(<span class="string">"Invalid invoke function name. Expecting \"invoke\" \"delete\" \"query\""</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Transaction makes payment of X units from A to B</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(t *SimpleChaincode)</span> <span class="title">invoke</span><span class="params">(stub shim.ChaincodeStubInterface, args []<span class="keyword">string</span>)</span> <span class="title">pb</span>.<span class="title">Response</span></span> &#123;</span><br><span class="line">	<span class="keyword">var</span> A, B <span class="keyword">string</span>    <span class="comment">// Entities</span></span><br><span class="line">	<span class="keyword">var</span> Aval, Bval <span class="keyword">int</span> <span class="comment">// Asset holdings</span></span><br><span class="line">	<span class="keyword">var</span> X <span class="keyword">int</span>          <span class="comment">// Transaction value</span></span><br><span class="line">	<span class="keyword">var</span> err error</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> <span class="built_in">len</span>(args) != <span class="number">3</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> shim.Error(<span class="string">"Incorrect number of arguments. Expecting 3"</span>)</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	A = args[<span class="number">0</span>]</span><br><span class="line">	B = args[<span class="number">1</span>]</span><br><span class="line"></span><br><span class="line">	<span class="comment">// Get the state from the ledger</span></span><br><span class="line">	<span class="comment">// <span class="doctag">TODO:</span> will be nice to have a GetAllState call to ledger</span></span><br><span class="line">	Avalbytes, err := stub.GetState(A)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> shim.Error(<span class="string">"Failed to get state"</span>)</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">if</span> Avalbytes == <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> shim.Error(<span class="string">"Entity not found"</span>)</span><br><span class="line">	&#125;</span><br><span class="line">	Aval, _ = strconv.Atoi(<span class="keyword">string</span>(Avalbytes))</span><br><span class="line"></span><br><span class="line">	Bvalbytes, err := stub.GetState(B)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> shim.Error(<span class="string">"Failed to get state"</span>)</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">if</span> Bvalbytes == <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> shim.Error(<span class="string">"Entity not found"</span>)</span><br><span class="line">	&#125;</span><br><span class="line">	Bval, _ = strconv.Atoi(<span class="keyword">string</span>(Bvalbytes))</span><br><span class="line"></span><br><span class="line">	<span class="comment">// Perform the execution</span></span><br><span class="line">	X, err = strconv.Atoi(args[<span class="number">2</span>])</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> shim.Error(<span class="string">"Invalid transaction amount, expecting a integer value"</span>)</span><br><span class="line">	&#125;</span><br><span class="line">	Aval = Aval - X</span><br><span class="line">	Bval = Bval + X</span><br><span class="line">	fmt.Printf(<span class="string">"Aval = %d, Bval = %d\n"</span>, Aval, Bval)</span><br><span class="line"></span><br><span class="line">	<span class="comment">// Write the state back to the ledger</span></span><br><span class="line">	err = stub.PutState(A, []<span class="keyword">byte</span>(strconv.Itoa(Aval)))</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> shim.Error(err.Error())</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	err = stub.PutState(B, []<span class="keyword">byte</span>(strconv.Itoa(Bval)))</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> shim.Error(err.Error())</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> shim.Success(<span class="literal">nil</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Deletes an entity from state</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(t *SimpleChaincode)</span> <span class="title">delete</span><span class="params">(stub shim.ChaincodeStubInterface, args []<span class="keyword">string</span>)</span> <span class="title">pb</span>.<span class="title">Response</span></span> &#123;</span><br><span class="line">	<span class="keyword">if</span> <span class="built_in">len</span>(args) != <span class="number">1</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> shim.Error(<span class="string">"Incorrect number of arguments. Expecting 1"</span>)</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	A := args[<span class="number">0</span>]</span><br><span class="line"></span><br><span class="line">	<span class="comment">// Delete the key from the state in ledger</span></span><br><span class="line">	err := stub.DelState(A)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> shim.Error(<span class="string">"Failed to delete state"</span>)</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> shim.Success(<span class="literal">nil</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// query callback representing the query of a chaincode</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(t *SimpleChaincode)</span> <span class="title">query</span><span class="params">(stub shim.ChaincodeStubInterface, args []<span class="keyword">string</span>)</span> <span class="title">pb</span>.<span class="title">Response</span></span> &#123;</span><br><span class="line">	<span class="keyword">var</span> A <span class="keyword">string</span> <span class="comment">// Entities</span></span><br><span class="line">	<span class="keyword">var</span> err error</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> <span class="built_in">len</span>(args) != <span class="number">1</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> shim.Error(<span class="string">"Incorrect number of arguments. Expecting name of the person to query"</span>)</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	A = args[<span class="number">0</span>]</span><br><span class="line"></span><br><span class="line">	<span class="comment">// Get the state from the ledger</span></span><br><span class="line">	Avalbytes, err := stub.GetState(A)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		jsonResp := <span class="string">"&#123;\"Error\":\"Failed to get state for "</span> + A + <span class="string">"\"&#125;"</span></span><br><span class="line">		<span class="keyword">return</span> shim.Error(jsonResp)</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> Avalbytes == <span class="literal">nil</span> &#123;</span><br><span class="line">		jsonResp := <span class="string">"&#123;\"Error\":\"Nil amount for "</span> + A + <span class="string">"\"&#125;"</span></span><br><span class="line">		<span class="keyword">return</span> shim.Error(jsonResp)</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	jsonResp := <span class="string">"&#123;\"Name\":\""</span> + A + <span class="string">"\",\"Amount\":\""</span> + <span class="keyword">string</span>(Avalbytes) + <span class="string">"\"&#125;"</span></span><br><span class="line">	fmt.Printf(<span class="string">"Query Response:%s\n"</span>, jsonResp)</span><br><span class="line">	<span class="keyword">return</span> shim.Success(Avalbytes)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">	err := shim.Start(<span class="built_in">new</span>(SimpleChaincode))</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		fmt.Printf(<span class="string">"Error starting Simple chaincode: %s"</span>, err)</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="chaincode-example02-一个简单的账户间转账和查询的示例"><a href="#chaincode-example02-一个简单的账户间转账和查询的示例" class="headerlink" title="chaincode_example02(一个简单的账户间转账和查询的示例)"></a>chaincode_example02(一个简单的账户间转账和查询的示例)</h5><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br></pre></td><td class="code"><pre><span class="line"># 一个简单的账户间转账和查询的示例</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">Copyright IBM Corp. 2016 All Rights Reserved.</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">Licensed under the Apache License, Version 2.0 (the "License");</span></span><br><span class="line"><span class="comment">you may not use this file except in compliance with the License.</span></span><br><span class="line"><span class="comment">You may obtain a copy of the License at</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">		 http://www.apache.org/licenses/LICENSE-2.0</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">Unless required by applicable law or agreed to in writing, software</span></span><br><span class="line"><span class="comment">distributed under the License is distributed on an "AS IS" BASIS,</span></span><br><span class="line"><span class="comment">WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.</span></span><br><span class="line"><span class="comment">See the License for the specific language governing permissions and</span></span><br><span class="line"><span class="comment">limitations under the License.</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="comment">//WARNING - this chaincode's ID is hard-coded in chaincode_example04 to illustrate one way of</span></span><br><span class="line"><span class="comment">//calling chaincode from a chaincode. If this example is modified, chaincode_example04.go has</span></span><br><span class="line"><span class="comment">//to be modified as well with the new ID of chaincode_example02.</span></span><br><span class="line"><span class="comment">//chaincode_example05 show's how chaincode ID can be passed in as a parameter instead of</span></span><br><span class="line"><span class="comment">//hard-coding.</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">	<span class="string">"fmt"</span></span><br><span class="line">	<span class="string">"strconv"</span></span><br><span class="line"></span><br><span class="line">	<span class="string">"github.com/hyperledger/fabric/core/chaincode/shim"</span></span><br><span class="line">	pb <span class="string">"github.com/hyperledger/fabric/protos/peer"</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="comment">// SimpleChaincode example simple Chaincode implementation</span></span><br><span class="line"><span class="keyword">type</span> SimpleChaincode <span class="keyword">struct</span> &#123;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(t *SimpleChaincode)</span> <span class="title">Init</span><span class="params">(stub shim.ChaincodeStubInterface)</span> <span class="title">pb</span>.<span class="title">Response</span></span> &#123;</span><br><span class="line">	fmt.Println(<span class="string">"ex02 Init"</span>)</span><br><span class="line">	_, args := stub.GetFunctionAndParameters()</span><br><span class="line">	<span class="keyword">var</span> A, B <span class="keyword">string</span>    <span class="comment">// Entities</span></span><br><span class="line">	<span class="keyword">var</span> Aval, Bval <span class="keyword">int</span> <span class="comment">// Asset holdings</span></span><br><span class="line">	<span class="keyword">var</span> err error</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> <span class="built_in">len</span>(args) != <span class="number">4</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> shim.Error(<span class="string">"Incorrect number of arguments. Expecting 4"</span>)</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// Initialize the chaincode</span></span><br><span class="line">    <span class="comment">//  Atoi is equivalent to ParseInt(s, 10, 0), converted to type int.</span></span><br><span class="line">	A = args[<span class="number">0</span>]</span><br><span class="line">	Aval, err = strconv.Atoi(args[<span class="number">1</span>])</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> shim.Error(<span class="string">"Expecting integer value for asset holding"</span>)</span><br><span class="line">	&#125;</span><br><span class="line">	B = args[<span class="number">2</span>]</span><br><span class="line">	Bval, err = strconv.Atoi(args[<span class="number">3</span>])</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> shim.Error(<span class="string">"Expecting integer value for asset holding"</span>)</span><br><span class="line">	&#125;</span><br><span class="line">	fmt.Printf(<span class="string">"Aval = %d, Bval = %d\n"</span>, Aval, Bval)</span><br><span class="line"></span><br><span class="line">	<span class="comment">// Write the state to the ledger</span></span><br><span class="line">    <span class="comment">// <span class="doctag">TODO:</span> Itoa is equivalent to FormatInt(int64(i), 10).</span></span><br><span class="line">	err = stub.PutState(A, []<span class="keyword">byte</span>(strconv.Itoa(Aval)))</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> shim.Error(err.Error())</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	err = stub.PutState(B, []<span class="keyword">byte</span>(strconv.Itoa(Bval)))</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> shim.Error(err.Error())</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> shim.Success(<span class="literal">nil</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(t *SimpleChaincode)</span> <span class="title">Invoke</span><span class="params">(stub shim.ChaincodeStubInterface)</span> <span class="title">pb</span>.<span class="title">Response</span></span> &#123;</span><br><span class="line">	fmt.Println(<span class="string">"ex02 Invoke"</span>)</span><br><span class="line">	function, args := stub.GetFunctionAndParameters()</span><br><span class="line">	<span class="keyword">if</span> function == <span class="string">"invoke"</span> &#123;</span><br><span class="line">		<span class="comment">// Make payment of X units from A to B</span></span><br><span class="line">		<span class="keyword">return</span> t.invoke(stub, args)</span><br><span class="line">	&#125; <span class="keyword">else</span> <span class="keyword">if</span> function == <span class="string">"delete"</span> &#123;</span><br><span class="line">		<span class="comment">// Deletes an entity from its state</span></span><br><span class="line">		<span class="keyword">return</span> t.<span class="built_in">delete</span>(stub, args)</span><br><span class="line">	&#125; <span class="keyword">else</span> <span class="keyword">if</span> function == <span class="string">"query"</span> &#123;</span><br><span class="line">		<span class="comment">// the old "Query" is now implemtned in invoke</span></span><br><span class="line">		<span class="keyword">return</span> t.query(stub, args)</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> shim.Error(<span class="string">"Invalid invoke function name. Expecting \"invoke\" \"delete\" \"query\""</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Transaction makes payment of X units from A to B</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(t *SimpleChaincode)</span> <span class="title">invoke</span><span class="params">(stub shim.ChaincodeStubInterface, args []<span class="keyword">string</span>)</span> <span class="title">pb</span>.<span class="title">Response</span></span> &#123;</span><br><span class="line">	<span class="keyword">var</span> A, B <span class="keyword">string</span>    <span class="comment">// Entities</span></span><br><span class="line">	<span class="keyword">var</span> Aval, Bval <span class="keyword">int</span> <span class="comment">// Asset holdings</span></span><br><span class="line">	<span class="keyword">var</span> X <span class="keyword">int</span>          <span class="comment">// Transaction value</span></span><br><span class="line">	<span class="keyword">var</span> err error</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> <span class="built_in">len</span>(args) != <span class="number">3</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> shim.Error(<span class="string">"Incorrect number of arguments. Expecting 3"</span>)</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	A = args[<span class="number">0</span>]</span><br><span class="line">	B = args[<span class="number">1</span>]</span><br><span class="line"></span><br><span class="line">	<span class="comment">// Get the state from the ledger</span></span><br><span class="line">	<span class="comment">// <span class="doctag">TODO:</span> will be nice to have a GetAllState call to ledger</span></span><br><span class="line">	Avalbytes, err := stub.GetState(A)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> shim.Error(<span class="string">"Failed to get state"</span>)</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">if</span> Avalbytes == <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> shim.Error(<span class="string">"Entity not found"</span>)</span><br><span class="line">	&#125;</span><br><span class="line">	Aval, _ = strconv.Atoi(<span class="keyword">string</span>(Avalbytes))</span><br><span class="line"></span><br><span class="line">	Bvalbytes, err := stub.GetState(B)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> shim.Error(<span class="string">"Failed to get state"</span>)</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">if</span> Bvalbytes == <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> shim.Error(<span class="string">"Entity not found"</span>)</span><br><span class="line">	&#125;</span><br><span class="line">	Bval, _ = strconv.Atoi(<span class="keyword">string</span>(Bvalbytes))</span><br><span class="line"></span><br><span class="line">	<span class="comment">// Perform the execution</span></span><br><span class="line">	X, err = strconv.Atoi(args[<span class="number">2</span>])</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> shim.Error(<span class="string">"Invalid transaction amount, expecting a integer value"</span>)</span><br><span class="line">	&#125;</span><br><span class="line">	Aval = Aval - X</span><br><span class="line">	Bval = Bval + X</span><br><span class="line">	fmt.Printf(<span class="string">"Aval = %d, Bval = %d\n"</span>, Aval, Bval)</span><br><span class="line"></span><br><span class="line">	<span class="comment">// Write the state back to the ledger</span></span><br><span class="line">	err = stub.PutState(A, []<span class="keyword">byte</span>(strconv.Itoa(Aval)))</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> shim.Error(err.Error())</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	err = stub.PutState(B, []<span class="keyword">byte</span>(strconv.Itoa(Bval)))</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> shim.Error(err.Error())</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> shim.Success(<span class="literal">nil</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Deletes an entity from state</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(t *SimpleChaincode)</span> <span class="title">delete</span><span class="params">(stub shim.ChaincodeStubInterface, args []<span class="keyword">string</span>)</span> <span class="title">pb</span>.<span class="title">Response</span></span> &#123;</span><br><span class="line">	<span class="keyword">if</span> <span class="built_in">len</span>(args) != <span class="number">1</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> shim.Error(<span class="string">"Incorrect number of arguments. Expecting 1"</span>)</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	A := args[<span class="number">0</span>]</span><br><span class="line"></span><br><span class="line">	<span class="comment">// Delete the key from the state in ledger</span></span><br><span class="line">	err := stub.DelState(A)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> shim.Error(<span class="string">"Failed to delete state"</span>)</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> shim.Success(<span class="literal">nil</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// query callback representing the query of a chaincode</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(t *SimpleChaincode)</span> <span class="title">query</span><span class="params">(stub shim.ChaincodeStubInterface, args []<span class="keyword">string</span>)</span> <span class="title">pb</span>.<span class="title">Response</span></span> &#123;</span><br><span class="line">	<span class="keyword">var</span> A <span class="keyword">string</span> <span class="comment">// Entities</span></span><br><span class="line">	<span class="keyword">var</span> err error</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> <span class="built_in">len</span>(args) != <span class="number">1</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> shim.Error(<span class="string">"Incorrect number of arguments. Expecting name of the person to query"</span>)</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	A = args[<span class="number">0</span>]</span><br><span class="line"></span><br><span class="line">	<span class="comment">// Get the state from the ledger</span></span><br><span class="line">	Avalbytes, err := stub.GetState(A)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		jsonResp := <span class="string">"&#123;\"Error\":\"Failed to get state for "</span> + A + <span class="string">"\"&#125;"</span></span><br><span class="line">		<span class="keyword">return</span> shim.Error(jsonResp)</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> Avalbytes == <span class="literal">nil</span> &#123;</span><br><span class="line">		jsonResp := <span class="string">"&#123;\"Error\":\"Nil amount for "</span> + A + <span class="string">"\"&#125;"</span></span><br><span class="line">		<span class="keyword">return</span> shim.Error(jsonResp)</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	jsonResp := <span class="string">"&#123;\"Name\":\""</span> + A + <span class="string">"\",\"Amount\":\""</span> + <span class="keyword">string</span>(Avalbytes) + <span class="string">"\"&#125;"</span></span><br><span class="line">	fmt.Printf(<span class="string">"Query Response:%s\n"</span>, jsonResp)</span><br><span class="line">	<span class="keyword">return</span> shim.Success(Avalbytes)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">	err := shim.Start(<span class="built_in">new</span>(SimpleChaincode))</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		fmt.Printf(<span class="string">"Error starting Simple chaincode: %s"</span>, err)</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="fabcar-一个关于汽车的综合示例"><a href="#fabcar-一个关于汽车的综合示例" class="headerlink" title="fabcar(一个关于汽车的综合示例)"></a>fabcar(一个关于汽车的综合示例)</h5><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">	<span class="string">"bytes"</span>					<span class="comment">// 面对的主要是字节和字节切片</span></span><br><span class="line">	<span class="string">"encoding/json"</span>			<span class="comment">// JSON转换库</span></span><br><span class="line">	<span class="string">"fmt"</span>					<span class="comment">// 命令行输出</span></span><br><span class="line">	<span class="string">"strconv"</span>				<span class="comment">// 数据类型转换</span></span><br><span class="line"></span><br><span class="line">	<span class="string">"github.com/hyperledger/fabric/core/chaincode/shim"</span>	<span class="comment">// 链码和账本交互的包</span></span><br><span class="line">	sc <span class="string">"github.com/hyperledger/fabric/protos/peer"</span>		<span class="comment">// gRPC</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> SmartContract <span class="keyword">struct</span> &#123;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> Car <span class="keyword">struct</span> &#123;</span><br><span class="line">	Make   <span class="keyword">string</span> <span class="string">`json:"make"`</span></span><br><span class="line">	Model  <span class="keyword">string</span> <span class="string">`json:"model"`</span></span><br><span class="line">	Colour <span class="keyword">string</span> <span class="string">`json:"colour"`</span></span><br><span class="line">	Owner  <span class="keyword">string</span> <span class="string">`json:"owner"`</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(s *SmartContract)</span> <span class="title">Init</span><span class="params">(APIstub shim.ChaincodeStubInterface)</span> <span class="title">sc</span>.<span class="title">Response</span></span> &#123;</span><br><span class="line">	<span class="keyword">return</span> shim.Success(<span class="literal">nil</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(s *SmartContract)</span> <span class="title">Invoke</span><span class="params">(APIstub shim.ChaincodeStubInterface)</span> <span class="title">sc</span>.<span class="title">Response</span></span> &#123;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 获得命令和参数</span></span><br><span class="line">    <span class="comment">// peer chaincode invoke -n mycc -c '&#123;"Args":["queryCar","a"]&#125;' -C myc</span></span><br><span class="line">	function, args := APIstub.GetFunctionAndParameters()</span><br><span class="line">	<span class="comment">// 根据命令做不同的操作（if）</span></span><br><span class="line">	<span class="keyword">if</span> function == <span class="string">"initLedger"</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> s.initLedger(APIstub)</span><br><span class="line">	&#125; <span class="keyword">else</span> <span class="keyword">if</span> function == <span class="string">"queryCar"</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> s.queryCar(APIstub, args)</span><br><span class="line">	&#125; <span class="keyword">else</span> <span class="keyword">if</span> function == <span class="string">"createCar"</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> s.createCar(APIstub, args)</span><br><span class="line">	&#125; <span class="keyword">else</span> <span class="keyword">if</span> function == <span class="string">"queryAllCars"</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> s.queryAllCars(APIstub)</span><br><span class="line">	&#125; <span class="keyword">else</span> <span class="keyword">if</span> function == <span class="string">"changeCarOwner"</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> s.changeCarOwner(APIstub, args)</span><br><span class="line">	&#125;</span><br><span class="line">    <span class="comment">// 返回错误信息</span></span><br><span class="line">	<span class="keyword">return</span> shim.Error(<span class="string">"Invalid Smart Contract function name."</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(s *SmartContract)</span> <span class="title">initLedger</span><span class="params">(APIstub shim.ChaincodeStubInterface)</span> <span class="title">sc</span>.<span class="title">Response</span></span> &#123;</span><br><span class="line">	<span class="comment">// 数据列表</span></span><br><span class="line">    cars := []Car&#123;</span><br><span class="line">		Car&#123;Make: <span class="string">"Toyota"</span>, Model: <span class="string">"Prius"</span>, Colour: <span class="string">"blue"</span>, Owner: <span class="string">"Tomoko"</span>&#125;,</span><br><span class="line">		Car&#123;Make: <span class="string">"Ford"</span>, Model: <span class="string">"Mustang"</span>, Colour: <span class="string">"red"</span>, Owner: <span class="string">"Brad"</span>&#125;,</span><br><span class="line">		Car&#123;Make: <span class="string">"Hyundai"</span>, Model: <span class="string">"Tucson"</span>, Colour: <span class="string">"green"</span>, Owner: <span class="string">"Jin Soo"</span>&#125;,</span><br><span class="line">		Car&#123;Make: <span class="string">"Volkswagen"</span>, Model: <span class="string">"Passat"</span>, Colour: <span class="string">"yellow"</span>, Owner: <span class="string">"Max"</span>&#125;,</span><br><span class="line">		Car&#123;Make: <span class="string">"Tesla"</span>, Model: <span class="string">"S"</span>, Colour: <span class="string">"black"</span>, Owner: <span class="string">"Adriana"</span>&#125;,</span><br><span class="line">		Car&#123;Make: <span class="string">"Peugeot"</span>, Model: <span class="string">"205"</span>, Colour: <span class="string">"purple"</span>, Owner: <span class="string">"Michel"</span>&#125;,</span><br><span class="line">		Car&#123;Make: <span class="string">"Chery"</span>, Model: <span class="string">"S22L"</span>, Colour: <span class="string">"white"</span>, Owner: <span class="string">"Aarav"</span>&#125;,</span><br><span class="line">		Car&#123;Make: <span class="string">"Fiat"</span>, Model: <span class="string">"Punto"</span>, Colour: <span class="string">"violet"</span>, Owner: <span class="string">"Pari"</span>&#125;,</span><br><span class="line">		Car&#123;Make: <span class="string">"Tata"</span>, Model: <span class="string">"Nano"</span>, Colour: <span class="string">"indigo"</span>, Owner: <span class="string">"Valeria"</span>&#125;,</span><br><span class="line">		Car&#123;Make: <span class="string">"Holden"</span>, Model: <span class="string">"Barina"</span>, Colour: <span class="string">"brown"</span>, Owner: <span class="string">"Shotaro"</span>&#125;,</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	i := <span class="number">0</span></span><br><span class="line">	<span class="keyword">for</span> i &lt; <span class="built_in">len</span>(cars) &#123;</span><br><span class="line">		fmt.Println(<span class="string">"i is "</span>, i)</span><br><span class="line">        <span class="comment">// 整理为json格式字节数据</span></span><br><span class="line">		carAsBytes, _ := json.Marshal(cars[i])</span><br><span class="line">		<span class="comment">// 写入世界状态</span></span><br><span class="line">        APIstub.PutState(<span class="string">"CAR"</span>+strconv.Itoa(i), carAsBytes)</span><br><span class="line">		fmt.Println(<span class="string">"Added"</span>, cars[i])</span><br><span class="line">		i = i + <span class="number">1</span></span><br><span class="line">	&#125;</span><br><span class="line">    <span class="comment">// &#123;Make: "Holden", Model: "Barina", Colour: "brown", Owner: "Shotaro"&#125; 68</span></span><br><span class="line">	<span class="comment">/*</span></span><br><span class="line"><span class="comment">	69</span></span><br><span class="line"><span class="comment">	Added &#123;Holden Barina brown Shotaro&#125; [123 34 109 97 107 101 34 58 34 72 111 108 100 101 110 34 44 34 109 111 100 101 108 34 58 34 66 97 114 105 110 97 34 44 34 99 111 108 111 117 114 34 58 34 98 114 111 119 110 34 44 34 111 119 110 101 114 34 58 34 83 104 111 116 97 114 111 34 125]</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">	<span class="keyword">return</span> shim.Success(<span class="literal">nil</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(s *SmartContract)</span> <span class="title">queryCar</span><span class="params">(APIstub shim.ChaincodeStubInterface, args []<span class="keyword">string</span>)</span> <span class="title">sc</span>.<span class="title">Response</span></span> &#123;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> <span class="built_in">len</span>(args) != <span class="number">1</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> shim.Error(<span class="string">"Incorrect number of arguments. Expecting 1"</span>)</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">    <span class="comment">// 从账本中获取关键字为args[0]的数据</span></span><br><span class="line">	carAsBytes, _ := APIstub.GetState(args[<span class="number">0</span>])</span><br><span class="line">    <span class="comment">// 返回</span></span><br><span class="line">	<span class="keyword">return</span> shim.Success(carAsBytes)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(s *SmartContract)</span> <span class="title">createCar</span><span class="params">(APIstub shim.ChaincodeStubInterface, args []<span class="keyword">string</span>)</span> <span class="title">sc</span>.<span class="title">Response</span></span> &#123;</span><br><span class="line">	<span class="comment">// Car&#123;Make: "Toyota", Model: "Prius", Colour: "blue", Owner: "Tomoko"&#125; + 主键</span></span><br><span class="line">	<span class="keyword">if</span> <span class="built_in">len</span>(args) != <span class="number">5</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> shim.Error(<span class="string">"Incorrect number of arguments. Expecting 5"</span>)</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">var</span> car = Car&#123;Make: args[<span class="number">1</span>], Model: args[<span class="number">2</span>], Colour: args[<span class="number">3</span>], Owner: args[<span class="number">4</span>]&#125;</span><br><span class="line">	</span><br><span class="line">	carAsBytes, _ := json.Marshal(car)</span><br><span class="line">    <span class="comment">// 存入数据</span></span><br><span class="line">	APIstub.PutState(args[<span class="number">0</span>], carAsBytes)</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> shim.Success(<span class="literal">nil</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(s *SmartContract)</span> <span class="title">queryAllCars</span><span class="params">(APIstub shim.ChaincodeStubInterface)</span> <span class="title">sc</span>.<span class="title">Response</span></span> &#123;</span><br><span class="line"></span><br><span class="line">	startKey := <span class="string">"CAR0"</span></span><br><span class="line">	endKey := <span class="string">"CAR999"</span></span><br><span class="line">	</span><br><span class="line">    <span class="comment">// 查询指定Key指定范围内的历史记录</span></span><br><span class="line">	resultsIterator, err := APIstub.GetStateByRange(startKey, endKey)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> shim.Error(err.Error())</span><br><span class="line">	&#125;</span><br><span class="line">    <span class="comment">// 延迟执行</span></span><br><span class="line">	<span class="keyword">defer</span> resultsIterator.Close()</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 字节Buffer</span></span><br><span class="line">	<span class="keyword">var</span> buffer bytes.Buffer</span><br><span class="line">	buffer.WriteString(<span class="string">"["</span>)</span><br><span class="line"></span><br><span class="line">	bArrayMemberAlreadyWritten := <span class="literal">false</span></span><br><span class="line">	<span class="keyword">for</span> resultsIterator.HasNext() &#123;</span><br><span class="line">		queryResponse, err := resultsIterator.Next()</span><br><span class="line">		<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">			<span class="keyword">return</span> shim.Error(err.Error())</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="comment">// 其他</span></span><br><span class="line">		<span class="keyword">if</span> bArrayMemberAlreadyWritten == <span class="literal">true</span> &#123;</span><br><span class="line">			buffer.WriteString(<span class="string">","</span>)</span><br><span class="line">		&#125;</span><br><span class="line">        <span class="comment">// 首次</span></span><br><span class="line">		buffer.WriteString(<span class="string">"&#123;\"Key\":"</span>)</span><br><span class="line">		buffer.WriteString(<span class="string">"\""</span>)</span><br><span class="line">		buffer.WriteString(queryResponse.Key)</span><br><span class="line">		buffer.WriteString(<span class="string">"\""</span>)</span><br><span class="line"></span><br><span class="line">		buffer.WriteString(<span class="string">", \"Record\":"</span>)</span><br><span class="line">		buffer.WriteString(<span class="keyword">string</span>(queryResponse.Value))</span><br><span class="line">		buffer.WriteString(<span class="string">"&#125;"</span>)</span><br><span class="line">		bArrayMemberAlreadyWritten = <span class="literal">true</span></span><br><span class="line">	&#125;</span><br><span class="line">	buffer.WriteString(<span class="string">"]"</span>)</span><br><span class="line"></span><br><span class="line">	fmt.Printf(<span class="string">"- queryAllCars:\n%s\n"</span>, buffer.String())</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> shim.Success(buffer.Bytes())</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">[&#123;"Key":"CAR0", "Record":&#123;"colour":"blue","make":"Toyota","model":"Prius","owner":"Tomoko"&#125;&#125;,&#123;"Key":"CAR1", "Record":&#123;"colour":"red","make":"Ford","model":"Mustang","owner":"Brad"&#125;&#125;,&#123;"Key":"CAR10", "Record":&#123;"colour":"","make":"","model":"","owner":"Dave"&#125;&#125;,&#123;"Key":"CAR12", "Record":&#123;"colour":"Black","make":"Honda","model":"Accord","owner":"Tom"&#125;&#125;,&#123;"Key":"CAR2", "Record":&#123;"colour":"green","make":"Hyundai","model":"Tucson","owner":"Jin Soo"&#125;&#125;,&#123;"Key":"CAR3", "Record":&#123;"colour":"yellow","make":"Volkswagen","model":"Passat","owner":"Max"&#125;&#125;,&#123;"Key":"CAR4", "Record":&#123;"colour":"black","make":"Tesla","model":"S","owner":"Adriana"&#125;&#125;,&#123;"Key":"CAR5", "Record":&#123;"colour":"purple","make":"Peugeot","model":"205","owner":"Michel"&#125;&#125;,&#123;"Key":"CAR6", "Record":&#123;"colour":"white","make":"Chery","model":"S22L","owner":"Aarav"&#125;&#125;,&#123;"Key":"CAR7", "Record":&#123;"colour":"violet","make":"Fiat","model":"Punto","owner":"Pari"&#125;&#125;,&#123;"Key":"CAR8", "Record":&#123;"colour":"indigo","make":"Tata","model":"Nano","owner":"Valeria"&#125;&#125;,&#123;"Key":"CAR9", "Record":&#123;"colour":"brown","make":"Holden","model":"Barina","owner":"Shotaro"&#125;&#125;]</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(s *SmartContract)</span> <span class="title">changeCarOwner</span><span class="params">(APIstub shim.ChaincodeStubInterface, args []<span class="keyword">string</span>)</span> <span class="title">sc</span>.<span class="title">Response</span></span> &#123;</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">if</span> <span class="built_in">len</span>(args) != <span class="number">2</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> shim.Error(<span class="string">"Incorrect number of arguments. Expecting 2"</span>)</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	carAsBytes, _ := APIstub.GetState(args[<span class="number">0</span>])</span><br><span class="line">	car := Car&#123;&#125;</span><br><span class="line"></span><br><span class="line">	json.Unmarshal(carAsBytes, &amp;car)</span><br><span class="line">	car.Owner = args[<span class="number">1</span>]</span><br><span class="line"></span><br><span class="line">	carAsBytes, _ = json.Marshal(car)</span><br><span class="line">	APIstub.PutState(args[<span class="number">0</span>], carAsBytes)</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> shim.Success(<span class="literal">nil</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// CORE_PEER_ADDRESS=peer:7052 </span></span><br><span class="line"><span class="comment">// CORE_CHAINCODE_ID_NAME=mycc:0 ./chaincode_example02</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line"></span><br><span class="line">	err := shim.Start(<span class="built_in">new</span>(SmartContract))</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		fmt.Printf(<span class="string">"Error creating new Smart Contract: %s"</span>, err)</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="marbles02-弹珠资产管理链码"><a href="#marbles02-弹珠资产管理链码" class="headerlink" title="marbles02(弹珠资产管理链码)"></a>marbles02(弹珠资产管理链码)</h5><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br><span class="line">426</span><br><span class="line">427</span><br><span class="line">428</span><br><span class="line">429</span><br><span class="line">430</span><br><span class="line">431</span><br><span class="line">432</span><br><span class="line">433</span><br><span class="line">434</span><br><span class="line">435</span><br><span class="line">436</span><br><span class="line">437</span><br><span class="line">438</span><br><span class="line">439</span><br><span class="line">440</span><br><span class="line">441</span><br><span class="line">442</span><br><span class="line">443</span><br><span class="line">444</span><br><span class="line">445</span><br><span class="line">446</span><br><span class="line">447</span><br><span class="line">448</span><br><span class="line">449</span><br><span class="line">450</span><br><span class="line">451</span><br><span class="line">452</span><br><span class="line">453</span><br><span class="line">454</span><br><span class="line">455</span><br><span class="line">456</span><br><span class="line">457</span><br><span class="line">458</span><br><span class="line">459</span><br><span class="line">460</span><br><span class="line">461</span><br><span class="line">462</span><br><span class="line">463</span><br><span class="line">464</span><br><span class="line">465</span><br><span class="line">466</span><br><span class="line">467</span><br><span class="line">468</span><br><span class="line">469</span><br><span class="line">470</span><br><span class="line">471</span><br><span class="line">472</span><br><span class="line">473</span><br><span class="line">474</span><br><span class="line">475</span><br><span class="line">476</span><br><span class="line">477</span><br><span class="line">478</span><br><span class="line">479</span><br><span class="line">480</span><br><span class="line">481</span><br><span class="line">482</span><br><span class="line">483</span><br><span class="line">484</span><br><span class="line">485</span><br><span class="line">486</span><br><span class="line">487</span><br><span class="line">488</span><br><span class="line">489</span><br><span class="line">490</span><br><span class="line">491</span><br><span class="line">492</span><br><span class="line">493</span><br><span class="line">494</span><br><span class="line">495</span><br><span class="line">496</span><br><span class="line">497</span><br><span class="line">498</span><br><span class="line">499</span><br><span class="line">500</span><br><span class="line">501</span><br><span class="line">502</span><br><span class="line">503</span><br><span class="line">504</span><br><span class="line">505</span><br><span class="line">506</span><br><span class="line">507</span><br><span class="line">508</span><br><span class="line">509</span><br><span class="line">510</span><br><span class="line">511</span><br><span class="line">512</span><br><span class="line">513</span><br><span class="line">514</span><br><span class="line">515</span><br><span class="line">516</span><br><span class="line">517</span><br><span class="line">518</span><br><span class="line">519</span><br><span class="line">520</span><br><span class="line">521</span><br><span class="line">522</span><br><span class="line">523</span><br><span class="line">524</span><br><span class="line">525</span><br><span class="line">526</span><br><span class="line">527</span><br><span class="line">528</span><br><span class="line">529</span><br><span class="line">530</span><br><span class="line">531</span><br><span class="line">532</span><br><span class="line">533</span><br><span class="line">534</span><br><span class="line">535</span><br><span class="line">536</span><br><span class="line">537</span><br><span class="line">538</span><br><span class="line">539</span><br><span class="line">540</span><br><span class="line">541</span><br><span class="line">542</span><br><span class="line">543</span><br><span class="line">544</span><br><span class="line">545</span><br><span class="line">546</span><br><span class="line">547</span><br><span class="line">548</span><br><span class="line">549</span><br><span class="line">550</span><br><span class="line">551</span><br><span class="line">552</span><br><span class="line">553</span><br><span class="line">554</span><br><span class="line">555</span><br><span class="line">556</span><br><span class="line">557</span><br><span class="line">558</span><br><span class="line">559</span><br><span class="line">560</span><br><span class="line">561</span><br><span class="line">562</span><br><span class="line">563</span><br><span class="line">564</span><br><span class="line">565</span><br><span class="line">566</span><br><span class="line">567</span><br><span class="line">568</span><br><span class="line">569</span><br><span class="line">570</span><br><span class="line">571</span><br><span class="line">572</span><br><span class="line">573</span><br><span class="line">574</span><br><span class="line">575</span><br><span class="line">576</span><br><span class="line">577</span><br><span class="line">578</span><br><span class="line">579</span><br><span class="line">580</span><br><span class="line">581</span><br><span class="line">582</span><br><span class="line">583</span><br><span class="line">584</span><br><span class="line">585</span><br><span class="line">586</span><br><span class="line">587</span><br><span class="line">588</span><br><span class="line">589</span><br><span class="line">590</span><br><span class="line">591</span><br><span class="line">592</span><br><span class="line">593</span><br><span class="line">594</span><br><span class="line">595</span><br><span class="line">596</span><br><span class="line">597</span><br><span class="line">598</span><br><span class="line">599</span><br><span class="line">600</span><br><span class="line">601</span><br><span class="line">602</span><br><span class="line">603</span><br><span class="line">604</span><br><span class="line">605</span><br><span class="line">606</span><br><span class="line">607</span><br><span class="line">608</span><br><span class="line">609</span><br><span class="line">610</span><br><span class="line">611</span><br><span class="line">612</span><br><span class="line">613</span><br><span class="line">614</span><br><span class="line">615</span><br><span class="line">616</span><br><span class="line">617</span><br><span class="line">618</span><br><span class="line">619</span><br><span class="line">620</span><br><span class="line">621</span><br><span class="line">622</span><br><span class="line">623</span><br><span class="line">624</span><br><span class="line">625</span><br><span class="line">626</span><br><span class="line">627</span><br><span class="line">628</span><br><span class="line">629</span><br><span class="line">630</span><br><span class="line">631</span><br><span class="line">632</span><br><span class="line">633</span><br><span class="line">634</span><br><span class="line">635</span><br><span class="line">636</span><br><span class="line">637</span><br><span class="line">638</span><br><span class="line">639</span><br><span class="line">640</span><br><span class="line">641</span><br><span class="line">642</span><br><span class="line">643</span><br><span class="line">644</span><br><span class="line">645</span><br><span class="line">646</span><br><span class="line">647</span><br><span class="line">648</span><br><span class="line">649</span><br><span class="line">650</span><br><span class="line">651</span><br><span class="line">652</span><br><span class="line">653</span><br><span class="line">654</span><br><span class="line">655</span><br><span class="line">656</span><br><span class="line">657</span><br><span class="line">658</span><br><span class="line">659</span><br><span class="line">660</span><br><span class="line">661</span><br><span class="line">662</span><br><span class="line">663</span><br><span class="line">664</span><br><span class="line">665</span><br><span class="line">666</span><br><span class="line">667</span><br><span class="line">668</span><br><span class="line">669</span><br><span class="line">670</span><br><span class="line">671</span><br><span class="line">672</span><br><span class="line">673</span><br><span class="line">674</span><br><span class="line">675</span><br><span class="line">676</span><br><span class="line">677</span><br><span class="line">678</span><br><span class="line">679</span><br><span class="line">680</span><br><span class="line">681</span><br><span class="line">682</span><br><span class="line">683</span><br><span class="line">684</span><br><span class="line">685</span><br><span class="line">686</span><br><span class="line">687</span><br><span class="line">688</span><br><span class="line">689</span><br><span class="line">690</span><br><span class="line">691</span><br><span class="line">692</span><br><span class="line">693</span><br><span class="line">694</span><br><span class="line">695</span><br><span class="line">696</span><br><span class="line">697</span><br><span class="line">698</span><br><span class="line">699</span><br><span class="line">700</span><br><span class="line">701</span><br><span class="line">702</span><br><span class="line">703</span><br><span class="line">704</span><br><span class="line">705</span><br><span class="line">706</span><br><span class="line">707</span><br><span class="line">708</span><br><span class="line">709</span><br><span class="line">710</span><br><span class="line">711</span><br><span class="line">712</span><br><span class="line">713</span><br><span class="line">714</span><br><span class="line">715</span><br><span class="line">716</span><br><span class="line">717</span><br><span class="line">718</span><br><span class="line">719</span><br><span class="line">720</span><br><span class="line">721</span><br><span class="line">722</span><br><span class="line">723</span><br><span class="line">724</span><br><span class="line">725</span><br><span class="line">726</span><br><span class="line">727</span><br><span class="line">728</span><br><span class="line">729</span><br><span class="line">730</span><br><span class="line">731</span><br><span class="line">732</span><br><span class="line">733</span><br><span class="line">734</span><br><span class="line">735</span><br><span class="line">736</span><br><span class="line">737</span><br><span class="line">738</span><br><span class="line">739</span><br><span class="line">740</span><br><span class="line">741</span><br><span class="line">742</span><br><span class="line">743</span><br><span class="line">744</span><br><span class="line">745</span><br><span class="line">746</span><br><span class="line">747</span><br><span class="line">748</span><br><span class="line">749</span><br><span class="line">750</span><br><span class="line">751</span><br><span class="line">752</span><br><span class="line">753</span><br><span class="line">754</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> SPDX-License-Identifier: Apache-2.0</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// ====CHAINCODE EXECUTION SAMPLES (CLI) ==================</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// ==== Invoke marbles ====</span></span><br><span class="line"><span class="comment">// peer chaincode invoke -C myc1 -n marbles -c '&#123;"Args":["initMarble","marble1","blue","35","tom"]&#125;'</span></span><br><span class="line"><span class="comment">// peer chaincode invoke -C myc1 -n marbles -c '&#123;"Args":["initMarble","marble2","red","50","tom"]&#125;'</span></span><br><span class="line"><span class="comment">// peer chaincode invoke -C myc1 -n marbles -c '&#123;"Args":["initMarble","marble3","blue","70","tom"]&#125;'</span></span><br><span class="line"><span class="comment">// peer chaincode invoke -C myc1 -n marbles -c '&#123;"Args":["transferMarble","marble2","jerry"]&#125;'</span></span><br><span class="line"><span class="comment">// peer chaincode invoke -C myc1 -n marbles -c '&#123;"Args":["transferMarblesBasedOnColor","blue","jerry"]&#125;'</span></span><br><span class="line"><span class="comment">// peer chaincode invoke -C myc1 -n marbles -c '&#123;"Args":["delete","marble1"]&#125;'</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// ==== Query marbles ====</span></span><br><span class="line"><span class="comment">// peer chaincode query -C myc1 -n marbles -c '&#123;"Args":["readMarble","marble1"]&#125;'</span></span><br><span class="line"><span class="comment">// peer chaincode query -C myc1 -n marbles -c '&#123;"Args":["getMarblesByRange","marble1","marble3"]&#125;'</span></span><br><span class="line"><span class="comment">// peer chaincode query -C myc1 -n marbles -c '&#123;"Args":["getHistoryForMarble","marble1"]&#125;'</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// Rich Query (Only supported if CouchDB is used as state database):</span></span><br><span class="line"><span class="comment">// peer chaincode query -C myc1 -n marbles -c '&#123;"Args":["queryMarblesByOwner","tom"]&#125;'</span></span><br><span class="line"><span class="comment">// peer chaincode query -C myc1 -n marbles -c '&#123;"Args":["queryMarbles","&#123;\"selector\":&#123;\"owner\":\"tom\"&#125;&#125;"]&#125;'</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// Rich Query with Pagination (Only supported if CouchDB is used as state database):</span></span><br><span class="line"><span class="comment">// peer chaincode query -C myc1 -n marbles -c '&#123;"Args":["queryMarblesWithPagination","&#123;\"selector\":&#123;\"owner\":\"tom\"&#125;&#125;","3",""]&#125;'</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// INDEXES TO SUPPORT COUCHDB RICH QUERIES</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// Indexes in CouchDB are required in order to make JSON queries efficient and are required for</span></span><br><span class="line"><span class="comment">// any JSON query with a sort. As of Hyperledger Fabric 1.1, indexes may be packaged alongside</span></span><br><span class="line"><span class="comment">// chaincode in a META-INF/statedb/couchdb/indexes directory. Each index must be defined in its own</span></span><br><span class="line"><span class="comment">// text file with extension *.json with the index definition formatted in JSON following the</span></span><br><span class="line"><span class="comment">// CouchDB index JSON syntax as documented at:</span></span><br><span class="line"><span class="comment">// http://docs.couchdb.org/en/2.1.1/api/database/find.html#db-index</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// This marbles02 example chaincode demonstrates a packaged</span></span><br><span class="line"><span class="comment">// index which you can find in META-INF/statedb/couchdb/indexes/indexOwner.json.</span></span><br><span class="line"><span class="comment">// For deployment of chaincode to production environments, it is recommended</span></span><br><span class="line"><span class="comment">// to define any indexes alongside chaincode so that the chaincode and supporting indexes</span></span><br><span class="line"><span class="comment">// are deployed automatically as a unit, once the chaincode has been installed on a peer and</span></span><br><span class="line"><span class="comment">// instantiated on a channel. See Hyperledger Fabric documentation for more details.</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// If you have access to the your peer's CouchDB state database in a development environment,</span></span><br><span class="line"><span class="comment">// you may want to iteratively test various indexes in support of your chaincode queries.  You</span></span><br><span class="line"><span class="comment">// can use the CouchDB Fauxton interface or a command line curl utility to create and update</span></span><br><span class="line"><span class="comment">// indexes. Then once you finalize an index, include the index definition alongside your</span></span><br><span class="line"><span class="comment">// chaincode in the META-INF/statedb/couchdb/indexes directory, for packaging and deployment</span></span><br><span class="line"><span class="comment">// to managed environments.</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// In the examples below you can find index definitions that support marbles02</span></span><br><span class="line"><span class="comment">// chaincode queries, along with the syntax that you can use in development environments</span></span><br><span class="line"><span class="comment">// to create the indexes in the CouchDB Fauxton interface or a curl command line utility.</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//Example hostname:port configurations to access CouchDB.</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">//To access CouchDB docker container from within another docker container or from vagrant environments:</span></span><br><span class="line"><span class="comment">// http://couchdb:5984/</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">//Inside couchdb docker container</span></span><br><span class="line"><span class="comment">// http://127.0.0.1:5984/</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// Index for docType, owner.</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// Example curl command line to define index in the CouchDB channel_chaincode database</span></span><br><span class="line"><span class="comment">// curl -i -X POST -H "Content-Type: application/json" -d "&#123;\"index\":&#123;\"fields\":[\"docType\",\"owner\"]&#125;,\"name\":\"indexOwner\",\"ddoc\":\"indexOwnerDoc\",\"type\":\"json\"&#125;" http://hostname:port/myc1_marbles/_index</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// Index for docType, owner, size (descending order).</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// Example curl command line to define index in the CouchDB channel_chaincode database</span></span><br><span class="line"><span class="comment">// curl -i -X POST -H "Content-Type: application/json" -d "&#123;\"index\":&#123;\"fields\":[&#123;\"size\":\"desc\"&#125;,&#123;\"docType\":\"desc\"&#125;,&#123;\"owner\":\"desc\"&#125;]&#125;,\"ddoc\":\"indexSizeSortDoc\", \"name\":\"indexSizeSortDesc\",\"type\":\"json\"&#125;" http://hostname:port/myc1_marbles/_index</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// Rich Query with index design doc and index name specified (Only supported if CouchDB is used as state database):</span></span><br><span class="line"><span class="comment">//   peer chaincode query -C myc1 -n marbles -c '&#123;"Args":["queryMarbles","&#123;\"selector\":&#123;\"docType\":\"marble\",\"owner\":\"tom\"&#125;, \"use_index\":[\"_design/indexOwnerDoc\", \"indexOwner\"]&#125;"]&#125;'</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// Rich Query with index design doc specified only (Only supported if CouchDB is used as state database):</span></span><br><span class="line"><span class="comment">//   peer chaincode query -C myc1 -n marbles -c '&#123;"Args":["queryMarbles","&#123;\"selector\":&#123;\"docType\":&#123;\"$eq\":\"marble\"&#125;,\"owner\":&#123;\"$eq\":\"tom\"&#125;,\"size\":&#123;\"$gt\":0&#125;&#125;,\"fields\":[\"docType\",\"owner\",\"size\"],\"sort\":[&#123;\"size\":\"desc\"&#125;],\"use_index\":\"_design/indexSizeSortDoc\"&#125;"]&#125;'</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">	<span class="string">"bytes"</span></span><br><span class="line">	<span class="string">"encoding/json"</span></span><br><span class="line">	<span class="string">"fmt"</span></span><br><span class="line">	<span class="string">"strconv"</span></span><br><span class="line">	<span class="string">"strings"</span></span><br><span class="line">	<span class="string">"time"</span></span><br><span class="line"></span><br><span class="line">	<span class="string">"github.com/hyperledger/fabric/core/chaincode/shim"</span></span><br><span class="line">	pb <span class="string">"github.com/hyperledger/fabric/protos/peer"</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> SimpleChaincode <span class="keyword">struct</span> &#123;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> marble <span class="keyword">struct</span> &#123;</span><br><span class="line">	ObjectType <span class="keyword">string</span> <span class="string">`json:"docType"`</span> <span class="comment">// doctype用于区分状态数据库中的各种对象类型。</span></span><br><span class="line">	Name       <span class="keyword">string</span> <span class="string">`json:"name"`</span>    <span class="comment">// 现场标签是需要的，以防止情况弹来弹去。</span></span><br><span class="line">	Color      <span class="keyword">string</span> <span class="string">`json:"color"`</span></span><br><span class="line">	Size       <span class="keyword">int</span>    <span class="string">`json:"size"`</span></span><br><span class="line">	Owner      <span class="keyword">string</span> <span class="string">`json:"owner"`</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ===================================================================================</span></span><br><span class="line"><span class="comment">// Main</span></span><br><span class="line"><span class="comment">// ===================================================================================</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">	err := shim.Start(<span class="built_in">new</span>(SimpleChaincode))</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		fmt.Printf(<span class="string">"Error starting Simple chaincode: %s"</span>, err)</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Init initializes chaincode</span></span><br><span class="line"><span class="comment">// ===========================</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(t *SimpleChaincode)</span> <span class="title">Init</span><span class="params">(stub shim.ChaincodeStubInterface)</span> <span class="title">pb</span>.<span class="title">Response</span></span> &#123;</span><br><span class="line">	<span class="keyword">return</span> shim.Success(<span class="literal">nil</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Invoke - Our entry point for Invocations</span></span><br><span class="line"><span class="comment">// ========================================</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(t *SimpleChaincode)</span> <span class="title">Invoke</span><span class="params">(stub shim.ChaincodeStubInterface)</span> <span class="title">pb</span>.<span class="title">Response</span></span> &#123;</span><br><span class="line">	function, args := stub.GetFunctionAndParameters()</span><br><span class="line">	fmt.Println(<span class="string">"invoke is running "</span> + function)</span><br><span class="line"></span><br><span class="line">	<span class="comment">// Handle different functions</span></span><br><span class="line">	<span class="keyword">if</span> function == <span class="string">"initMarble"</span> &#123; <span class="comment">//create a new marble</span></span><br><span class="line">		<span class="keyword">return</span> t.initMarble(stub, args)</span><br><span class="line">	&#125; <span class="keyword">else</span> <span class="keyword">if</span> function == <span class="string">"transferMarble"</span> &#123; <span class="comment">//change owner of a specific marble</span></span><br><span class="line">		<span class="keyword">return</span> t.transferMarble(stub, args)</span><br><span class="line">	&#125; <span class="keyword">else</span> <span class="keyword">if</span> function == <span class="string">"transferMarblesBasedOnColor"</span> &#123; <span class="comment">//transfer all marbles of a certain color</span></span><br><span class="line">		<span class="keyword">return</span> t.transferMarblesBasedOnColor(stub, args)</span><br><span class="line">	&#125; <span class="keyword">else</span> <span class="keyword">if</span> function == <span class="string">"delete"</span> &#123; <span class="comment">//delete a marble</span></span><br><span class="line">		<span class="keyword">return</span> t.<span class="built_in">delete</span>(stub, args)</span><br><span class="line">	&#125; <span class="keyword">else</span> <span class="keyword">if</span> function == <span class="string">"readMarble"</span> &#123; <span class="comment">//read a marble</span></span><br><span class="line">		<span class="keyword">return</span> t.readMarble(stub, args)</span><br><span class="line">	&#125; <span class="keyword">else</span> <span class="keyword">if</span> function == <span class="string">"queryMarblesByOwner"</span> &#123; <span class="comment">//find marbles for owner X using rich query</span></span><br><span class="line">		<span class="keyword">return</span> t.queryMarblesByOwner(stub, args)</span><br><span class="line">	&#125; <span class="keyword">else</span> <span class="keyword">if</span> function == <span class="string">"queryMarbles"</span> &#123; <span class="comment">//find marbles based on an ad hoc rich query</span></span><br><span class="line">		<span class="keyword">return</span> t.queryMarbles(stub, args)</span><br><span class="line">	&#125; <span class="keyword">else</span> <span class="keyword">if</span> function == <span class="string">"getHistoryForMarble"</span> &#123; <span class="comment">//get history of values for a marble</span></span><br><span class="line">		<span class="keyword">return</span> t.getHistoryForMarble(stub, args)</span><br><span class="line">	&#125; <span class="keyword">else</span> <span class="keyword">if</span> function == <span class="string">"getMarblesByRange"</span> &#123; <span class="comment">//get marbles based on range query</span></span><br><span class="line">		<span class="keyword">return</span> t.getMarblesByRange(stub, args)</span><br><span class="line">	&#125; <span class="keyword">else</span> <span class="keyword">if</span> function == <span class="string">"getMarblesByRangeWithPagination"</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> t.getMarblesByRangeWithPagination(stub, args)</span><br><span class="line">	&#125; <span class="keyword">else</span> <span class="keyword">if</span> function == <span class="string">"queryMarblesWithPagination"</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> t.queryMarblesWithPagination(stub, args)</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	fmt.Println(<span class="string">"invoke did not find func: "</span> + function) <span class="comment">//error</span></span><br><span class="line">	<span class="keyword">return</span> shim.Error(<span class="string">"Received unknown function invocation"</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ============================================================</span></span><br><span class="line"><span class="comment">// initMarble - create a new marble, store into chaincode state</span></span><br><span class="line"><span class="comment">// ============================================================</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(t *SimpleChaincode)</span> <span class="title">initMarble</span><span class="params">(stub shim.ChaincodeStubInterface, args []<span class="keyword">string</span>)</span> <span class="title">pb</span>.<span class="title">Response</span></span> &#123;</span><br><span class="line">	<span class="keyword">var</span> err error</span><br><span class="line"></span><br><span class="line">	<span class="comment">//   0       1       2     3</span></span><br><span class="line">	<span class="comment">// "asdf", "blue", "35", "bob"</span></span><br><span class="line">	<span class="keyword">if</span> <span class="built_in">len</span>(args) != <span class="number">4</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> shim.Error(<span class="string">"Incorrect number of arguments. Expecting 4"</span>)</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// ==== Input sanitation ====</span></span><br><span class="line">	fmt.Println(<span class="string">"- start init marble"</span>)</span><br><span class="line">	<span class="keyword">if</span> <span class="built_in">len</span>(args[<span class="number">0</span>]) &lt;= <span class="number">0</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> shim.Error(<span class="string">"1st argument must be a non-empty string"</span>)</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">if</span> <span class="built_in">len</span>(args[<span class="number">1</span>]) &lt;= <span class="number">0</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> shim.Error(<span class="string">"2nd argument must be a non-empty string"</span>)</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">if</span> <span class="built_in">len</span>(args[<span class="number">2</span>]) &lt;= <span class="number">0</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> shim.Error(<span class="string">"3rd argument must be a non-empty string"</span>)</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">if</span> <span class="built_in">len</span>(args[<span class="number">3</span>]) &lt;= <span class="number">0</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> shim.Error(<span class="string">"4th argument must be a non-empty string"</span>)</span><br><span class="line">	&#125;</span><br><span class="line">	marbleName := args[<span class="number">0</span>]</span><br><span class="line">	color := strings.ToLower(args[<span class="number">1</span>])</span><br><span class="line">	owner := strings.ToLower(args[<span class="number">3</span>])</span><br><span class="line">	size, err := strconv.Atoi(args[<span class="number">2</span>])</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> shim.Error(<span class="string">"3rd argument must be a numeric string"</span>)</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// ==== Check if marble already exists ====</span></span><br><span class="line">	marbleAsBytes, err := stub.GetState(marbleName)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> shim.Error(<span class="string">"Failed to get marble: "</span> + err.Error())</span><br><span class="line">	&#125; <span class="keyword">else</span> <span class="keyword">if</span> marbleAsBytes != <span class="literal">nil</span> &#123;</span><br><span class="line">		fmt.Println(<span class="string">"This marble already exists: "</span> + marbleName)</span><br><span class="line">		<span class="keyword">return</span> shim.Error(<span class="string">"This marble already exists: "</span> + marbleName)</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// ==== Create marble object and marshal to JSON ====</span></span><br><span class="line">	objectType := <span class="string">"marble"</span></span><br><span class="line">	marble := &amp;marble&#123;objectType, marbleName, color, size, owner&#125;</span><br><span class="line">	marbleJSONasBytes, err := json.Marshal(marble)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> shim.Error(err.Error())</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">//Alternatively, build the marble json string manually if you don't want to use struct marshalling</span></span><br><span class="line">	<span class="comment">//marbleJSONasString := `&#123;"docType":"Marble",  "name": "` + marbleName + `", "color": "` + color + `", "size": ` + strconv.Itoa(size) + `, "owner": "` + owner + `"&#125;`</span></span><br><span class="line">	<span class="comment">//marbleJSONasBytes := []byte(str)</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">// === Save marble to state ===</span></span><br><span class="line">	err = stub.PutState(marbleName, marbleJSONasBytes)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> shim.Error(err.Error())</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">//  ==== Index the marble to enable color-based range queries, e.g. return all blue marbles ====</span></span><br><span class="line">	<span class="comment">//  An 'index' is a normal key/value entry in state.</span></span><br><span class="line">	<span class="comment">//  The key is a composite key, with the elements that you want to range query on listed first.</span></span><br><span class="line">	<span class="comment">//  In our case, the composite key is based on indexName~color~name.</span></span><br><span class="line">	<span class="comment">//  This will enable very efficient state range queries based on composite keys matching indexName~color~*</span></span><br><span class="line">	indexName := <span class="string">"color~name"</span></span><br><span class="line">	colorNameIndexKey, err := stub.CreateCompositeKey(indexName, []<span class="keyword">string</span>&#123;marble.Color, marble.Name&#125;)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> shim.Error(err.Error())</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">//  Save index entry to state. Only the key name is needed, no need to store a duplicate copy of the marble.</span></span><br><span class="line">	<span class="comment">//  Note - passing a 'nil' value will effectively delete the key from state, therefore we pass null character as value</span></span><br><span class="line">	value := []<span class="keyword">byte</span>&#123;<span class="number">0x00</span>&#125;</span><br><span class="line">	stub.PutState(colorNameIndexKey, value)</span><br><span class="line"></span><br><span class="line">	<span class="comment">// ==== Marble saved and indexed. Return success ====</span></span><br><span class="line">	fmt.Println(<span class="string">"- end init marble"</span>)</span><br><span class="line">	<span class="keyword">return</span> shim.Success(<span class="literal">nil</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ===============================================</span></span><br><span class="line"><span class="comment">// readMarble - read a marble from chaincode state</span></span><br><span class="line"><span class="comment">// ===============================================</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(t *SimpleChaincode)</span> <span class="title">readMarble</span><span class="params">(stub shim.ChaincodeStubInterface, args []<span class="keyword">string</span>)</span> <span class="title">pb</span>.<span class="title">Response</span></span> &#123;</span><br><span class="line">	<span class="keyword">var</span> name, jsonResp <span class="keyword">string</span></span><br><span class="line">	<span class="keyword">var</span> err error</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> <span class="built_in">len</span>(args) != <span class="number">1</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> shim.Error(<span class="string">"Incorrect number of arguments. Expecting name of the marble to query"</span>)</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	name = args[<span class="number">0</span>]</span><br><span class="line">	valAsbytes, err := stub.GetState(name) <span class="comment">//get the marble from chaincode state</span></span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		jsonResp = <span class="string">"&#123;\"Error\":\"Failed to get state for "</span> + name + <span class="string">"\"&#125;"</span></span><br><span class="line">		<span class="keyword">return</span> shim.Error(jsonResp)</span><br><span class="line">	&#125; <span class="keyword">else</span> <span class="keyword">if</span> valAsbytes == <span class="literal">nil</span> &#123;</span><br><span class="line">		jsonResp = <span class="string">"&#123;\"Error\":\"Marble does not exist: "</span> + name + <span class="string">"\"&#125;"</span></span><br><span class="line">		<span class="keyword">return</span> shim.Error(jsonResp)</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> shim.Success(valAsbytes)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ==================================================</span></span><br><span class="line"><span class="comment">// delete - remove a marble key/value pair from state</span></span><br><span class="line"><span class="comment">// ==================================================</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(t *SimpleChaincode)</span> <span class="title">delete</span><span class="params">(stub shim.ChaincodeStubInterface, args []<span class="keyword">string</span>)</span> <span class="title">pb</span>.<span class="title">Response</span></span> &#123;</span><br><span class="line">	<span class="keyword">var</span> jsonResp <span class="keyword">string</span></span><br><span class="line">	<span class="keyword">var</span> marbleJSON marble</span><br><span class="line">	<span class="keyword">if</span> <span class="built_in">len</span>(args) != <span class="number">1</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> shim.Error(<span class="string">"Incorrect number of arguments. Expecting 1"</span>)</span><br><span class="line">	&#125;</span><br><span class="line">	marbleName := args[<span class="number">0</span>]</span><br><span class="line"></span><br><span class="line">	<span class="comment">// to maintain the color~name index, we need to read the marble first and get its color</span></span><br><span class="line">	valAsbytes, err := stub.GetState(marbleName) <span class="comment">//get the marble from chaincode state</span></span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		jsonResp = <span class="string">"&#123;\"Error\":\"Failed to get state for "</span> + marbleName + <span class="string">"\"&#125;"</span></span><br><span class="line">		<span class="keyword">return</span> shim.Error(jsonResp)</span><br><span class="line">	&#125; <span class="keyword">else</span> <span class="keyword">if</span> valAsbytes == <span class="literal">nil</span> &#123;</span><br><span class="line">		jsonResp = <span class="string">"&#123;\"Error\":\"Marble does not exist: "</span> + marbleName + <span class="string">"\"&#125;"</span></span><br><span class="line">		<span class="keyword">return</span> shim.Error(jsonResp)</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	err = json.Unmarshal([]<span class="keyword">byte</span>(valAsbytes), &amp;marbleJSON)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		jsonResp = <span class="string">"&#123;\"Error\":\"Failed to decode JSON of: "</span> + marbleName + <span class="string">"\"&#125;"</span></span><br><span class="line">		<span class="keyword">return</span> shim.Error(jsonResp)</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	err = stub.DelState(marbleName) <span class="comment">//remove the marble from chaincode state</span></span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> shim.Error(<span class="string">"Failed to delete state:"</span> + err.Error())</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// maintain the index</span></span><br><span class="line">	indexName := <span class="string">"color~name"</span></span><br><span class="line">	colorNameIndexKey, err := stub.CreateCompositeKey(indexName, []<span class="keyword">string</span>&#123;marbleJSON.Color, marbleJSON.Name&#125;)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> shim.Error(err.Error())</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">//  Delete index entry to state.</span></span><br><span class="line">	err = stub.DelState(colorNameIndexKey)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> shim.Error(<span class="string">"Failed to delete state:"</span> + err.Error())</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> shim.Success(<span class="literal">nil</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ===========================================================</span></span><br><span class="line"><span class="comment">// transfer a marble by setting a new owner name on the marble</span></span><br><span class="line"><span class="comment">// ===========================================================</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(t *SimpleChaincode)</span> <span class="title">transferMarble</span><span class="params">(stub shim.ChaincodeStubInterface, args []<span class="keyword">string</span>)</span> <span class="title">pb</span>.<span class="title">Response</span></span> &#123;</span><br><span class="line"></span><br><span class="line">	<span class="comment">//   0       1</span></span><br><span class="line">	<span class="comment">// "name", "bob"</span></span><br><span class="line">	<span class="keyword">if</span> <span class="built_in">len</span>(args) &lt; <span class="number">2</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> shim.Error(<span class="string">"Incorrect number of arguments. Expecting 2"</span>)</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	marbleName := args[<span class="number">0</span>]</span><br><span class="line">	newOwner := strings.ToLower(args[<span class="number">1</span>])</span><br><span class="line">	fmt.Println(<span class="string">"- start transferMarble "</span>, marbleName, newOwner)</span><br><span class="line"></span><br><span class="line">	marbleAsBytes, err := stub.GetState(marbleName)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> shim.Error(<span class="string">"Failed to get marble:"</span> + err.Error())</span><br><span class="line">	&#125; <span class="keyword">else</span> <span class="keyword">if</span> marbleAsBytes == <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> shim.Error(<span class="string">"Marble does not exist"</span>)</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	marbleToTransfer := marble&#123;&#125;</span><br><span class="line">	err = json.Unmarshal(marbleAsBytes, &amp;marbleToTransfer) <span class="comment">//unmarshal it aka JSON.parse()</span></span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> shim.Error(err.Error())</span><br><span class="line">	&#125;</span><br><span class="line">	marbleToTransfer.Owner = newOwner <span class="comment">//change the owner</span></span><br><span class="line"></span><br><span class="line">	marbleJSONasBytes, _ := json.Marshal(marbleToTransfer)</span><br><span class="line">	err = stub.PutState(marbleName, marbleJSONasBytes) <span class="comment">//rewrite the marble</span></span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> shim.Error(err.Error())</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	fmt.Println(<span class="string">"- end transferMarble (success)"</span>)</span><br><span class="line">	<span class="keyword">return</span> shim.Success(<span class="literal">nil</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ===========================================================================================</span></span><br><span class="line"><span class="comment">// constructQueryResponseFromIterator constructs a JSON array containing query results from</span></span><br><span class="line"><span class="comment">// a given result iterator</span></span><br><span class="line"><span class="comment">// ===========================================================================================</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">constructQueryResponseFromIterator</span><span class="params">(resultsIterator shim.StateQueryIteratorInterface)</span> <span class="params">(*bytes.Buffer, error)</span></span> &#123;</span><br><span class="line">	<span class="comment">// buffer is a JSON array containing QueryResults</span></span><br><span class="line">	<span class="keyword">var</span> buffer bytes.Buffer</span><br><span class="line">	buffer.WriteString(<span class="string">"["</span>)</span><br><span class="line"></span><br><span class="line">	bArrayMemberAlreadyWritten := <span class="literal">false</span></span><br><span class="line">	<span class="keyword">for</span> resultsIterator.HasNext() &#123;</span><br><span class="line">		queryResponse, err := resultsIterator.Next()</span><br><span class="line">		<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">			<span class="keyword">return</span> <span class="literal">nil</span>, err</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="comment">// Add a comma before array members, suppress it for the first array member</span></span><br><span class="line">		<span class="keyword">if</span> bArrayMemberAlreadyWritten == <span class="literal">true</span> &#123;</span><br><span class="line">			buffer.WriteString(<span class="string">","</span>)</span><br><span class="line">		&#125;</span><br><span class="line">		buffer.WriteString(<span class="string">"&#123;\"Key\":"</span>)</span><br><span class="line">		buffer.WriteString(<span class="string">"\""</span>)</span><br><span class="line">		buffer.WriteString(queryResponse.Key)</span><br><span class="line">		buffer.WriteString(<span class="string">"\""</span>)</span><br><span class="line"></span><br><span class="line">		buffer.WriteString(<span class="string">", \"Record\":"</span>)</span><br><span class="line">		<span class="comment">// Record is a JSON object, so we write as-is</span></span><br><span class="line">		buffer.WriteString(<span class="keyword">string</span>(queryResponse.Value))</span><br><span class="line">		buffer.WriteString(<span class="string">"&#125;"</span>)</span><br><span class="line">		bArrayMemberAlreadyWritten = <span class="literal">true</span></span><br><span class="line">	&#125;</span><br><span class="line">	buffer.WriteString(<span class="string">"]"</span>)</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> &amp;buffer, <span class="literal">nil</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ===========================================================================================</span></span><br><span class="line"><span class="comment">// addPaginationMetadataToQueryResults adds QueryResponseMetadata, which contains pagination</span></span><br><span class="line"><span class="comment">// info, to the constructed query results</span></span><br><span class="line"><span class="comment">// ===========================================================================================</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">addPaginationMetadataToQueryResults</span><span class="params">(buffer *bytes.Buffer, responseMetadata *pb.QueryResponseMetadata)</span> *<span class="title">bytes</span>.<span class="title">Buffer</span></span> &#123;</span><br><span class="line"></span><br><span class="line">	buffer.WriteString(<span class="string">"[&#123;\"ResponseMetadata\":&#123;\"RecordsCount\":"</span>)</span><br><span class="line">	buffer.WriteString(<span class="string">"\""</span>)</span><br><span class="line">	buffer.WriteString(fmt.Sprintf(<span class="string">"%v"</span>, responseMetadata.FetchedRecordsCount))</span><br><span class="line">	buffer.WriteString(<span class="string">"\""</span>)</span><br><span class="line">	buffer.WriteString(<span class="string">", \"Bookmark\":"</span>)</span><br><span class="line">	buffer.WriteString(<span class="string">"\""</span>)</span><br><span class="line">	buffer.WriteString(responseMetadata.Bookmark)</span><br><span class="line">	buffer.WriteString(<span class="string">"\"&#125;&#125;]"</span>)</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> buffer</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ===========================================================================================</span></span><br><span class="line"><span class="comment">// getMarblesByRange performs a range query based on the start and end keys provided.</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// Read-only function results are not typically submitted to ordering. If the read-only</span></span><br><span class="line"><span class="comment">// results are submitted to ordering, or if the query is used in an update transaction</span></span><br><span class="line"><span class="comment">// and submitted to ordering, then the committing peers will re-execute to guarantee that</span></span><br><span class="line"><span class="comment">// result sets are stable between endorsement time and commit time. The transaction is</span></span><br><span class="line"><span class="comment">// invalidated by the committing peers if the result set has changed between endorsement</span></span><br><span class="line"><span class="comment">// time and commit time.</span></span><br><span class="line"><span class="comment">// Therefore, range queries are a safe option for performing update transactions based on query results.</span></span><br><span class="line"><span class="comment">// ===========================================================================================</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(t *SimpleChaincode)</span> <span class="title">getMarblesByRange</span><span class="params">(stub shim.ChaincodeStubInterface, args []<span class="keyword">string</span>)</span> <span class="title">pb</span>.<span class="title">Response</span></span> &#123;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> <span class="built_in">len</span>(args) &lt; <span class="number">2</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> shim.Error(<span class="string">"Incorrect number of arguments. Expecting 2"</span>)</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	startKey := args[<span class="number">0</span>]</span><br><span class="line">	endKey := args[<span class="number">1</span>]</span><br><span class="line"></span><br><span class="line">	resultsIterator, err := stub.GetStateByRange(startKey, endKey)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> shim.Error(err.Error())</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">defer</span> resultsIterator.Close()</span><br><span class="line"></span><br><span class="line">	buffer, err := constructQueryResponseFromIterator(resultsIterator)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> shim.Error(err.Error())</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	fmt.Printf(<span class="string">"- getMarblesByRange queryResult:\n%s\n"</span>, buffer.String())</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> shim.Success(buffer.Bytes())</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ==== Example: GetStateByPartialCompositeKey/RangeQuery =========================================</span></span><br><span class="line"><span class="comment">// transferMarblesBasedOnColor will transfer marbles of a given color to a certain new owner.</span></span><br><span class="line"><span class="comment">// Uses a GetStateByPartialCompositeKey (range query) against color~name 'index'.</span></span><br><span class="line"><span class="comment">// Committing peers will re-execute range queries to guarantee that result sets are stable</span></span><br><span class="line"><span class="comment">// between endorsement time and commit time. The transaction is invalidated by the</span></span><br><span class="line"><span class="comment">// committing peers if the result set has changed between endorsement time and commit time.</span></span><br><span class="line"><span class="comment">// Therefore, range queries are a safe option for performing update transactions based on query results.</span></span><br><span class="line"><span class="comment">// ===========================================================================================</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(t *SimpleChaincode)</span> <span class="title">transferMarblesBasedOnColor</span><span class="params">(stub shim.ChaincodeStubInterface, args []<span class="keyword">string</span>)</span> <span class="title">pb</span>.<span class="title">Response</span></span> &#123;</span><br><span class="line"></span><br><span class="line">	<span class="comment">//   0       1</span></span><br><span class="line">	<span class="comment">// "color", "bob"</span></span><br><span class="line">	<span class="keyword">if</span> <span class="built_in">len</span>(args) &lt; <span class="number">2</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> shim.Error(<span class="string">"Incorrect number of arguments. Expecting 2"</span>)</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	color := args[<span class="number">0</span>]</span><br><span class="line">	newOwner := strings.ToLower(args[<span class="number">1</span>])</span><br><span class="line">	fmt.Println(<span class="string">"- start transferMarblesBasedOnColor "</span>, color, newOwner)</span><br><span class="line"></span><br><span class="line">	<span class="comment">// Query the color~name index by color</span></span><br><span class="line">	<span class="comment">// This will execute a key range query on all keys starting with 'color'</span></span><br><span class="line">	coloredMarbleResultsIterator, err := stub.GetStateByPartialCompositeKey(<span class="string">"color~name"</span>, []<span class="keyword">string</span>&#123;color&#125;)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> shim.Error(err.Error())</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">defer</span> coloredMarbleResultsIterator.Close()</span><br><span class="line"></span><br><span class="line">	<span class="comment">// Iterate through result set and for each marble found, transfer to newOwner</span></span><br><span class="line">	<span class="keyword">var</span> i <span class="keyword">int</span></span><br><span class="line">	<span class="keyword">for</span> i = <span class="number">0</span>; coloredMarbleResultsIterator.HasNext(); i++ &#123;</span><br><span class="line">		<span class="comment">// Note that we don't get the value (2nd return variable), we'll just get the marble name from the composite key</span></span><br><span class="line">		responseRange, err := coloredMarbleResultsIterator.Next()</span><br><span class="line">		<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">			<span class="keyword">return</span> shim.Error(err.Error())</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="comment">// get the color and name from color~name composite key</span></span><br><span class="line">		objectType, compositeKeyParts, err := stub.SplitCompositeKey(responseRange.Key)</span><br><span class="line">		<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">			<span class="keyword">return</span> shim.Error(err.Error())</span><br><span class="line">		&#125;</span><br><span class="line">		returnedColor := compositeKeyParts[<span class="number">0</span>]</span><br><span class="line">		returnedMarbleName := compositeKeyParts[<span class="number">1</span>]</span><br><span class="line">		fmt.Printf(<span class="string">"- found a marble from index:%s color:%s name:%s\n"</span>, objectType, returnedColor, returnedMarbleName)</span><br><span class="line"></span><br><span class="line">		<span class="comment">// Now call the transfer function for the found marble.</span></span><br><span class="line">		<span class="comment">// Re-use the same function that is used to transfer individual marbles</span></span><br><span class="line">		response := t.transferMarble(stub, []<span class="keyword">string</span>&#123;returnedMarbleName, newOwner&#125;)</span><br><span class="line">		<span class="comment">// if the transfer failed break out of loop and return error</span></span><br><span class="line">		<span class="keyword">if</span> response.Status != shim.OK &#123;</span><br><span class="line">			<span class="keyword">return</span> shim.Error(<span class="string">"Transfer failed: "</span> + response.Message)</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	responsePayload := fmt.Sprintf(<span class="string">"Transferred %d %s marbles to %s"</span>, i, color, newOwner)</span><br><span class="line">	fmt.Println(<span class="string">"- end transferMarblesBasedOnColor: "</span> + responsePayload)</span><br><span class="line">	<span class="keyword">return</span> shim.Success([]<span class="keyword">byte</span>(responsePayload))</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// =======Rich queries =========================================================================</span></span><br><span class="line"><span class="comment">// Two examples of rich queries are provided below (parameterized query and ad hoc query).</span></span><br><span class="line"><span class="comment">// Rich queries pass a query string to the state database.</span></span><br><span class="line"><span class="comment">// Rich queries are only supported by state database implementations</span></span><br><span class="line"><span class="comment">//  that support rich query (e.g. CouchDB).</span></span><br><span class="line"><span class="comment">// The query string is in the syntax of the underlying state database.</span></span><br><span class="line"><span class="comment">// With rich queries there is no guarantee that the result set hasn't changed between</span></span><br><span class="line"><span class="comment">//  endorsement time and commit time, aka 'phantom reads'.</span></span><br><span class="line"><span class="comment">// Therefore, rich queries should not be used in update transactions, unless the</span></span><br><span class="line"><span class="comment">// application handles the possibility of result set changes between endorsement and commit time.</span></span><br><span class="line"><span class="comment">// Rich queries can be used for point-in-time queries against a peer.</span></span><br><span class="line"><span class="comment">// ============================================================================================</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// ===== Example: Parameterized rich query =================================================</span></span><br><span class="line"><span class="comment">// queryMarblesByOwner queries for marbles based on a passed in owner.</span></span><br><span class="line"><span class="comment">// This is an example of a parameterized query where the query logic is baked into the chaincode,</span></span><br><span class="line"><span class="comment">// and accepting a single query parameter (owner).</span></span><br><span class="line"><span class="comment">// Only available on state databases that support rich query (e.g. CouchDB)</span></span><br><span class="line"><span class="comment">// =========================================================================================</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(t *SimpleChaincode)</span> <span class="title">queryMarblesByOwner</span><span class="params">(stub shim.ChaincodeStubInterface, args []<span class="keyword">string</span>)</span> <span class="title">pb</span>.<span class="title">Response</span></span> &#123;</span><br><span class="line"></span><br><span class="line">	<span class="comment">//   0</span></span><br><span class="line">	<span class="comment">// "bob"</span></span><br><span class="line">	<span class="keyword">if</span> <span class="built_in">len</span>(args) &lt; <span class="number">1</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> shim.Error(<span class="string">"Incorrect number of arguments. Expecting 1"</span>)</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	owner := strings.ToLower(args[<span class="number">0</span>])</span><br><span class="line"></span><br><span class="line">	queryString := fmt.Sprintf(<span class="string">"&#123;\"selector\":&#123;\"docType\":\"marble\",\"owner\":\"%s\"&#125;&#125;"</span>, owner)</span><br><span class="line"></span><br><span class="line">	queryResults, err := getQueryResultForQueryString(stub, queryString)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> shim.Error(err.Error())</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> shim.Success(queryResults)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ===== Example: Ad hoc rich query ========================================================</span></span><br><span class="line"><span class="comment">// queryMarbles uses a query string to perform a query for marbles.</span></span><br><span class="line"><span class="comment">// Query string matching state database syntax is passed in and executed as is.</span></span><br><span class="line"><span class="comment">// Supports ad hoc queries that can be defined at runtime by the client.</span></span><br><span class="line"><span class="comment">// If this is not desired, follow the queryMarblesForOwner example for parameterized queries.</span></span><br><span class="line"><span class="comment">// Only available on state databases that support rich query (e.g. CouchDB)</span></span><br><span class="line"><span class="comment">// =========================================================================================</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(t *SimpleChaincode)</span> <span class="title">queryMarbles</span><span class="params">(stub shim.ChaincodeStubInterface, args []<span class="keyword">string</span>)</span> <span class="title">pb</span>.<span class="title">Response</span></span> &#123;</span><br><span class="line"></span><br><span class="line">	<span class="comment">//   0</span></span><br><span class="line">	<span class="comment">// "queryString"</span></span><br><span class="line">	<span class="keyword">if</span> <span class="built_in">len</span>(args) &lt; <span class="number">1</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> shim.Error(<span class="string">"Incorrect number of arguments. Expecting 1"</span>)</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	queryString := args[<span class="number">0</span>]</span><br><span class="line"></span><br><span class="line">	queryResults, err := getQueryResultForQueryString(stub, queryString)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> shim.Error(err.Error())</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> shim.Success(queryResults)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// =========================================================================================</span></span><br><span class="line"><span class="comment">// getQueryResultForQueryString executes the passed in query string.</span></span><br><span class="line"><span class="comment">// Result set is built and returned as a byte array containing the JSON results.</span></span><br><span class="line"><span class="comment">// =========================================================================================</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">getQueryResultForQueryString</span><span class="params">(stub shim.ChaincodeStubInterface, queryString <span class="keyword">string</span>)</span> <span class="params">([]<span class="keyword">byte</span>, error)</span></span> &#123;</span><br><span class="line"></span><br><span class="line">	fmt.Printf(<span class="string">"- getQueryResultForQueryString queryString:\n%s\n"</span>, queryString)</span><br><span class="line"></span><br><span class="line">	resultsIterator, err := stub.GetQueryResult(queryString)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">nil</span>, err</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">defer</span> resultsIterator.Close()</span><br><span class="line"></span><br><span class="line">	buffer, err := constructQueryResponseFromIterator(resultsIterator)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">nil</span>, err</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	fmt.Printf(<span class="string">"- getQueryResultForQueryString queryResult:\n%s\n"</span>, buffer.String())</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> buffer.Bytes(), <span class="literal">nil</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ====== Pagination =========================================================================</span></span><br><span class="line"><span class="comment">// Pagination provides a method to retrieve records with a defined pagesize and</span></span><br><span class="line"><span class="comment">// start point (bookmark).  An empty string bookmark defines the first "page" of a query</span></span><br><span class="line"><span class="comment">// result.  Paginated queries return a bookmark that can be used in</span></span><br><span class="line"><span class="comment">// the next query to retrieve the next page of results.  Paginated queries extend</span></span><br><span class="line"><span class="comment">// rich queries and range queries to include a pagesize and bookmark.</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// Two examples are provided in this example.  The first is getMarblesByRangeWithPagination</span></span><br><span class="line"><span class="comment">// which executes a paginated range query.</span></span><br><span class="line"><span class="comment">// The second example is a paginated query for rich ad-hoc queries.</span></span><br><span class="line"><span class="comment">// =========================================================================================</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// ====== Example: Pagination with Range Query ===============================================</span></span><br><span class="line"><span class="comment">// getMarblesByRangeWithPagination performs a range query based on the start &amp; end key,</span></span><br><span class="line"><span class="comment">// page size and a bookmark.</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// The number of fetched records will be equal to or lesser than the page size.</span></span><br><span class="line"><span class="comment">// Paginated range queries are only valid for read only transactions.</span></span><br><span class="line"><span class="comment">// ===========================================================================================</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(t *SimpleChaincode)</span> <span class="title">getMarblesByRangeWithPagination</span><span class="params">(stub shim.ChaincodeStubInterface, args []<span class="keyword">string</span>)</span> <span class="title">pb</span>.<span class="title">Response</span></span> &#123;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> <span class="built_in">len</span>(args) &lt; <span class="number">4</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> shim.Error(<span class="string">"Incorrect number of arguments. Expecting 4"</span>)</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	startKey := args[<span class="number">0</span>]</span><br><span class="line">	endKey := args[<span class="number">1</span>]</span><br><span class="line">	<span class="comment">//return type of ParseInt is int64</span></span><br><span class="line">	pageSize, err := strconv.ParseInt(args[<span class="number">2</span>], <span class="number">10</span>, <span class="number">32</span>)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> shim.Error(err.Error())</span><br><span class="line">	&#125;</span><br><span class="line">	bookmark := args[<span class="number">3</span>]</span><br><span class="line"></span><br><span class="line">	resultsIterator, responseMetadata, err := stub.GetStateByRangeWithPagination(startKey, endKey, <span class="keyword">int32</span>(pageSize), bookmark)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> shim.Error(err.Error())</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">defer</span> resultsIterator.Close()</span><br><span class="line"></span><br><span class="line">	buffer, err := constructQueryResponseFromIterator(resultsIterator)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> shim.Error(err.Error())</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	bufferWithPaginationInfo := addPaginationMetadataToQueryResults(buffer, responseMetadata)</span><br><span class="line"></span><br><span class="line">	fmt.Printf(<span class="string">"- getMarblesByRange queryResult:\n%s\n"</span>, bufferWithPaginationInfo.String())</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> shim.Success(buffer.Bytes())</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ===== Example: Pagination with Ad hoc Rich Query ========================================================</span></span><br><span class="line"><span class="comment">// queryMarblesWithPagination uses a query string, page size and a bookmark to perform a query</span></span><br><span class="line"><span class="comment">// for marbles. Query string matching state database syntax is passed in and executed as is.</span></span><br><span class="line"><span class="comment">// The number of fetched records would be equal to or lesser than the specified page size.</span></span><br><span class="line"><span class="comment">// Supports ad hoc queries that can be defined at runtime by the client.</span></span><br><span class="line"><span class="comment">// If this is not desired, follow the queryMarblesForOwner example for parameterized queries.</span></span><br><span class="line"><span class="comment">// Only available on state databases that support rich query (e.g. CouchDB)</span></span><br><span class="line"><span class="comment">// Paginated queries are only valid for read only transactions.</span></span><br><span class="line"><span class="comment">// =========================================================================================</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(t *SimpleChaincode)</span> <span class="title">queryMarblesWithPagination</span><span class="params">(stub shim.ChaincodeStubInterface, args []<span class="keyword">string</span>)</span> <span class="title">pb</span>.<span class="title">Response</span></span> &#123;</span><br><span class="line"></span><br><span class="line">	<span class="comment">//   0</span></span><br><span class="line">	<span class="comment">// "queryString"</span></span><br><span class="line">	<span class="keyword">if</span> <span class="built_in">len</span>(args) &lt; <span class="number">3</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> shim.Error(<span class="string">"Incorrect number of arguments. Expecting 3"</span>)</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	queryString := args[<span class="number">0</span>]</span><br><span class="line">	<span class="comment">//return type of ParseInt is int64</span></span><br><span class="line">	pageSize, err := strconv.ParseInt(args[<span class="number">1</span>], <span class="number">10</span>, <span class="number">32</span>)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> shim.Error(err.Error())</span><br><span class="line">	&#125;</span><br><span class="line">	bookmark := args[<span class="number">2</span>]</span><br><span class="line"></span><br><span class="line">	queryResults, err := getQueryResultForQueryStringWithPagination(stub, queryString, <span class="keyword">int32</span>(pageSize), bookmark)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> shim.Error(err.Error())</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> shim.Success(queryResults)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// =========================================================================================</span></span><br><span class="line"><span class="comment">// getQueryResultForQueryStringWithPagination executes the passed in query string with</span></span><br><span class="line"><span class="comment">// pagination info. Result set is built and returned as a byte array containing the JSON results.</span></span><br><span class="line"><span class="comment">// =========================================================================================</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">getQueryResultForQueryStringWithPagination</span><span class="params">(stub shim.ChaincodeStubInterface, queryString <span class="keyword">string</span>, pageSize <span class="keyword">int32</span>, bookmark <span class="keyword">string</span>)</span> <span class="params">([]<span class="keyword">byte</span>, error)</span></span> &#123;</span><br><span class="line"></span><br><span class="line">	fmt.Printf(<span class="string">"- getQueryResultForQueryString queryString:\n%s\n"</span>, queryString)</span><br><span class="line"></span><br><span class="line">	resultsIterator, responseMetadata, err := stub.GetQueryResultWithPagination(queryString, pageSize, bookmark)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">nil</span>, err</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">defer</span> resultsIterator.Close()</span><br><span class="line"></span><br><span class="line">	buffer, err := constructQueryResponseFromIterator(resultsIterator)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">nil</span>, err</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	bufferWithPaginationInfo := addPaginationMetadataToQueryResults(buffer, responseMetadata)</span><br><span class="line"></span><br><span class="line">	fmt.Printf(<span class="string">"- getQueryResultForQueryString queryResult:\n%s\n"</span>, bufferWithPaginationInfo.String())</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> buffer.Bytes(), <span class="literal">nil</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 获得历史数据</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(t *SimpleChaincode)</span> <span class="title">getHistoryForMarble</span><span class="params">(stub shim.ChaincodeStubInterface, args []<span class="keyword">string</span>)</span> <span class="title">pb</span>.<span class="title">Response</span></span> &#123;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> <span class="built_in">len</span>(args) &lt; <span class="number">1</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> shim.Error(<span class="string">"Incorrect number of arguments. Expecting 1"</span>)</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	marbleName := args[<span class="number">0</span>]</span><br><span class="line"></span><br><span class="line">	fmt.Printf(<span class="string">"- start getHistoryForMarble: %s\n"</span>, marbleName)</span><br><span class="line"></span><br><span class="line">	resultsIterator, err := stub.GetHistoryForKey(marbleName)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> shim.Error(err.Error())</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">defer</span> resultsIterator.Close()</span><br><span class="line"></span><br><span class="line">	<span class="comment">// buffer is a JSON array containing historic values for the marble</span></span><br><span class="line">	<span class="keyword">var</span> buffer bytes.Buffer</span><br><span class="line">	buffer.WriteString(<span class="string">"["</span>)</span><br><span class="line"></span><br><span class="line">	bArrayMemberAlreadyWritten := <span class="literal">false</span></span><br><span class="line">	<span class="keyword">for</span> resultsIterator.HasNext() &#123;</span><br><span class="line">		response, err := resultsIterator.Next()</span><br><span class="line">		<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">			<span class="keyword">return</span> shim.Error(err.Error())</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="comment">// Add a comma before array members, suppress it for the first array member</span></span><br><span class="line">		<span class="keyword">if</span> bArrayMemberAlreadyWritten == <span class="literal">true</span> &#123;</span><br><span class="line">			buffer.WriteString(<span class="string">","</span>)</span><br><span class="line">		&#125;</span><br><span class="line">		buffer.WriteString(<span class="string">"&#123;\"TxId\":"</span>)</span><br><span class="line">		buffer.WriteString(<span class="string">"\""</span>)</span><br><span class="line">		buffer.WriteString(response.TxId)</span><br><span class="line">		buffer.WriteString(<span class="string">"\""</span>)</span><br><span class="line"></span><br><span class="line">		buffer.WriteString(<span class="string">", \"Value\":"</span>)</span><br><span class="line">		<span class="comment">// if it was a delete operation on given key, then we need to set the</span></span><br><span class="line">		<span class="comment">//corresponding value null. Else, we will write the response.Value</span></span><br><span class="line">		<span class="comment">//as-is (as the Value itself a JSON marble)</span></span><br><span class="line">		<span class="keyword">if</span> response.IsDelete &#123;</span><br><span class="line">			buffer.WriteString(<span class="string">"null"</span>)</span><br><span class="line">		&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">			buffer.WriteString(<span class="keyword">string</span>(response.Value))</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		buffer.WriteString(<span class="string">", \"Timestamp\":"</span>)</span><br><span class="line">		buffer.WriteString(<span class="string">"\""</span>)</span><br><span class="line">		buffer.WriteString(time.Unix(response.Timestamp.Seconds, <span class="keyword">int64</span>(response.Timestamp.Nanos)).String())</span><br><span class="line">		buffer.WriteString(<span class="string">"\""</span>)</span><br><span class="line"></span><br><span class="line">		buffer.WriteString(<span class="string">", \"IsDelete\":"</span>)</span><br><span class="line">		buffer.WriteString(<span class="string">"\""</span>)</span><br><span class="line">		buffer.WriteString(strconv.FormatBool(response.IsDelete))</span><br><span class="line">		buffer.WriteString(<span class="string">"\""</span>)</span><br><span class="line"></span><br><span class="line">		buffer.WriteString(<span class="string">"&#125;"</span>)</span><br><span class="line">		bArrayMemberAlreadyWritten = <span class="literal">true</span></span><br><span class="line">	&#125;</span><br><span class="line">	buffer.WriteString(<span class="string">"]"</span>)</span><br><span class="line"></span><br><span class="line">	fmt.Printf(<span class="string">"- getHistoryForMarble returning:\n%s\n"</span>, buffer.String())</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> shim.Success(buffer.Bytes())</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="marbles02-private-弹珠资产管理链码"><a href="#marbles02-private-弹珠资产管理链码" class="headerlink" title="marbles02_private(弹珠资产管理链码)"></a>marbles02_private(弹珠资产管理链码)</h5><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br><span class="line">426</span><br><span class="line">427</span><br><span class="line">428</span><br><span class="line">429</span><br><span class="line">430</span><br><span class="line">431</span><br><span class="line">432</span><br><span class="line">433</span><br><span class="line">434</span><br><span class="line">435</span><br><span class="line">436</span><br><span class="line">437</span><br><span class="line">438</span><br><span class="line">439</span><br><span class="line">440</span><br><span class="line">441</span><br><span class="line">442</span><br><span class="line">443</span><br><span class="line">444</span><br><span class="line">445</span><br><span class="line">446</span><br><span class="line">447</span><br><span class="line">448</span><br><span class="line">449</span><br><span class="line">450</span><br><span class="line">451</span><br><span class="line">452</span><br><span class="line">453</span><br><span class="line">454</span><br><span class="line">455</span><br><span class="line">456</span><br><span class="line">457</span><br><span class="line">458</span><br><span class="line">459</span><br><span class="line">460</span><br><span class="line">461</span><br><span class="line">462</span><br><span class="line">463</span><br><span class="line">464</span><br><span class="line">465</span><br><span class="line">466</span><br><span class="line">467</span><br><span class="line">468</span><br><span class="line">469</span><br><span class="line">470</span><br><span class="line">471</span><br><span class="line">472</span><br><span class="line">473</span><br><span class="line">474</span><br><span class="line">475</span><br><span class="line">476</span><br><span class="line">477</span><br><span class="line">478</span><br><span class="line">479</span><br><span class="line">480</span><br><span class="line">481</span><br><span class="line">482</span><br><span class="line">483</span><br><span class="line">484</span><br><span class="line">485</span><br><span class="line">486</span><br><span class="line">487</span><br><span class="line">488</span><br><span class="line">489</span><br><span class="line">490</span><br><span class="line">491</span><br><span class="line">492</span><br><span class="line">493</span><br><span class="line">494</span><br><span class="line">495</span><br><span class="line">496</span><br><span class="line">497</span><br><span class="line">498</span><br><span class="line">499</span><br><span class="line">500</span><br><span class="line">501</span><br><span class="line">502</span><br><span class="line">503</span><br><span class="line">504</span><br><span class="line">505</span><br><span class="line">506</span><br><span class="line">507</span><br><span class="line">508</span><br><span class="line">509</span><br><span class="line">510</span><br><span class="line">511</span><br><span class="line">512</span><br><span class="line">513</span><br><span class="line">514</span><br><span class="line">515</span><br><span class="line">516</span><br><span class="line">517</span><br><span class="line">518</span><br><span class="line">519</span><br><span class="line">520</span><br><span class="line">521</span><br><span class="line">522</span><br><span class="line">523</span><br><span class="line">524</span><br><span class="line">525</span><br><span class="line">526</span><br><span class="line">527</span><br><span class="line">528</span><br><span class="line">529</span><br><span class="line">530</span><br><span class="line">531</span><br><span class="line">532</span><br><span class="line">533</span><br><span class="line">534</span><br><span class="line">535</span><br><span class="line">536</span><br><span class="line">537</span><br><span class="line">538</span><br><span class="line">539</span><br><span class="line">540</span><br><span class="line">541</span><br><span class="line">542</span><br><span class="line">543</span><br><span class="line">544</span><br><span class="line">545</span><br><span class="line">546</span><br><span class="line">547</span><br><span class="line">548</span><br><span class="line">549</span><br><span class="line">550</span><br><span class="line">551</span><br><span class="line">552</span><br><span class="line">553</span><br><span class="line">554</span><br><span class="line">555</span><br><span class="line">556</span><br><span class="line">557</span><br><span class="line">558</span><br><span class="line">559</span><br><span class="line">560</span><br><span class="line">561</span><br><span class="line">562</span><br><span class="line">563</span><br><span class="line">564</span><br><span class="line">565</span><br><span class="line">566</span><br><span class="line">567</span><br><span class="line">568</span><br><span class="line">569</span><br><span class="line">570</span><br><span class="line">571</span><br><span class="line">572</span><br><span class="line">573</span><br><span class="line">574</span><br><span class="line">575</span><br><span class="line">576</span><br><span class="line">577</span><br><span class="line">578</span><br><span class="line">579</span><br><span class="line">580</span><br><span class="line">581</span><br><span class="line">582</span><br><span class="line">583</span><br><span class="line">584</span><br><span class="line">585</span><br><span class="line">586</span><br><span class="line">587</span><br><span class="line">588</span><br><span class="line">589</span><br><span class="line">590</span><br><span class="line">591</span><br><span class="line">592</span><br><span class="line">593</span><br><span class="line">594</span><br><span class="line">595</span><br><span class="line">596</span><br><span class="line">597</span><br><span class="line">598</span><br><span class="line">599</span><br><span class="line">600</span><br><span class="line">601</span><br><span class="line">602</span><br><span class="line">603</span><br><span class="line">604</span><br><span class="line">605</span><br><span class="line">606</span><br><span class="line">607</span><br><span class="line">608</span><br><span class="line">609</span><br><span class="line">610</span><br><span class="line">611</span><br><span class="line">612</span><br><span class="line">613</span><br><span class="line">614</span><br><span class="line">615</span><br><span class="line">616</span><br><span class="line">617</span><br><span class="line">618</span><br><span class="line">619</span><br><span class="line">620</span><br><span class="line">621</span><br><span class="line">622</span><br><span class="line">623</span><br><span class="line">624</span><br><span class="line">625</span><br><span class="line">626</span><br><span class="line">627</span><br><span class="line">628</span><br><span class="line">629</span><br><span class="line">630</span><br><span class="line">631</span><br><span class="line">632</span><br><span class="line">633</span><br><span class="line">634</span><br><span class="line">635</span><br><span class="line">636</span><br><span class="line">637</span><br><span class="line">638</span><br><span class="line">639</span><br><span class="line">640</span><br><span class="line">641</span><br><span class="line">642</span><br><span class="line">643</span><br><span class="line">644</span><br><span class="line">645</span><br><span class="line">646</span><br><span class="line">647</span><br><span class="line">648</span><br><span class="line">649</span><br><span class="line">650</span><br><span class="line">651</span><br></pre></td><td class="code"><pre><span class="line"># 弹珠资产管理链码，演示couchDB的富查询（基于json）(私有数据)</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">Copyright IBM Corp. All Rights Reserved.</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">SPDX-License-Identifier: Apache-2.0</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// ====CHAINCODE EXECUTION SAMPLES (CLI) ==================</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// ==== Invoke marbles, pass private data as base64 encoded bytes in transient map ====</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// export MARBLE=$(echo -n "&#123;\"name\":\"marble1\",\"color\":\"blue\",\"size\":35,\"owner\":\"tom\",\"price\":99&#125;" | base64 | tr -d \\n)</span></span><br><span class="line"><span class="comment">// peer chaincode invoke -C mychannel -n marblesp -c '&#123;"Args":["initMarble"]&#125;' --transient "&#123;\"marble\":\"$MARBLE\"&#125;"</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// export MARBLE=$(echo -n "&#123;\"name\":\"marble2\",\"color\":\"red\",\"size\":50,\"owner\":\"tom\",\"price\":102&#125;" | base64 | tr -d \\n)</span></span><br><span class="line"><span class="comment">// peer chaincode invoke -C mychannel -n marblesp -c '&#123;"Args":["initMarble"]&#125;' --transient "&#123;\"marble\":\"$MARBLE\"&#125;"</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// export MARBLE=$(echo -n "&#123;\"name\":\"marble3\",\"color\":\"blue\",\"size\":70,\"owner\":\"tom\",\"price\":103&#125;" | base64 | tr -d \\n)</span></span><br><span class="line"><span class="comment">// peer chaincode invoke -C mychannel -n marblesp -c '&#123;"Args":["initMarble"]&#125;' --transient "&#123;\"marble\":\"$MARBLE\"&#125;"</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// export MARBLE_OWNER=$(echo -n "&#123;\"name\":\"marble2\",\"owner\":\"jerry\"&#125;" | base64 | tr -d \\n)</span></span><br><span class="line"><span class="comment">// peer chaincode invoke -C mychannel -n marblesp -c '&#123;"Args":["transferMarble"]&#125;' --transient "&#123;\"marble_owner\":\"$MARBLE_OWNER\"&#125;"</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// export MARBLE_DELETE=$(echo -n "&#123;\"name\":\"marble1\"&#125;" | base64 | tr -d \\n)</span></span><br><span class="line"><span class="comment">// peer chaincode invoke -C mychannel -n marblesp -c '&#123;"Args":["delete"]&#125;' --transient "&#123;\"marble_delete\":\"$MARBLE_DELETE\"&#125;"</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// ==== Query marbles, since queries are not recorded on chain we don't need to hide private data in transient map ====</span></span><br><span class="line"><span class="comment">// peer chaincode query -C mychannel -n marblesp -c '&#123;"Args":["readMarble","marble1"]&#125;'</span></span><br><span class="line"><span class="comment">// peer chaincode query -C mychannel -n marblesp -c '&#123;"Args":["readMarblePrivateDetails","marble1"]&#125;'</span></span><br><span class="line"><span class="comment">// peer chaincode query -C mychannel -n marblesp -c '&#123;"Args":["getMarblesByRange","marble1","marble4"]&#125;'</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// Rich Query (Only supported if CouchDB is used as state database):</span></span><br><span class="line"><span class="comment">//   peer chaincode query -C mychannel -n marblesp -c '&#123;"Args":["queryMarblesByOwner","tom"]&#125;'</span></span><br><span class="line"><span class="comment">//   peer chaincode query -C mychannel -n marblesp -c '&#123;"Args":["queryMarbles","&#123;\"selector\":&#123;\"owner\":\"tom\"&#125;&#125;"]&#125;'</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// INDEXES TO SUPPORT COUCHDB RICH QUERIES</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// Indexes in CouchDB are required in order to make JSON queries efficient and are required for</span></span><br><span class="line"><span class="comment">// any JSON query with a sort. As of Hyperledger Fabric 1.1, indexes may be packaged alongside</span></span><br><span class="line"><span class="comment">// chaincode in a META-INF/statedb/couchdb/indexes directory. Or for indexes on private data</span></span><br><span class="line"><span class="comment">// collections, in a META-INF/statedb/couchdb/collections/&lt;collection_name&gt;/indexes directory.</span></span><br><span class="line"><span class="comment">// Each index must be defined in its own text file with extension *.json with the index</span></span><br><span class="line"><span class="comment">// definition formatted in JSON following the CouchDB index JSON syntax as documented at:</span></span><br><span class="line"><span class="comment">// http://docs.couchdb.org/en/2.1.1/api/database/find.html#db-index</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// This marbles02_private example chaincode demonstrates a packaged index which you</span></span><br><span class="line"><span class="comment">// can find in META-INF/statedb/couchdb/collection/collectionMarbles/indexes/indexOwner.json.</span></span><br><span class="line"><span class="comment">// For deployment of chaincode to production environments, it is recommended</span></span><br><span class="line"><span class="comment">// to define any indexes alongside chaincode so that the chaincode and supporting indexes</span></span><br><span class="line"><span class="comment">// are deployed automatically as a unit, once the chaincode has been installed on a peer and</span></span><br><span class="line"><span class="comment">// instantiated on a channel. See Hyperledger Fabric documentation for more details.</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// If you have access to the your peer's CouchDB state database in a development environment,</span></span><br><span class="line"><span class="comment">// you may want to iteratively test various indexes in support of your chaincode queries.  You</span></span><br><span class="line"><span class="comment">// can use the CouchDB Fauxton interface or a command line curl utility to create and update</span></span><br><span class="line"><span class="comment">// indexes. Then once you finalize an index, include the index definition alongside your</span></span><br><span class="line"><span class="comment">// chaincode in the META-INF/statedb/couchdb/indexes directory or</span></span><br><span class="line"><span class="comment">// META-INF/statedb/couchdb/collections/&lt;collection_name&gt;/indexes directory, for packaging</span></span><br><span class="line"><span class="comment">// and deployment to managed environments.</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// In the examples below you can find index definitions that support marbles02_private</span></span><br><span class="line"><span class="comment">// chaincode queries, along with the syntax that you can use in development environments</span></span><br><span class="line"><span class="comment">// to create the indexes in the CouchDB Fauxton interface.</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//Example hostname:port configurations to access CouchDB.</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">//To access CouchDB docker container from within another docker container or from vagrant environments:</span></span><br><span class="line"><span class="comment">// http://couchdb:5984/</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">//Inside couchdb docker container</span></span><br><span class="line"><span class="comment">// http://127.0.0.1:5984/</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// Index for docType, owner.</span></span><br><span class="line"><span class="comment">// Note that docType and owner fields must be prefixed with the "data" wrapper</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// Index definition for use with Fauxton interface</span></span><br><span class="line"><span class="comment">// &#123;"index":&#123;"fields":["data.docType","data.owner"]&#125;,"ddoc":"indexOwnerDoc", "name":"indexOwner","type":"json"&#125;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// Index for docType, owner, size (descending order).</span></span><br><span class="line"><span class="comment">// Note that docType, owner and size fields must be prefixed with the "data" wrapper</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// Index definition for use with Fauxton interface</span></span><br><span class="line"><span class="comment">// &#123;"index":&#123;"fields":[&#123;"data.size":"desc"&#125;,&#123;"data.docType":"desc"&#125;,&#123;"data.owner":"desc"&#125;]&#125;,"ddoc":"indexSizeSortDoc", "name":"indexSizeSortDesc","type":"json"&#125;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// Rich Query with index design doc and index name specified (Only supported if CouchDB is used as state database):</span></span><br><span class="line"><span class="comment">//   peer chaincode query -C mychannel -n marblesp -c '&#123;"Args":["queryMarbles","&#123;\"selector\":&#123;\"docType\":\"marble\",\"owner\":\"tom\"&#125;, \"use_index\":[\"_design/indexOwnerDoc\", \"indexOwner\"]&#125;"]&#125;'</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// Rich Query with index design doc specified only (Only supported if CouchDB is used as state database):</span></span><br><span class="line"><span class="comment">//   peer chaincode query -C mychannel -n marblesp -c '&#123;"Args":["queryMarbles","&#123;\"selector\":&#123;\"docType\":&#123;\"$eq\":\"marble\"&#125;,\"owner\":&#123;\"$eq\":\"tom\"&#125;,\"size\":&#123;\"$gt\":0&#125;&#125;,\"fields\":[\"docType\",\"owner\",\"size\"],\"sort\":[&#123;\"size\":\"desc\"&#125;],\"use_index\":\"_design/indexSizeSortDoc\"&#125;"]&#125;'</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">	<span class="string">"bytes"</span></span><br><span class="line">	<span class="string">"encoding/json"</span></span><br><span class="line">	<span class="string">"fmt"</span></span><br><span class="line">	<span class="string">"strings"</span></span><br><span class="line"></span><br><span class="line">	<span class="string">"github.com/hyperledger/fabric/core/chaincode/shim"</span></span><br><span class="line">	pb <span class="string">"github.com/hyperledger/fabric/protos/peer"</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="comment">// SimpleChaincode example simple Chaincode implementation</span></span><br><span class="line"><span class="keyword">type</span> SimpleChaincode <span class="keyword">struct</span> &#123;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> marble <span class="keyword">struct</span> &#123;</span><br><span class="line">	ObjectType <span class="keyword">string</span> <span class="string">`json:"docType"`</span> <span class="comment">//docType is used to distinguish the various types of objects in state database</span></span><br><span class="line">	Name       <span class="keyword">string</span> <span class="string">`json:"name"`</span>    <span class="comment">//the fieldtags are needed to keep case from bouncing around</span></span><br><span class="line">	Color      <span class="keyword">string</span> <span class="string">`json:"color"`</span></span><br><span class="line">	Size       <span class="keyword">int</span>    <span class="string">`json:"size"`</span></span><br><span class="line">	Owner      <span class="keyword">string</span> <span class="string">`json:"owner"`</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> marblePrivateDetails <span class="keyword">struct</span> &#123;</span><br><span class="line">	ObjectType <span class="keyword">string</span> <span class="string">`json:"docType"`</span> <span class="comment">//docType is used to distinguish the various types of objects in state database</span></span><br><span class="line">	Name       <span class="keyword">string</span> <span class="string">`json:"name"`</span>    <span class="comment">//the fieldtags are needed to keep case from bouncing around</span></span><br><span class="line">	Price      <span class="keyword">int</span>    <span class="string">`json:"price"`</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ===================================================================================</span></span><br><span class="line"><span class="comment">// Main</span></span><br><span class="line"><span class="comment">// ===================================================================================</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">	err := shim.Start(<span class="built_in">new</span>(SimpleChaincode))</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		fmt.Printf(<span class="string">"Error starting Simple chaincode: %s"</span>, err)</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Init initializes chaincode</span></span><br><span class="line"><span class="comment">// ===========================</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(t *SimpleChaincode)</span> <span class="title">Init</span><span class="params">(stub shim.ChaincodeStubInterface)</span> <span class="title">pb</span>.<span class="title">Response</span></span> &#123;</span><br><span class="line">	<span class="keyword">return</span> shim.Success(<span class="literal">nil</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Invoke - Our entry point for Invocations</span></span><br><span class="line"><span class="comment">// ========================================</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(t *SimpleChaincode)</span> <span class="title">Invoke</span><span class="params">(stub shim.ChaincodeStubInterface)</span> <span class="title">pb</span>.<span class="title">Response</span></span> &#123;</span><br><span class="line">	function, args := stub.GetFunctionAndParameters()</span><br><span class="line">	fmt.Println(<span class="string">"invoke is running "</span> + function)</span><br><span class="line"></span><br><span class="line">	<span class="comment">// Handle different functions</span></span><br><span class="line">	<span class="keyword">switch</span> function &#123;</span><br><span class="line">	<span class="keyword">case</span> <span class="string">"initMarble"</span>:</span><br><span class="line">		<span class="comment">//create a new marble</span></span><br><span class="line">		<span class="keyword">return</span> t.initMarble(stub, args)</span><br><span class="line">	<span class="keyword">case</span> <span class="string">"readMarble"</span>:</span><br><span class="line">		<span class="comment">//read a marble</span></span><br><span class="line">		<span class="keyword">return</span> t.readMarble(stub, args)</span><br><span class="line">	<span class="keyword">case</span> <span class="string">"readMarblePrivateDetails"</span>:</span><br><span class="line">		<span class="comment">//read a marble private details</span></span><br><span class="line">		<span class="keyword">return</span> t.readMarblePrivateDetails(stub, args)</span><br><span class="line">	<span class="keyword">case</span> <span class="string">"transferMarble"</span>:</span><br><span class="line">		<span class="comment">//change owner of a specific marble</span></span><br><span class="line">		<span class="keyword">return</span> t.transferMarble(stub, args)</span><br><span class="line">	<span class="keyword">case</span> <span class="string">"delete"</span>:</span><br><span class="line">		<span class="comment">//delete a marble</span></span><br><span class="line">		<span class="keyword">return</span> t.<span class="built_in">delete</span>(stub, args)</span><br><span class="line">	<span class="keyword">case</span> <span class="string">"queryMarblesByOwner"</span>:</span><br><span class="line">		<span class="comment">//find marbles for owner X using rich query</span></span><br><span class="line">		<span class="keyword">return</span> t.queryMarblesByOwner(stub, args)</span><br><span class="line">	<span class="keyword">case</span> <span class="string">"queryMarbles"</span>:</span><br><span class="line">		<span class="comment">//find marbles based on an ad hoc rich query</span></span><br><span class="line">		<span class="keyword">return</span> t.queryMarbles(stub, args)</span><br><span class="line">	<span class="keyword">case</span> <span class="string">"getMarblesByRange"</span>:</span><br><span class="line">		<span class="comment">//get marbles based on range query</span></span><br><span class="line">		<span class="keyword">return</span> t.getMarblesByRange(stub, args)</span><br><span class="line">	<span class="keyword">default</span>:</span><br><span class="line">		<span class="comment">//error</span></span><br><span class="line">		fmt.Println(<span class="string">"invoke did not find func: "</span> + function)</span><br><span class="line">		<span class="keyword">return</span> shim.Error(<span class="string">"Received unknown function invocation"</span>)</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ============================================================</span></span><br><span class="line"><span class="comment">// initMarble - create a new marble, store into chaincode state</span></span><br><span class="line"><span class="comment">// ============================================================</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(t *SimpleChaincode)</span> <span class="title">initMarble</span><span class="params">(stub shim.ChaincodeStubInterface, args []<span class="keyword">string</span>)</span> <span class="title">pb</span>.<span class="title">Response</span></span> &#123;</span><br><span class="line">	<span class="keyword">var</span> err error</span><br><span class="line"></span><br><span class="line">	<span class="keyword">type</span> marbleTransientInput <span class="keyword">struct</span> &#123;</span><br><span class="line">		Name  <span class="keyword">string</span> <span class="string">`json:"name"`</span> <span class="comment">//the fieldtags are needed to keep case from bouncing around</span></span><br><span class="line">		Color <span class="keyword">string</span> <span class="string">`json:"color"`</span></span><br><span class="line">		Size  <span class="keyword">int</span>    <span class="string">`json:"size"`</span></span><br><span class="line">		Owner <span class="keyword">string</span> <span class="string">`json:"owner"`</span></span><br><span class="line">		Price <span class="keyword">int</span>    <span class="string">`json:"price"`</span></span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// ==== Input sanitation ====</span></span><br><span class="line">	fmt.Println(<span class="string">"- start init marble"</span>)</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> <span class="built_in">len</span>(args) != <span class="number">0</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> shim.Error(<span class="string">"Incorrect number of arguments. Private marble data must be passed in transient map."</span>)</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	transMap, err := stub.GetTransient()</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> shim.Error(<span class="string">"Error getting transient: "</span> + err.Error())</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> _, ok := transMap[<span class="string">"marble"</span>]; !ok &#123;</span><br><span class="line">		<span class="keyword">return</span> shim.Error(<span class="string">"marble must be a key in the transient map"</span>)</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> <span class="built_in">len</span>(transMap[<span class="string">"marble"</span>]) == <span class="number">0</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> shim.Error(<span class="string">"marble value in the transient map must be a non-empty JSON string"</span>)</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">var</span> marbleInput marbleTransientInput</span><br><span class="line">	err = json.Unmarshal(transMap[<span class="string">"marble"</span>], &amp;marbleInput)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> shim.Error(<span class="string">"Failed to decode JSON of: "</span> + <span class="keyword">string</span>(transMap[<span class="string">"marble"</span>]))</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> <span class="built_in">len</span>(marbleInput.Name) == <span class="number">0</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> shim.Error(<span class="string">"name field must be a non-empty string"</span>)</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">if</span> <span class="built_in">len</span>(marbleInput.Color) == <span class="number">0</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> shim.Error(<span class="string">"color field must be a non-empty string"</span>)</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">if</span> marbleInput.Size &lt;= <span class="number">0</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> shim.Error(<span class="string">"size field must be a positive integer"</span>)</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">if</span> <span class="built_in">len</span>(marbleInput.Owner) == <span class="number">0</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> shim.Error(<span class="string">"owner field must be a non-empty string"</span>)</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">if</span> marbleInput.Price &lt;= <span class="number">0</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> shim.Error(<span class="string">"price field must be a positive integer"</span>)</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// ==== Check if marble already exists ====</span></span><br><span class="line">	marbleAsBytes, err := stub.GetPrivateData(<span class="string">"collectionMarbles"</span>, marbleInput.Name)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> shim.Error(<span class="string">"Failed to get marble: "</span> + err.Error())</span><br><span class="line">	&#125; <span class="keyword">else</span> <span class="keyword">if</span> marbleAsBytes != <span class="literal">nil</span> &#123;</span><br><span class="line">		fmt.Println(<span class="string">"This marble already exists: "</span> + marbleInput.Name)</span><br><span class="line">		<span class="keyword">return</span> shim.Error(<span class="string">"This marble already exists: "</span> + marbleInput.Name)</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// ==== Create marble object, marshal to JSON, and save to state ====</span></span><br><span class="line">	marble := &amp;marble&#123;</span><br><span class="line">		ObjectType: <span class="string">"marble"</span>,</span><br><span class="line">		Name:       marbleInput.Name,</span><br><span class="line">		Color:      marbleInput.Color,</span><br><span class="line">		Size:       marbleInput.Size,</span><br><span class="line">		Owner:      marbleInput.Owner,</span><br><span class="line">	&#125;</span><br><span class="line">	marbleJSONasBytes, err := json.Marshal(marble)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> shim.Error(err.Error())</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// === Save marble to state ===</span></span><br><span class="line">	err = stub.PutPrivateData(<span class="string">"collectionMarbles"</span>, marbleInput.Name, marbleJSONasBytes)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> shim.Error(err.Error())</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// ==== Create marble private details object with price, marshal to JSON, and save to state ====</span></span><br><span class="line">	marblePrivateDetails := &amp;marblePrivateDetails&#123;</span><br><span class="line">		ObjectType: <span class="string">"marblePrivateDetails"</span>,</span><br><span class="line">		Name:       marbleInput.Name,</span><br><span class="line">		Price:      marbleInput.Price,</span><br><span class="line">	&#125;</span><br><span class="line">	marblePrivateDetailsBytes, err := json.Marshal(marblePrivateDetails)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> shim.Error(err.Error())</span><br><span class="line">	&#125;</span><br><span class="line">	err = stub.PutPrivateData(<span class="string">"collectionMarblePrivateDetails"</span>, marbleInput.Name, marblePrivateDetailsBytes)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> shim.Error(err.Error())</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">//  ==== Index the marble to enable color-based range queries, e.g. return all blue marbles ====</span></span><br><span class="line">	<span class="comment">//  An 'index' is a normal key/value entry in state.</span></span><br><span class="line">	<span class="comment">//  The key is a composite key, with the elements that you want to range query on listed first.</span></span><br><span class="line">	<span class="comment">//  In our case, the composite key is based on indexName~color~name.</span></span><br><span class="line">	<span class="comment">//  This will enable very efficient state range queries based on composite keys matching indexName~color~*</span></span><br><span class="line">	indexName := <span class="string">"color~name"</span></span><br><span class="line">	colorNameIndexKey, err := stub.CreateCompositeKey(indexName, []<span class="keyword">string</span>&#123;marble.Color, marble.Name&#125;)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> shim.Error(err.Error())</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">//  Save index entry to state. Only the key name is needed, no need to store a duplicate copy of the marble.</span></span><br><span class="line">	<span class="comment">//  Note - passing a 'nil' value will effectively delete the key from state, therefore we pass null character as value</span></span><br><span class="line">	value := []<span class="keyword">byte</span>&#123;<span class="number">0x00</span>&#125;</span><br><span class="line">	stub.PutPrivateData(<span class="string">"collectionMarbles"</span>, colorNameIndexKey, value)</span><br><span class="line"></span><br><span class="line">	<span class="comment">// ==== Marble saved and indexed. Return success ====</span></span><br><span class="line">	fmt.Println(<span class="string">"- end init marble"</span>)</span><br><span class="line">	<span class="keyword">return</span> shim.Success(<span class="literal">nil</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ===============================================</span></span><br><span class="line"><span class="comment">// readMarble - read a marble from chaincode state</span></span><br><span class="line"><span class="comment">// ===============================================</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(t *SimpleChaincode)</span> <span class="title">readMarble</span><span class="params">(stub shim.ChaincodeStubInterface, args []<span class="keyword">string</span>)</span> <span class="title">pb</span>.<span class="title">Response</span></span> &#123;</span><br><span class="line">	<span class="keyword">var</span> name, jsonResp <span class="keyword">string</span></span><br><span class="line">	<span class="keyword">var</span> err error</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> <span class="built_in">len</span>(args) != <span class="number">1</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> shim.Error(<span class="string">"Incorrect number of arguments. Expecting name of the marble to query"</span>)</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	name = args[<span class="number">0</span>]</span><br><span class="line">	valAsbytes, err := stub.GetPrivateData(<span class="string">"collectionMarbles"</span>, name) <span class="comment">//get the marble from chaincode state</span></span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		jsonResp = <span class="string">"&#123;\"Error\":\"Failed to get state for "</span> + name + <span class="string">"\"&#125;"</span></span><br><span class="line">		<span class="keyword">return</span> shim.Error(jsonResp)</span><br><span class="line">	&#125; <span class="keyword">else</span> <span class="keyword">if</span> valAsbytes == <span class="literal">nil</span> &#123;</span><br><span class="line">		jsonResp = <span class="string">"&#123;\"Error\":\"Marble does not exist: "</span> + name + <span class="string">"\"&#125;"</span></span><br><span class="line">		<span class="keyword">return</span> shim.Error(jsonResp)</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> shim.Success(valAsbytes)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ===============================================</span></span><br><span class="line"><span class="comment">// readMarblereadMarblePrivateDetails - read a marble private details from chaincode state</span></span><br><span class="line"><span class="comment">// ===============================================</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(t *SimpleChaincode)</span> <span class="title">readMarblePrivateDetails</span><span class="params">(stub shim.ChaincodeStubInterface, args []<span class="keyword">string</span>)</span> <span class="title">pb</span>.<span class="title">Response</span></span> &#123;</span><br><span class="line">	<span class="keyword">var</span> name, jsonResp <span class="keyword">string</span></span><br><span class="line">	<span class="keyword">var</span> err error</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> <span class="built_in">len</span>(args) != <span class="number">1</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> shim.Error(<span class="string">"Incorrect number of arguments. Expecting name of the marble to query"</span>)</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	name = args[<span class="number">0</span>]</span><br><span class="line">	valAsbytes, err := stub.GetPrivateData(<span class="string">"collectionMarblePrivateDetails"</span>, name) <span class="comment">//get the marble private details from chaincode state</span></span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		jsonResp = <span class="string">"&#123;\"Error\":\"Failed to get private details for "</span> + name + <span class="string">": "</span> + err.Error() + <span class="string">"\"&#125;"</span></span><br><span class="line">		<span class="keyword">return</span> shim.Error(jsonResp)</span><br><span class="line">	&#125; <span class="keyword">else</span> <span class="keyword">if</span> valAsbytes == <span class="literal">nil</span> &#123;</span><br><span class="line">		jsonResp = <span class="string">"&#123;\"Error\":\"Marble private details does not exist: "</span> + name + <span class="string">"\"&#125;"</span></span><br><span class="line">		<span class="keyword">return</span> shim.Error(jsonResp)</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> shim.Success(valAsbytes)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ==================================================</span></span><br><span class="line"><span class="comment">// delete - remove a marble key/value pair from state</span></span><br><span class="line"><span class="comment">// ==================================================</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(t *SimpleChaincode)</span> <span class="title">delete</span><span class="params">(stub shim.ChaincodeStubInterface, args []<span class="keyword">string</span>)</span> <span class="title">pb</span>.<span class="title">Response</span></span> &#123;</span><br><span class="line">	fmt.Println(<span class="string">"- start delete marble"</span>)</span><br><span class="line"></span><br><span class="line">	<span class="keyword">type</span> marbleDeleteTransientInput <span class="keyword">struct</span> &#123;</span><br><span class="line">		Name <span class="keyword">string</span> <span class="string">`json:"name"`</span></span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> <span class="built_in">len</span>(args) != <span class="number">0</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> shim.Error(<span class="string">"Incorrect number of arguments. Private marble name must be passed in transient map."</span>)</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	transMap, err := stub.GetTransient()</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> shim.Error(<span class="string">"Error getting transient: "</span> + err.Error())</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> _, ok := transMap[<span class="string">"marble_delete"</span>]; !ok &#123;</span><br><span class="line">		<span class="keyword">return</span> shim.Error(<span class="string">"marble_delete must be a key in the transient map"</span>)</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> <span class="built_in">len</span>(transMap[<span class="string">"marble_delete"</span>]) == <span class="number">0</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> shim.Error(<span class="string">"marble_delete value in the transient map must be a non-empty JSON string"</span>)</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">var</span> marbleDeleteInput marbleDeleteTransientInput</span><br><span class="line">	err = json.Unmarshal(transMap[<span class="string">"marble_delete"</span>], &amp;marbleDeleteInput)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> shim.Error(<span class="string">"Failed to decode JSON of: "</span> + <span class="keyword">string</span>(transMap[<span class="string">"marble_delete"</span>]))</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> <span class="built_in">len</span>(marbleDeleteInput.Name) == <span class="number">0</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> shim.Error(<span class="string">"name field must be a non-empty string"</span>)</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// to maintain the color~name index, we need to read the marble first and get its color</span></span><br><span class="line">	valAsbytes, err := stub.GetPrivateData(<span class="string">"collectionMarbles"</span>, marbleDeleteInput.Name) <span class="comment">//get the marble from chaincode state</span></span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> shim.Error(<span class="string">"Failed to get state for "</span> + marbleDeleteInput.Name)</span><br><span class="line">	&#125; <span class="keyword">else</span> <span class="keyword">if</span> valAsbytes == <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> shim.Error(<span class="string">"Marble does not exist: "</span> + marbleDeleteInput.Name)</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">var</span> marbleToDelete marble</span><br><span class="line">	err = json.Unmarshal([]<span class="keyword">byte</span>(valAsbytes), &amp;marbleToDelete)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> shim.Error(<span class="string">"Failed to decode JSON of: "</span> + <span class="keyword">string</span>(valAsbytes))</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// delete the marble from state</span></span><br><span class="line">	err = stub.DelPrivateData(<span class="string">"collectionMarbles"</span>, marbleDeleteInput.Name)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> shim.Error(<span class="string">"Failed to delete state:"</span> + err.Error())</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// Also delete the marble from the color~name index</span></span><br><span class="line">	indexName := <span class="string">"color~name"</span></span><br><span class="line">	colorNameIndexKey, err := stub.CreateCompositeKey(indexName, []<span class="keyword">string</span>&#123;marbleToDelete.Color, marbleToDelete.Name&#125;)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> shim.Error(err.Error())</span><br><span class="line">	&#125;</span><br><span class="line">	err = stub.DelPrivateData(<span class="string">"collectionMarbles"</span>, colorNameIndexKey)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> shim.Error(<span class="string">"Failed to delete state:"</span> + err.Error())</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// Finally, delete private details of marble</span></span><br><span class="line">	err = stub.DelPrivateData(<span class="string">"collectionMarblePrivateDetails"</span>, marbleDeleteInput.Name)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> shim.Error(err.Error())</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> shim.Success(<span class="literal">nil</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ===========================================================</span></span><br><span class="line"><span class="comment">// transfer a marble by setting a new owner name on the marble</span></span><br><span class="line"><span class="comment">// ===========================================================</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(t *SimpleChaincode)</span> <span class="title">transferMarble</span><span class="params">(stub shim.ChaincodeStubInterface, args []<span class="keyword">string</span>)</span> <span class="title">pb</span>.<span class="title">Response</span></span> &#123;</span><br><span class="line"></span><br><span class="line">	fmt.Println(<span class="string">"- start transfer marble"</span>)</span><br><span class="line"></span><br><span class="line">	<span class="keyword">type</span> marbleTransferTransientInput <span class="keyword">struct</span> &#123;</span><br><span class="line">		Name  <span class="keyword">string</span> <span class="string">`json:"name"`</span></span><br><span class="line">		Owner <span class="keyword">string</span> <span class="string">`json:"owner"`</span></span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> <span class="built_in">len</span>(args) != <span class="number">0</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> shim.Error(<span class="string">"Incorrect number of arguments. Private marble data must be passed in transient map."</span>)</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	transMap, err := stub.GetTransient()</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> shim.Error(<span class="string">"Error getting transient: "</span> + err.Error())</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> _, ok := transMap[<span class="string">"marble_owner"</span>]; !ok &#123;</span><br><span class="line">		<span class="keyword">return</span> shim.Error(<span class="string">"marble_owner must be a key in the transient map"</span>)</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> <span class="built_in">len</span>(transMap[<span class="string">"marble_owner"</span>]) == <span class="number">0</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> shim.Error(<span class="string">"marble_owner value in the transient map must be a non-empty JSON string"</span>)</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">var</span> marbleTransferInput marbleTransferTransientInput</span><br><span class="line">	err = json.Unmarshal(transMap[<span class="string">"marble_owner"</span>], &amp;marbleTransferInput)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> shim.Error(<span class="string">"Failed to decode JSON of: "</span> + <span class="keyword">string</span>(transMap[<span class="string">"marble_owner"</span>]))</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> <span class="built_in">len</span>(marbleTransferInput.Name) == <span class="number">0</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> shim.Error(<span class="string">"name field must be a non-empty string"</span>)</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">if</span> <span class="built_in">len</span>(marbleTransferInput.Owner) == <span class="number">0</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> shim.Error(<span class="string">"owner field must be a non-empty string"</span>)</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	marbleAsBytes, err := stub.GetPrivateData(<span class="string">"collectionMarbles"</span>, marbleTransferInput.Name)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> shim.Error(<span class="string">"Failed to get marble:"</span> + err.Error())</span><br><span class="line">	&#125; <span class="keyword">else</span> <span class="keyword">if</span> marbleAsBytes == <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> shim.Error(<span class="string">"Marble does not exist: "</span> + marbleTransferInput.Name)</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	marbleToTransfer := marble&#123;&#125;</span><br><span class="line">	err = json.Unmarshal(marbleAsBytes, &amp;marbleToTransfer) <span class="comment">//unmarshal it aka JSON.parse()</span></span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> shim.Error(err.Error())</span><br><span class="line">	&#125;</span><br><span class="line">	marbleToTransfer.Owner = marbleTransferInput.Owner <span class="comment">//change the owner</span></span><br><span class="line"></span><br><span class="line">	marbleJSONasBytes, _ := json.Marshal(marbleToTransfer)</span><br><span class="line">	err = stub.PutPrivateData(<span class="string">"collectionMarbles"</span>, marbleToTransfer.Name, marbleJSONasBytes) <span class="comment">//rewrite the marble</span></span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> shim.Error(err.Error())</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	fmt.Println(<span class="string">"- end transferMarble (success)"</span>)</span><br><span class="line">	<span class="keyword">return</span> shim.Success(<span class="literal">nil</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ===========================================================================================</span></span><br><span class="line"><span class="comment">// getMarblesByRange performs a range query based on the start and end keys provided.</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// Read-only function results are not typically submitted to ordering. If the read-only</span></span><br><span class="line"><span class="comment">// results are submitted to ordering, or if the query is used in an update transaction</span></span><br><span class="line"><span class="comment">// and submitted to ordering, then the committing peers will re-execute to guarantee that</span></span><br><span class="line"><span class="comment">// result sets are stable between endorsement time and commit time. The transaction is</span></span><br><span class="line"><span class="comment">// invalidated by the committing peers if the result set has changed between endorsement</span></span><br><span class="line"><span class="comment">// time and commit time.</span></span><br><span class="line"><span class="comment">// Therefore, range queries are a safe option for performing update transactions based on query results.</span></span><br><span class="line"><span class="comment">// ===========================================================================================</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(t *SimpleChaincode)</span> <span class="title">getMarblesByRange</span><span class="params">(stub shim.ChaincodeStubInterface, args []<span class="keyword">string</span>)</span> <span class="title">pb</span>.<span class="title">Response</span></span> &#123;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> <span class="built_in">len</span>(args) &lt; <span class="number">2</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> shim.Error(<span class="string">"Incorrect number of arguments. Expecting 2"</span>)</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	startKey := args[<span class="number">0</span>]</span><br><span class="line">	endKey := args[<span class="number">1</span>]</span><br><span class="line"></span><br><span class="line">	resultsIterator, err := stub.GetPrivateDataByRange(<span class="string">"collectionMarbles"</span>, startKey, endKey)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> shim.Error(err.Error())</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">defer</span> resultsIterator.Close()</span><br><span class="line"></span><br><span class="line">	<span class="comment">// buffer is a JSON array containing QueryResults</span></span><br><span class="line">	<span class="keyword">var</span> buffer bytes.Buffer</span><br><span class="line">	buffer.WriteString(<span class="string">"["</span>)</span><br><span class="line"></span><br><span class="line">	bArrayMemberAlreadyWritten := <span class="literal">false</span></span><br><span class="line">	<span class="keyword">for</span> resultsIterator.HasNext() &#123;</span><br><span class="line">		queryResponse, err := resultsIterator.Next()</span><br><span class="line">		<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">			<span class="keyword">return</span> shim.Error(err.Error())</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="comment">// Add a comma before array members, suppress it for the first array member</span></span><br><span class="line">		<span class="keyword">if</span> bArrayMemberAlreadyWritten == <span class="literal">true</span> &#123;</span><br><span class="line">			buffer.WriteString(<span class="string">","</span>)</span><br><span class="line">		&#125;</span><br><span class="line">		buffer.WriteString(<span class="string">"&#123;\"Key\":"</span>)</span><br><span class="line">		buffer.WriteString(<span class="string">"\""</span>)</span><br><span class="line">		buffer.WriteString(queryResponse.Key)</span><br><span class="line">		buffer.WriteString(<span class="string">"\""</span>)</span><br><span class="line"></span><br><span class="line">		buffer.WriteString(<span class="string">", \"Record\":"</span>)</span><br><span class="line">		<span class="comment">// Record is a JSON object, so we write as-is</span></span><br><span class="line">		buffer.WriteString(<span class="keyword">string</span>(queryResponse.Value))</span><br><span class="line">		buffer.WriteString(<span class="string">"&#125;"</span>)</span><br><span class="line">		bArrayMemberAlreadyWritten = <span class="literal">true</span></span><br><span class="line">	&#125;</span><br><span class="line">	buffer.WriteString(<span class="string">"]"</span>)</span><br><span class="line"></span><br><span class="line">	fmt.Printf(<span class="string">"- getMarblesByRange queryResult:\n%s\n"</span>, buffer.String())</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> shim.Success(buffer.Bytes())</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// =======Rich queries =========================================================================</span></span><br><span class="line"><span class="comment">// Two examples of rich queries are provided below (parameterized query and ad hoc query).</span></span><br><span class="line"><span class="comment">// Rich queries pass a query string to the state database.</span></span><br><span class="line"><span class="comment">// Rich queries are only supported by state database implementations</span></span><br><span class="line"><span class="comment">//  that support rich query (e.g. CouchDB).</span></span><br><span class="line"><span class="comment">// The query string is in the syntax of the underlying state database.</span></span><br><span class="line"><span class="comment">// With rich queries there is no guarantee that the result set hasn't changed between</span></span><br><span class="line"><span class="comment">//  endorsement time and commit time, aka 'phantom reads'.</span></span><br><span class="line"><span class="comment">// Therefore, rich queries should not be used in update transactions, unless the</span></span><br><span class="line"><span class="comment">// application handles the possibility of result set changes between endorsement and commit time.</span></span><br><span class="line"><span class="comment">// Rich queries can be used for point-in-time queries against a peer.</span></span><br><span class="line"><span class="comment">// ============================================================================================</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// ===== Example: Parameterized rich query =================================================</span></span><br><span class="line"><span class="comment">// queryMarblesByOwner queries for marbles based on a passed in owner.</span></span><br><span class="line"><span class="comment">// This is an example of a parameterized query where the query logic is baked into the chaincode,</span></span><br><span class="line"><span class="comment">// and accepting a single query parameter (owner).</span></span><br><span class="line"><span class="comment">// Only available on state databases that support rich query (e.g. CouchDB)</span></span><br><span class="line"><span class="comment">// =========================================================================================</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(t *SimpleChaincode)</span> <span class="title">queryMarblesByOwner</span><span class="params">(stub shim.ChaincodeStubInterface, args []<span class="keyword">string</span>)</span> <span class="title">pb</span>.<span class="title">Response</span></span> &#123;</span><br><span class="line"></span><br><span class="line">	<span class="comment">//   0</span></span><br><span class="line">	<span class="comment">// "bob"</span></span><br><span class="line">	<span class="keyword">if</span> <span class="built_in">len</span>(args) &lt; <span class="number">1</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> shim.Error(<span class="string">"Incorrect number of arguments. Expecting 1"</span>)</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	owner := strings.ToLower(args[<span class="number">0</span>])</span><br><span class="line"></span><br><span class="line">	queryString := fmt.Sprintf(<span class="string">"&#123;\"selector\":&#123;\"docType\":\"marble\",\"owner\":\"%s\"&#125;&#125;"</span>, owner)</span><br><span class="line"></span><br><span class="line">	queryResults, err := getQueryResultForQueryString(stub, queryString)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> shim.Error(err.Error())</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> shim.Success(queryResults)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ===== Example: Ad hoc rich query ========================================================</span></span><br><span class="line"><span class="comment">// queryMarbles uses a query string to perform a query for marbles.</span></span><br><span class="line"><span class="comment">// Query string matching state database syntax is passed in and executed as is.</span></span><br><span class="line"><span class="comment">// Supports ad hoc queries that can be defined at runtime by the client.</span></span><br><span class="line"><span class="comment">// If this is not desired, follow the queryMarblesForOwner example for parameterized queries.</span></span><br><span class="line"><span class="comment">// Only available on state databases that support rich query (e.g. CouchDB)</span></span><br><span class="line"><span class="comment">// =========================================================================================</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(t *SimpleChaincode)</span> <span class="title">queryMarbles</span><span class="params">(stub shim.ChaincodeStubInterface, args []<span class="keyword">string</span>)</span> <span class="title">pb</span>.<span class="title">Response</span></span> &#123;</span><br><span class="line"></span><br><span class="line">	<span class="comment">//   0</span></span><br><span class="line">	<span class="comment">// "queryString"</span></span><br><span class="line">	<span class="keyword">if</span> <span class="built_in">len</span>(args) &lt; <span class="number">1</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> shim.Error(<span class="string">"Incorrect number of arguments. Expecting 1"</span>)</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	queryString := args[<span class="number">0</span>]</span><br><span class="line"></span><br><span class="line">	queryResults, err := getQueryResultForQueryString(stub, queryString)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> shim.Error(err.Error())</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> shim.Success(queryResults)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// =========================================================================================</span></span><br><span class="line"><span class="comment">// getQueryResultForQueryString executes the passed in query string.</span></span><br><span class="line"><span class="comment">// Result set is built and returned as a byte array containing the JSON results.</span></span><br><span class="line"><span class="comment">// =========================================================================================</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">getQueryResultForQueryString</span><span class="params">(stub shim.ChaincodeStubInterface, queryString <span class="keyword">string</span>)</span> <span class="params">([]<span class="keyword">byte</span>, error)</span></span> &#123;</span><br><span class="line"></span><br><span class="line">	fmt.Printf(<span class="string">"- getQueryResultForQueryString queryString:\n%s\n"</span>, queryString)</span><br><span class="line"></span><br><span class="line">	resultsIterator, err := stub.GetPrivateDataQueryResult(<span class="string">"collectionMarbles"</span>, queryString)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">nil</span>, err</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">defer</span> resultsIterator.Close()</span><br><span class="line"></span><br><span class="line">	<span class="comment">// buffer is a JSON array containing QueryRecords</span></span><br><span class="line">	<span class="keyword">var</span> buffer bytes.Buffer</span><br><span class="line">	buffer.WriteString(<span class="string">"["</span>)</span><br><span class="line"></span><br><span class="line">	bArrayMemberAlreadyWritten := <span class="literal">false</span></span><br><span class="line">	<span class="keyword">for</span> resultsIterator.HasNext() &#123;</span><br><span class="line">		queryResponse, err := resultsIterator.Next()</span><br><span class="line">		<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">			<span class="keyword">return</span> <span class="literal">nil</span>, err</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="comment">// Add a comma before array members, suppress it for the first array member</span></span><br><span class="line">		<span class="keyword">if</span> bArrayMemberAlreadyWritten == <span class="literal">true</span> &#123;</span><br><span class="line">			buffer.WriteString(<span class="string">","</span>)</span><br><span class="line">		&#125;</span><br><span class="line">		buffer.WriteString(<span class="string">"&#123;\"Key\":"</span>)</span><br><span class="line">		buffer.WriteString(<span class="string">"\""</span>)</span><br><span class="line">		buffer.WriteString(queryResponse.Key)</span><br><span class="line">		buffer.WriteString(<span class="string">"\""</span>)</span><br><span class="line"></span><br><span class="line">		buffer.WriteString(<span class="string">", \"Record\":"</span>)</span><br><span class="line">		<span class="comment">// Record is a JSON object, so we write as-is</span></span><br><span class="line">		buffer.WriteString(<span class="keyword">string</span>(queryResponse.Value))</span><br><span class="line">		buffer.WriteString(<span class="string">"&#125;"</span>)</span><br><span class="line">		bArrayMemberAlreadyWritten = <span class="literal">true</span></span><br><span class="line">	&#125;</span><br><span class="line">	buffer.WriteString(<span class="string">"]"</span>)</span><br><span class="line"></span><br><span class="line">	fmt.Printf(<span class="string">"- getQueryResultForQueryString queryResult:\n%s\n"</span>, buffer.String())</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> buffer.Bytes(), <span class="literal">nil</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="sacc-简单资产管理链码示例"><a href="#sacc-简单资产管理链码示例" class="headerlink" title="sacc(简单资产管理链码示例)"></a>sacc(简单资产管理链码示例)</h5><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br></pre></td><td class="code"><pre><span class="line"># SimpleAssetChainCode 简单资产管理链码示例</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * Copyright IBM Corp All Rights Reserved</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * SPDX-License-Identifier: Apache-2.0</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">	<span class="string">"fmt"</span></span><br><span class="line"></span><br><span class="line">	<span class="string">"github.com/hyperledger/fabric/core/chaincode/shim"</span></span><br><span class="line">	<span class="string">"github.com/hyperledger/fabric/protos/peer"</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="comment">// SimpleAsset implements a simple chaincode to manage an asset</span></span><br><span class="line"><span class="keyword">type</span> SimpleAsset <span class="keyword">struct</span> &#123;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Init is called during chaincode instantiation to initialize any</span></span><br><span class="line"><span class="comment">// data. Note that chaincode upgrade also calls this function to reset</span></span><br><span class="line"><span class="comment">// or to migrate data.</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(t *SimpleAsset)</span> <span class="title">Init</span><span class="params">(stub shim.ChaincodeStubInterface)</span> <span class="title">peer</span>.<span class="title">Response</span></span> &#123;</span><br><span class="line">	<span class="comment">// Get the args from the transaction proposal</span></span><br><span class="line">	args := stub.GetStringArgs()</span><br><span class="line">	<span class="keyword">if</span> <span class="built_in">len</span>(args) != <span class="number">2</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> shim.Error(<span class="string">"Incorrect arguments. Expecting a key and a value"</span>)</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// Set up any variables or assets here by calling stub.PutState()</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">// We store the key and the value on the ledger</span></span><br><span class="line">	err := stub.PutState(args[<span class="number">0</span>], []<span class="keyword">byte</span>(args[<span class="number">1</span>]))</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> shim.Error(fmt.Sprintf(<span class="string">"Failed to create asset: %s"</span>, args[<span class="number">0</span>]))</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> shim.Success(<span class="literal">nil</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Invoke is called per transaction on the chaincode. Each transaction is</span></span><br><span class="line"><span class="comment">// either a 'get' or a 'set' on the asset created by Init function. The Set</span></span><br><span class="line"><span class="comment">// method may create a new asset by specifying a new key-value pair.</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(t *SimpleAsset)</span> <span class="title">Invoke</span><span class="params">(stub shim.ChaincodeStubInterface)</span> <span class="title">peer</span>.<span class="title">Response</span></span> &#123;</span><br><span class="line">	<span class="comment">// Extract the function and args from the transaction proposal</span></span><br><span class="line">	fn, args := stub.GetFunctionAndParameters()</span><br><span class="line"></span><br><span class="line">	<span class="keyword">var</span> result <span class="keyword">string</span></span><br><span class="line">	<span class="keyword">var</span> err error</span><br><span class="line">	<span class="keyword">if</span> fn == <span class="string">"set"</span> &#123;</span><br><span class="line">		result, err = set(stub, args)</span><br><span class="line">	&#125; <span class="keyword">else</span> &#123; <span class="comment">// assume 'get' even if fn is nil</span></span><br><span class="line">		result, err = get(stub, args)</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> shim.Error(err.Error())</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// Return the result as success payload</span></span><br><span class="line">	<span class="keyword">return</span> shim.Success([]<span class="keyword">byte</span>(result))</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Set stores the asset (both key and value) on the ledger. If the key exists,</span></span><br><span class="line"><span class="comment">// it will override the value with the new one</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">set</span><span class="params">(stub shim.ChaincodeStubInterface, args []<span class="keyword">string</span>)</span> <span class="params">(<span class="keyword">string</span>, error)</span></span> &#123;</span><br><span class="line">	<span class="keyword">if</span> <span class="built_in">len</span>(args) != <span class="number">2</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="string">""</span>, fmt.Errorf(<span class="string">"Incorrect arguments. Expecting a key and a value"</span>)</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	err := stub.PutState(args[<span class="number">0</span>], []<span class="keyword">byte</span>(args[<span class="number">1</span>]))</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="string">""</span>, fmt.Errorf(<span class="string">"Failed to set asset: %s"</span>, args[<span class="number">0</span>])</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> args[<span class="number">1</span>], <span class="literal">nil</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Get returns the value of the specified asset key</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">get</span><span class="params">(stub shim.ChaincodeStubInterface, args []<span class="keyword">string</span>)</span> <span class="params">(<span class="keyword">string</span>, error)</span></span> &#123;</span><br><span class="line">	<span class="keyword">if</span> <span class="built_in">len</span>(args) != <span class="number">1</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="string">""</span>, fmt.Errorf(<span class="string">"Incorrect arguments. Expecting a key"</span>)</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	value, err := stub.GetState(args[<span class="number">0</span>])</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="string">""</span>, fmt.Errorf(<span class="string">"Failed to get asset: %s with error: %s"</span>, args[<span class="number">0</span>], err)</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">if</span> value == <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="string">""</span>, fmt.Errorf(<span class="string">"Asset not found: %s"</span>, args[<span class="number">0</span>])</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> <span class="keyword">string</span>(value), <span class="literal">nil</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// main function starts up the chaincode in the container during instantiate</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">	<span class="keyword">if</span> err := shim.Start(<span class="built_in">new</span>(SimpleAsset)); err != <span class="literal">nil</span> &#123;</span><br><span class="line">		fmt.Printf(<span class="string">"Error starting SimpleAsset chaincode: %s"</span>, err)</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="chaincode-docker-devmode-开发者模式调试chaincode"><a href="#chaincode-docker-devmode-开发者模式调试chaincode" class="headerlink" title="chaincode-docker-devmode(开发者模式调试chaincode)"></a>chaincode-docker-devmode(开发者模式调试chaincode)</h4><blockquote>
<p>请参考</p>
<p><a href="https://cupswen.github.io/2019/10/31/chaincode-docker-devmode/">https://cupswen.github.io/2019/10/31/chaincode-docker-devmode/</a></p>
</blockquote>
<h4 id="fabcar-车示例"><a href="#fabcar-车示例" class="headerlink" title="fabcar(车示例)"></a>fabcar(车示例)</h4><blockquote>
<p>JS代码暂时看不懂</p>
</blockquote>
<h4 id="first-network-复杂网络搭建"><a href="#first-network-复杂网络搭建" class="headerlink" title="first-network(复杂网络搭建)"></a>first-network(复杂网络搭建)</h4><blockquote>
<p>请参考</p>
<p><a href="https://www.cnblogs.com/llongst/p/9519446.html" target="_blank" rel="noopener">https://www.cnblogs.com/llongst/p/9519446.html</a></p>
</blockquote>
<h4 id="high-throughput-高通量网络下的chaincode设计"><a href="#high-throughput-高通量网络下的chaincode设计" class="headerlink" title="high-throughput(高通量网络下的chaincode设计)"></a>high-throughput(高通量网络下的chaincode设计)</h4><blockquote>
<p>请参考</p>
<p><a href="https://cupswen.github.io/2019/10/29/high-throughput/">https://cupswen.github.io/2019/10/29/high-throughput/</a></p>
</blockquote>
<h4 id="interest-rate-swaps-利率互换示例"><a href="#interest-rate-swaps-利率互换示例" class="headerlink" title="interest_rate_swaps(利率互换示例)"></a>interest_rate_swaps(利率互换示例)</h4><blockquote>
<p>请参考</p>
<p><a href="https://cupswen.github.io/2019/11/01/interest_rate_swaps/">https://cupswen.github.io/2019/11/01/interest_rate_swaps/</a></p>
</blockquote>
<h4 id="off-chain-data-离线数据处理"><a href="#off-chain-data-离线数据处理" class="headerlink" title="off_chain_data(离线数据处理)"></a>off_chain_data(离线数据处理)</h4><blockquote>
<p>off_chain_data</p>
</blockquote>
<h4 id="scripts-批处理脚本"><a href="#scripts-批处理脚本" class="headerlink" title="scripts(批处理脚本)"></a>scripts(批处理脚本)</h4><blockquote>
<p>scripts</p>
</blockquote>

        </div>

        <blockquote class="post-copyright">
    
    <div class="content">
        
<span class="post-time">
    Last updated: <time datetime="2019-11-07T10:59:02.000Z" itemprop="dateUpdated">2019-11-07 18:59:02</time>
</span><br>


        
    </div>
    
    <footer>
        <a href="http://cupswen.github.io">
            <img src="/img/the_Huanghe_River.png" alt="CupsWen">
            CupsWen
        </a>
    </footer>
</blockquote>

        


        <div class="post-footer">
            
	<ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Fabric/" rel="tag">Fabric</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/fabric-samples/" rel="tag">fabric-samples</a></li></ul>


            
<div class="page-share-wrap">
    

<div class="page-share" id="pageShare">
    <ul class="reset share-icons">
      <li>
        <a class="weibo share-sns" target="_blank" href="http://service.weibo.com/share/share.php?url=http://cupswen.github.io/2019/10/29/2019/fabric-samples/&title=《窥探fabric-samples详细内容》 — Cups&pic=http://cupswen.github.io/img/the_Huanghe_River.png" data-title="微博">
          <i class="icon icon-weibo"></i>
        </a>
      </li>
      <li>
        <a class="weixin share-sns wxFab" href="javascript:;" data-title="微信">
          <i class="icon icon-weixin"></i>
        </a>
      </li>
      <li>
        <a class="qq share-sns" target="_blank" href="http://connect.qq.com/widget/shareqq/index.html?url=http://cupswen.github.io/2019/10/29/2019/fabric-samples/&title=《窥探fabric-samples详细内容》 — Cups&source=" data-title=" QQ">
          <i class="icon icon-qq"></i>
        </a>
      </li>
      <li>
        <a class="facebook share-sns" target="_blank" href="https://www.facebook.com/sharer/sharer.php?u=http://cupswen.github.io/2019/10/29/2019/fabric-samples/" data-title=" Facebook">
          <i class="icon icon-facebook"></i>
        </a>
      </li>
      <li>
        <a class="twitter share-sns" target="_blank" href="https://twitter.com/intent/tweet?text=《窥探fabric-samples详细内容》 — Cups&url=http://cupswen.github.io/2019/10/29/2019/fabric-samples/&via=http://cupswen.github.io" data-title=" Twitter">
          <i class="icon icon-twitter"></i>
        </a>
      </li>
      <li>
        <a class="google share-sns" target="_blank" href="https://plus.google.com/share?url=http://cupswen.github.io/2019/10/29/2019/fabric-samples/" data-title=" Google+">
          <i class="icon icon-google-plus"></i>
        </a>
      </li>
    </ul>
 </div>



    <a href="javascript:;" id="shareFab" class="page-share-fab waves-effect waves-circle">
        <i class="icon icon-share-alt icon-lg"></i>
    </a>
</div>



        </div>
    </div>

    
<nav class="post-nav flex-row flex-justify-between">
  
    <div class="waves-block waves-effect prev">
      <a href="/2019/10/29/2019/high-throughput/" id="post-prev" class="post-nav-link">
        <div class="tips"><i class="icon icon-angle-left icon-lg icon-pr"></i> Prev</div>
        <h4 class="title">fabric-samples之High-Throughput Network(高通量网络)</h4>
      </a>
    </div>
  

  
    <div class="waves-block waves-effect next">
      <a href="/2019/10/21/2019/blog/" id="post-next" class="post-nav-link">
        <div class="tips">Next <i class="icon icon-angle-right icon-lg icon-pl"></i></div>
        <h4 class="title">github+jekyll快速搭建个人博客</h4>
      </a>
    </div>
  
</nav>



    

</article>



</div>

        <footer class="footer">
    <div class="top">
        
<p>
    <span id="busuanzi_container_site_uv" style='display:none'>
        站点总访客数：<span id="busuanzi_value_site_uv"></span>
    </span>
    <span id="busuanzi_container_site_pv" style='display:none'>
        站点总访问量：<span id="busuanzi_value_site_pv"></span>
    </span>
</p>


        <p>
            
            <span>This blog is licensed under a <a rel="license noopener" href="https://creativecommons.org/licenses/by/4.0/" target="_blank">Creative Commons Attribution 4.0 International License</a>.</span>
        </p>
    </div>
    <div class="bottom">
        <p><span>CupsWen &copy; 2019 - 2020</span>
            <span>
                
                Power by <a href="http://hexo.io/" target="_blank">Hexo</a> Theme indigo.</a>
            </span>
        </p>
    </div>
</footer>

    </main>
    <div class="mask" id="mask"></div>
<a href="javascript:;" id="gotop" class="waves-effect waves-circle waves-light"><span class="icon icon-lg icon-chevron-up"></span></a>



<div class="global-share" id="globalShare">
    <ul class="reset share-icons">
      <li>
        <a class="weibo share-sns" target="_blank" href="http://service.weibo.com/share/share.php?url=http://cupswen.github.io/2019/10/29/2019/fabric-samples/&title=《窥探fabric-samples详细内容》 — Cups&pic=http://cupswen.github.io/img/the_Huanghe_River.png" data-title="微博">
          <i class="icon icon-weibo"></i>
        </a>
      </li>
      <li>
        <a class="weixin share-sns wxFab" href="javascript:;" data-title="微信">
          <i class="icon icon-weixin"></i>
        </a>
      </li>
      <li>
        <a class="qq share-sns" target="_blank" href="http://connect.qq.com/widget/shareqq/index.html?url=http://cupswen.github.io/2019/10/29/2019/fabric-samples/&title=《窥探fabric-samples详细内容》 — Cups&source=" data-title=" QQ">
          <i class="icon icon-qq"></i>
        </a>
      </li>
      <li>
        <a class="facebook share-sns" target="_blank" href="https://www.facebook.com/sharer/sharer.php?u=http://cupswen.github.io/2019/10/29/2019/fabric-samples/" data-title=" Facebook">
          <i class="icon icon-facebook"></i>
        </a>
      </li>
      <li>
        <a class="twitter share-sns" target="_blank" href="https://twitter.com/intent/tweet?text=《窥探fabric-samples详细内容》 — Cups&url=http://cupswen.github.io/2019/10/29/2019/fabric-samples/&via=http://cupswen.github.io" data-title=" Twitter">
          <i class="icon icon-twitter"></i>
        </a>
      </li>
      <li>
        <a class="google share-sns" target="_blank" href="https://plus.google.com/share?url=http://cupswen.github.io/2019/10/29/2019/fabric-samples/" data-title=" Google+">
          <i class="icon icon-google-plus"></i>
        </a>
      </li>
    </ul>
 </div>


<div class="page-modal wx-share" id="wxShare">
    <a class="close" href="javascript:;"><i class="icon icon-close"></i></a>
    <p>扫一扫，分享到微信</p>
    <img src="//api.qrserver.com/v1/create-qr-code/?data=http://cupswen.github.io/2019/10/29/2019/fabric-samples/" alt="微信分享二维码">
</div>




    <script src="//cdn.bootcss.com/node-waves/0.7.4/waves.min.js"></script>
<script>
var BLOG = { ROOT: '/', SHARE: true, REWARD: false };


</script>

<script src="//unpkg.com/hexo-theme-material-indigo@latest/js/main.min.js"></script>


<div class="search-panel" id="search-panel">
    <ul class="search-result" id="search-result"></ul>
</div>
<template id="search-tpl">
<li class="item">
    <a href="{path}" class="waves-block waves-effect">
        <div class="title ellipsis" title="{title}">{title}</div>
        <div class="flex-row flex-middle">
            <div class="tags ellipsis">
                {tags}
            </div>
            <time class="flex-col time">{date}</time>
        </div>
    </a>
</li>
</template>

<script src="//unpkg.com/hexo-theme-material-indigo@latest/js/search.min.js" async></script>






<script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>



<script>
(function() {
    var OriginTitile = document.title, titleTime;
    document.addEventListener('visibilitychange', function() {
        if (document.hidden) {
            document.title = 'Cups';
            clearTimeout(titleTime);
        } else {
            document.title = 'Cups';
            titleTime = setTimeout(function() {
                document.title = OriginTitile;
            },2000);
        }
    });
})();
</script>



</body>
</html>
